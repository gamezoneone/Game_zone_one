<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mahjong Slot</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
 const supabase = window.supabase.createClient(
      'https://vqmfachxnjyxwuavpgds.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4njyxwuavpgdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
    );
 const uid = localStorage.getItem('uid');
  </script>
    <style>
    /* Global styles */
    :root {
      --neon-cyan: #00ffff;
      --neon-pink: #ff00ff;
      --neon-green: #00ff00;
      --neon-yellow: #ffff00;
      --dark-bg: #0d0d0d;
      --darker-bg: #1a1a1a;
      --darkest-bg: #0a0a0a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--dark-bg);
      margin: 0;
      font-family: 'Poppins', sans-serif; /* Menggunakan Poppins seperti di link */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      color: var(--neon-cyan);
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Neon glow effect for elements */
    .neon-glow {
      text-shadow: 0 0 5px var(--neon-cyan), 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan), 0 0 40px #00e6e6, 0 0 80px #00e6e6;
    }

    /* Marquee text */
    marquee {
      color: var(--neon-pink);
      font-family: 'Share Tech Mono', monospace; /* Tetap pakai Share Tech Mono jika ada */
      font-size: 0.9em;
      padding: 5px 0;
      width: 100%;
      text-align: center;
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid var(--neon-pink);
      border-top: 1px solid var(--neon-pink);
      box-shadow: 0 0 5px var(--neon-pink);
      margin-bottom: 20px;
    }

    /* Main title */
    h1 {
      background: linear-gradient(45deg, var(--neon-cyan), var(--neon-pink), var(--neon-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2em;
      margin-bottom: 20px;
      text-align: center;
      padding: 5px 20px;
      border: 2px solid var(--neon-cyan);
      border-radius: 15px;
      box-shadow: 0 0 15px var(--neon-cyan), 0 0 30px var(--neon-pink);
      animation: neonPulse 1.5s infinite alternate;
      letter-spacing: 2px;
    }

    @keyframes neonPulse {
      0% {
        box-shadow: 0 0 15px var(--neon-cyan), 0 0 30px var(--neon-pink);
        transform: scale(1);
      }
      100% {
        box-shadow: 0 0 25px var(--neon-cyan), 0 0 50px var(--neon-pink);
        transform: scale(1.02);
      }
    }

    hr {
      border-color: var(--neon-green);
      box-shadow: 0 0 8px var(--neon-green);
      margin-top: 10px;
    }

    /* Slot frame */
    .slot-frame {
      padding: 10px;
      border-radius: 15px;
      background: rgba(0, 0, 0, 0.6);
      border: 3px solid var(--neon-green);
      box-shadow: 0 0 20px var(--neon-green), inset 0 0 10px rgba(0, 255, 0, 0.5);
      margin-bottom: 20px;
    }

    /* Slot grid */
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(5, 75px);
      grid-template-rows: repeat(5, 90px);
      gap: 5px;
      justify-content: center;
      border: 5px solid var(--neon-pink);
      border-radius: 10px;
      box-shadow: 0 0 15px var(--neon-pink);
      background: var(--darker-bg);
    }

    /* Individual tiles */
    .tile {
      background: #333;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 38px;
      font-weight: bold;
      color: #fff;
      box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.3), 0 0 5px rgba(0, 255, 255, 0.5);
      transition: transform 0.1s linear, box-shadow 0.2s ease-in-out;
      overflow: hidden;
      border: 2px solid var(--neon-cyan);
      position: relative;
    }

    .tile:hover {
      transform: scale(1.05);
      box-shadow: inset 0 0 15px rgba(0, 255, 255, 0.5), 0 0 15px var(--neon-cyan), 0 0 30px var(--neon-cyan);
    }

    /* Tile breaking animation */
    .tile.break {
      animation: breakAnim 0.8s forwards;
      background: #ff0000;
      box-shadow: 0 0 20px #ff0000, inset 0 0 10px #ff0000;
    }
    @keyframes breakAnim {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(0.5); opacity: 0.5; }
      100% { transform: scale(0); opacity: 0; }
    }

    /* Popup messages */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--darker-bg);
      color: var(--neon-green);
      border: 2px solid var(--neon-green);
      box-shadow: 0 0 15px var(--neon-green);
      padding: 15px 25px;
      border-radius: 10px;
      font-size: 1.2em;
      font-family: 'Share Tech Mono', monospace; /* Tetap pakai Share Tech Mono jika ada */
      text-align: center;
      z-index: 1000;
      display: none;
    }

    /* Controls container - now just for saldo and bet display */
    .controls-container {
      width: 100%;
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 20px;
      padding-bottom: 120px;
      position: relative;
    }

    /* Balance, Bet, Free Spin Displays - part of the flow */
    .balance, .bet-display, .free-spin-display {
      background: var(--darkest-bg);
      padding: 8px 12px;
      border-radius: 100px;
      font-size: 0.9em;
      font-weight: bold;
      box-shadow: 0 0 10px;
      z-index: 10;
      margin: 5px;
    }

    .balance {
      color: var(--neon-cyan);
      border: 2px solid var(--neon-cyan);
      box-shadow: 0 0 10px var(--neon-cyan);
    }

    .bet-display {
      color: var(--neon-pink);
      border: 2px solid var(--neon-pink);
      box-shadow: 0 0 10px var(--neon-pink);
      font-size: 1.2em;
    }

    .free-spin-display {
      color: var(--neon-yellow);
      border: 2px solid var(--neon-yellow);
      box-shadow: 0 0 10px var(--neon-yellow);
      font-size: 1.2em;
      display: none;
    }

    /* Spin button */
    .spin-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--darkest-bg);
      border: 4px solid var(--neon-cyan);
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 40px;
      font-weight: bold;
      color: var(--neon-cyan);
      box-shadow: 0 0 20px var(--neon-cyan), inset 0 0 10px var(--neon-cyan);
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      z-index: 20;
    }
    .spin-button:hover {
      background: var(--neon-cyan);
      color: var(--darkest-bg);
      box-shadow: 0 0 30px var(--neon-cyan), inset 0 0 15px var(--neon-cyan);
      transform: translateX(-50%) scale(1.05);
    }
    .spin-button:active {
      transform: translateX(-50%) scale(0.95);
      box-shadow: 0 0 10px var(--neon-cyan), inset 0 0 5px var(--neon-cyan);
    }
    .spin-button:disabled {
      background: #333;
      border-color: #555;
      color: #888;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* Bet control buttons */
    .bet-controls button, .bet-controls1 button {
      position: fixed;
      bottom: 40px;
      padding: 15px;
      background: var(--darkest-bg);
      color: var(--neon-pink);
      border: 2px solid var(--neon-pink);
      border-radius: 50%;
      font-size: 1.5em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px var(--neon-pink);
      transition: all 0.2s ease-in-out;
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 15;
    }

    .bet-controls button {
      left: 20px;
    }

    .bet-controls1 button {
      right: 20px;
    }

    .bet-controls button:hover, .bet-controls1 button:hover {
      background: var(--neon-pink);
      color: var(--darkest-bg);
      box-shadow: 0 0 20px var(--neon-pink);
      transform: scale(1.1);
    }
    .bet-controls button:active, .bet-controls1 button:active {
      transform: scale(0.9);
      box-shadow: 0 0 5px var(--neon-pink);
    }

    /* Wild and Scatter symbol styling */
    .tile.wild-symbol, .tile.scatter-symbol {
      background: #000;
      border: 3px solid;
      animation: neonPulseSmall 1s infinite alternate;
    }

    .tile.wild-symbol {
      border-color: var(--neon-yellow);
      box-shadow: inset 0 0 10px rgba(255, 255, 0, 0.5), 0 0 15px var(--neon-yellow), 0 0 30px var(--neon-yellow);
    }

    .tile.scatter-symbol {
      border-color: var(--neon-pink);
      box-shadow: inset 0 0 10px rgba(255, 0, 255, 0.5), 0 0 15px var(--neon-pink), 0 0 30px var(--neon-pink);
    }

    @keyframes neonPulseSmall {
      0% { opacity: 0.8; }
      100% { opacity: 1; }
    }

    /* Images within tiles */
    .tile img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      display: block;
      filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
    }

    /* Free Spin Win Animation Overlay */
    #freeSpinWinOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.8);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease, visibility 0.5s ease;
        z-index: 1001;
    }

    #freeSpinWinOverlay.show {
        opacity: 1;
        visibility: visible;
    }

    .win-animation-content {
        background: linear-gradient(45deg, var(--neon-cyan), var(--neon-green), var(--neon-pink));
        padding: 30px 50px;
        border-radius: 20px;
        box-shadow: 0 0 40px var(--neon-cyan), 0 0 60px var(--neon-pink);
        text-align: center;
        transform: scale(0.8);
        opacity: 0;
        animation: winPopIn 0.8s forwards ease-out;
        border: 3px solid var(--neon-yellow);
    }

    @keyframes winPopIn {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .win-animation-content h2 {
        font-size: 2.5em;
        color: var(--darkest-bg);
        margin-bottom: 15px;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.8);
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .win-animation-content p {
        font-size: 2em;
        color: var(--darkest-bg);
        font-weight: bold;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        letter-spacing: 1px;
    }

    #freeSpinTotalWin {
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
    }

    /* Multiplier yang muncul di tengah dengan animasi */
    #animatedMultiplier {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0); /* Awalnya kecil dan di tengah */
      opacity: 0; /* Awalnya tidak terlihat */
      background: var(--darkest-bg);
      border: 4px solid var(--neon-green);
      border-radius: 15px;
      padding: 20px 30px;
      font-size: 3.5em;
      font-weight: bold;
      color: var(--neon-green);
      box-shadow: 0 0 30px var(--neon-green), 0 0 50px rgba(0, 255, 0, 0.7);
      z-index: 1002;
      text-align: center;
      white-space: nowrap;
      display: none; /* Sembunyikan secara default, akan ditampilkan dengan JS */
    }
        /* Keyframes untuk animasi pop-in multiplier */
    @keyframes multiplierPopIn {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2); /* Sedikit membesar melewati batas */
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1); /* Kembali ke ukuran normal */
        opacity: 1;
      }
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      h1 {
        font-size: 1.5em;
        padding: 5px 15px;
      }

      .slot-grid {
        grid-template-columns: repeat(5, 60px);
        grid-template-rows: repeat(5, 75px);
      }

      .tile {
        font-size: 30px;
      }

      .spin-button {
        width: 70px;
        height: 70px;
        font-size: 35px;
      }

      .bet-controls button, .bet-controls1 button {
        width: 50px;
        height: 50px;
        font-size: 1.2em;
        bottom: 30px;
      }

      .bet-controls button {
        left: 10px;
      }

      .bet-controls1 button {
        right: 10px;
      }

      .balance, .bet-display, .free-spin-display {
        font-size: 0.8em;
        padding: 5px 10px;
      }

      .win-animation-content h2 {
        font-size: 1.8em;
      }

      .win-animation-content p {
        font-size: 1.5em;
      }

      #animatedMultiplier {
        font-size: 2.5em;
        padding: 15px 25px;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.2em;
        padding: 5px 10px;
      }

      .slot-grid {
        grid-template-columns: repeat(5, 50px);
        grid-template-rows: repeat(5, 60px);
        gap: 3px;
      }

      .tile {
        font-size: 25px;
        border-radius: 5px;
      }

      .spin-button {
        width: 60px;
        height: 60px;
        font-size: 30px;
        bottom: 15px;
      }

      .bet-controls button, .bet-controls1 button {
        width: 40px;
        height: 40px;
        font-size: 1em;
        bottom: 20px;
      }

      #animatedMultiplier {
        font-size: 2em;
        padding: 10px 20px;
      }
    }
  </style>
</head>
<body>
  <audio id="rollSound" src=""></audio>
  <audio id="winSmallSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-money-bag-drop-1989.mp3"></audio>
  <audio id="winBigSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-final-level-bonus-2061.mp3"></audio>
  <audio id="breakSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-mechanical-crate-pick-up-3154%20(1).mp3"></audio>
  <audio id="spinSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-game-ball-tap-2073.mp3"></audio>
  <audio id="bgm" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//dj-background-music-background-music-free-music-music-free-for-use-221916%20(1).mp3" loop></audio>
  <audio id="freeSpinSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-game-level-completed-2059.mp3"></audio>
  <audio id="freeSpinBGM" src="https://www.bensound.com/bensound-music/bensound-epic.mp3" loop></audio>

  <div id="popup" class="popup"></div>

  <marquee>â€¢NIKMATI KESERUAN BERMAIN DENGAN KEMENANGAN YANG TIDAK PERNAH TERBAYANGKANâ€¢LAKUKAN STRATEGI AGAR DAPAT MEMENANGKAN PERMAINAN DAN DAPATKAN UANG SECARA MUDAHâ€¢</marquee>

  <h1>MAHJONG NEON BLAST<hr></h1>
  <div class="slot-frame">
    <div class="slot-grid" id="grid"></div>
  </div>

  <div class="controls-container">
    <div class="balance neon-glow" id="balanceDisplay">Saldo: Rp0</div>
    <div class="bet-display neon-glow" id="betDisplay">100</div>
    <div class="free-spin-display neon-glow" id="freeSpinDisplay">Free Spins: 0</div>
  </div>

  <div class="bet-controls">
    <button id="betPlus">+</button>
  </div>
  <div class="bet-controls1">
    <button id="betMinus">-</button>
  </div>
  <button class="spin-button neon-glow" id="spinButton">âš¡</button>

  <div id="freeSpinWinOverlay" class="win-animation-overlay">
    <div class="win-animation-content">
      <h2>FREE SPIN SELESAI!</h2>
      <p>TOTAL KEMENANGAN: <span id="freeSpinTotalWin">Rp0</span></p>
    </div>
  </div>

  <div id="animatedMultiplier" class="animated-multiplier neon-glow">
    <span id="animatedMultiplierValue">x1</span>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const spinButton = document.getElementById('spinButton');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const betDisplay = document.getElementById('betDisplay');
    // const multiplierDisplay = document.getElementById('multiplierDisplay'); // Ini tidak lagi diperlukan karena kita pakai animatedMultiplier
    const rollSound = document.getElementById('rollSound');
    const winSmallSound = document.getElementById('winSmallSound');
    const winBigSound = document.getElementById('winBigSound');
    const betMinusBtn = document.getElementById('betMinus');
    const betPlusBtn = document.getElementById('betPlus');
    const freeSpinDisplay = document.getElementById('freeSpinDisplay');
    const freeSpinWinOverlay = document.getElementById('freeSpinWinOverlay');
    const freeSpinTotalWinDisplay = document.getElementById('freeSpinTotalWin');
    const animatedMultiplier = document.getElementById('animatedMultiplier'); // Dapatkan elemen multiplier animasi
    const animatedMultiplierValue = document.getElementById('animatedMultiplierValue'); // Dapatkan span nilai multiplier

    const symbolPayouts = {
      'ðŸ¦§': 15,
      'ðŸ…': 13,
      'ðŸ¦«': 12,
      'ðŸ¥': 11,
      'ðŸ¦œ': 10,
      'ðŸ“': 9,
      'ðŸ•Šï¸': 6,
      'ðŸ–': 4,
      'ðŸ¦•': 7,
      'ðŸˆ': 6,
      'ðŸ¬': 5,
    };

    const width = 5;
    const height = 5;
    const symbols = ['ðŸ¬', 'ðŸˆ', 'ðŸ¦•', 'ðŸ–', 'ðŸ•Šï¸', 'ðŸ“', 'ðŸ¦œ', 'ðŸ¥', 'ðŸ¦«', 'ðŸ…', 'ðŸ¦§', 'ðŸŒŸ', 'ðŸ‰'];
    const WILD_SYMBOL = 'ðŸŒŸ';
    const SCATTER_SYMBOL = 'ðŸ‰';

    let currentSymbols = [];
    let balance = 0;
    let bet = 100;
    const minBet = 100;
    const maxBet = 1000;
    let currentMultiplier = 0; // Ubah nama variabel untuk menghindari konflik
    let freeSpinCount = 0;
    let totalFreeSpinWin = 0;

    // AUDIO BARU DAN VARIABEL FLAG
    const bgm = document.getElementById('bgm');
    const freeSpinSound = document.getElementById('freeSpinSound');
    const freeSpinBGM = document.getElementById('freeSpinBGM');
    const breakSound = document.getElementById('breakSound');
    let isInFreeSpinMode = false;

async function loadSaldo() {
Â  if (!uid) {
Â  Â  alert("User belum login!");
Â  Â  window.location.href = "index.html"; // redirect ke login kalau belum login
Â  Â  return;
Â  }

Â  const { data, error } = await supabase
Â  Â  .from('users_data')
Â  Â  .select('saldo')
Â  Â  .eq('user_id', uid)
Â  Â  .single();

Â  if (error || !data) {
Â  Â  alert("Gagal mengambil saldo user!");
Â  Â  return;
Â  }

Â  balance = data.saldo;
Â  updateBalance(0);
}

window.onload = () => {
Â  loadSaldo();
Â  init(); // jalankan game
};


    function generateRandomSymbols() {
      const arr = [];
      for (let i = 0; i < width * height; i++) {
        let randomSymbol;
        const col = i % width;

        const rand = Math.random();

        if (col === 0) {
            if (rand < 0.01) {
                randomSymbol = SCATTER_SYMBOL;
            } else {
                randomSymbol = symbols[Math.floor(Math.random() * (symbols.length - 2))];
            }
        } else {
            if (rand < 0.04) { // Menurunkan probabilitas Wild sedikit
                randomSymbol = WILD_SYMBOL;
            } else if (rand < 0.05) { // 1% kemungkinan Scatter (0.04 sampai 0.05)
                randomSymbol = SCATTER_SYMBOL;
            } else {
                randomSymbol = symbols[Math.floor(Math.random() * (symbols.length - 2))];
            }
        }
        arr.push(randomSymbol);
      }
      return arr;
    }

    function renderGrid(symbolsArr) {
      grid.innerHTML = '';
      symbolsArr.forEach(sym => {
        const div = document.createElement('div');
        div.className = 'tile';

        if (sym === WILD_SYMBOL) {
          const img = document.createElement('img');
          img.src = 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/qris//download%20(1).png';
          img.alt = 'Wild';
          div.appendChild(img);
          div.classList.add('wild-symbol');
        } else if (sym === SCATTER_SYMBOL) {
          const img = document.createElement('img');
          img.src = 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/qris//2432cb49c2991c8dd62a77f44f51fb45.png';
          img.alt = 'Scatter';
          div.appendChild(img);
          div.classList.add('scatter-symbol');
        } else {
          div.textContent = sym;
        }
        grid.appendChild(div);
      });
    }


    function animateReelShake(col) {
      return new Promise(resolve => {
        const reelSymbols = [];
        for (let row = 0; row < height; row++) {
          reelSymbols.push(currentSymbols[row * width + col]);
        }

        const reelTiles = [];
        for (let row = 0; row < height; row++) {
          reelTiles.push(grid.children[row * width + col]);
        }

        let position = 1;
        const tileHeight = 10; // Ini mungkin lebih tepatnya kecepatan animasi, bukan tinggi tile
        const totalScrolls = 10 + col * 5; // Semakin ke kanan semakin lama spin
        let scrollCount = 0;

        const rollSoundInstance = new Audio(rollSound.src); // Buat instance baru
        rollSoundInstance.volume = 0.5;
        rollSoundInstance.play();

        function step() {
          position += 5; // Kecepatan "scroll"
          if (position >= tileHeight) {
            position -= tileHeight;
            scrollCount++;

            let newSymbol;
            const rand = Math.random();

            if (col === 0) {
                if (rand < 0.01) { // Hanya Scatter (1% probabilitas)
                    newSymbol = SCATTER_SYMBOL;
                } else {
                    newSymbol = symbols[Math.floor(Math.random() * (symbols.length - 2))]; // Simbol reguler
                }
            } else {
                if (rand < 0.04) { // 4% kemungkinan Wild
                    newSymbol = WILD_SYMBOL;
                } else if (rand < 0.05) { // 1% kemungkinan Scatter
                    newSymbol = SCATTER_SYMBOL;
                } else {
                    newSymbol = symbols[Math.floor(Math.random() * (symbols.length - 2))]; // Simbol reguler
                }
            }

            reelSymbols.unshift(newSymbol); // Tambahkan simbol baru di atas
            reelSymbols.pop(); // Hapus simbol terbawah

            // Update tampilan tile dengan simbol baru
            for (let r = 0; r < height; r++) {
              reelTiles[r].innerHTML = ''; // Kosongkan konten
              reelTiles[r].classList.remove('wild-symbol', 'scatter-symbol'); // Hapus kelas styling sebelumnya

              if (reelSymbols[r] === WILD_SYMBOL) {
                const img = document.createElement('img');
                img.src = 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/qris//download%20(1).png';
                img.alt = 'Wild';
                reelTiles[r].appendChild(img);
                reelTiles[r].classList.add('wild-symbol');
              } else if (reelSymbols[r] === SCATTER_SYMBOL) {
                const img = document.createElement('img');
                img.src = 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/qris//2432cb49c2991c8dd62a77f44f51fb45.png';
                img.alt = 'Scatter';
                reelTiles[r].appendChild(img);
                reelTiles[r].classList.add('scatter-symbol');
              } else {
                reelTiles[r].textContent = reelSymbols[r];
              }
            }
          }

          // Animasi pergerakan ke bawah
          for (let r = 0; r < height; r++) {
            reelTiles[r].style.transform = `translateY(${position}px)`;
          }


          if (scrollCount >= totalScrolls) {
            for (let r = 0; r < height; r++) {
              reelTiles[r].style.transform = 'translateY(0)'; // Pastikan kembali ke posisi awal
            }
            rollSoundInstance.pause();
            rollSoundInstance.currentTime = 0;

            // Update currentSymbols dengan simbol akhir dari reel
            for (let r = 0; r < height; r++) {
              currentSymbols[r * width + col] = reelSymbols[r];
            }
            resolve();
          } else {
            requestAnimationFrame(step);
          }
        }
        step();
      });
    }


    function getWinningTiles(symbolsArr) {
        const winningTiles = new Set();
        const scatterTiles = new Set();
        let currentRoundWin = 0;

        for (let i = 0; i < symbolsArr.length; i++) {
            if (symbolsArr[i] === SCATTER_SYMBOL) {
                scatterTiles.add(i);
            }
        }

        // Logic for "Ways to Win" - checking combinations from left to right reels
        for (const targetSymbol of symbols) {
            if (targetSymbol === WILD_SYMBOL || targetSymbol === SCATTER_SYMBOL) continue;

            let reelMatches = Array.from({ length: width }, () => []);

            // Populate reelMatches with indices of targetSymbol or WILD_SYMBOL
            for (let col = 0; col < width; col++) {
                for (let row = 0; row < height; row++) {
                    const index = row * width + col;
                    const symbolInReel = symbolsArr[index];
                    if (symbolInReel === targetSymbol || symbolInReel === WILD_SYMBOL) {
                        reelMatches[col].push(index);
                    }
                }
            }

            // Calculate combinations across reels
            let validPaths = [];
            
            // Start paths from the first reel
            if (reelMatches[0].length > 0) {
                for (const firstTileIndex of reelMatches[0]) {
                    validPaths.push([firstTileIndex]);
                }
            }

            // Extend paths to subsequent reels
            for (let col = 1; col < width; col++) {
                let newValidPaths = [];
                for (const currentPath of validPaths) {
                    const lastTileIndex = currentPath[currentPath.length - 1];
                    const lastTileCol = lastTileIndex % width;

                    // Only extend if the last tile is in the immediately preceding reel
                    if (lastTileCol === col - 1) {
                        for (const nextTileIndex of reelMatches[col]) {
                            newValidPaths.push([...currentPath, nextTileIndex]);
                        }
                    } else {
                        // If the path didn't extend to the previous reel, keep it as is
                        newValidPaths.push(currentPath);
                    }
                }
                validPaths = newValidPaths;
            }

            // Filter for winning paths (3 or more consecutive symbols)
            const winningCombinations = validPaths.filter(path => {
                // Ensure all tiles in the path are from consecutive reels
                if (path.length < 3) return false;
                for (let i = 0; i < path.length - 1; i++) {
                    if ((path[i+1] % width) !== ((path[i] % width) + 1)) {
                        return false; // Not consecutive reels
                    }
                }
                return true;
            });

            // Calculate payout and add winning tiles
            for (const path of winningCombinations) {
                const consecutiveReels = path.length; // Number of consecutive reels matched
                
                // Calculate ways for this specific path
                let waysCount = 1;
                let currentReelIndices = [];
                for (let col = 0; col < consecutiveReels; col++) {
                    currentReelIndices[col] = new Set();
                }

                // Populate currentReelIndices with the actual positions of symbols in this path
                path.forEach(idx => {
                    const col = idx % width;
                    if (col < consecutiveReels) { // Only count for the matched consecutive reels
                        currentReelIndices[col].add(idx);
                    }
                });

                // Multiply the count of matching symbols in each consecutive reel
                for (let col = 0; col < consecutiveReels; col++) {
                    waysCount *= currentReelIndices[col].size;
                }
                
                // Determine length payout factor
                let lengthPayoutFactor = 0;
                if (consecutiveReels === 3) lengthPayoutFactor = 1;
                else if (consecutiveReels === 4) lengthPayoutFactor = 3;
                else if (consecutiveReels === 5) lengthPayoutFactor = 10;

                currentRoundWin += (symbolPayouts[targetSymbol] * lengthPayoutFactor * waysCount * (bet / 100));

                path.forEach(idx => winningTiles.add(idx));
            }
        }
        return {
            winningTiles: Array.from(winningTiles),
            scatterCount: scatterTiles.size,
            scatterIndices: Array.from(scatterTiles),
            currentRoundWin: currentRoundWin // Return win from regular lines
        };
    }

    function animateWinningTiles(indices) {
        document.querySelectorAll('.tile').forEach((tile, i) => {
            if (indices.includes(i)) {
                tile.classList.add('break');
            }
        });
        // Mainkan suara pecah setiap kali ada simbol yang pecah
        breakSound.currentTime = 0;
        breakSound.play();
    }

    async function handleTileCollapse(indicesToBreak) {
        const delay = ms => new Promise(res => setTimeout(res, ms));

        if (indicesToBreak.length > 0) {
            animateWinningTiles(indicesToBreak);
            await delay(500); // Durasi animasi pecah
        }

        // Setel simbol yang pecah menjadi null
        for (let i = 0; i < currentSymbols.length; i++) {
            if (indicesToBreak.includes(i)) {
                currentSymbols[i] = null;
            }
        }

        // Jatuhkan simbol ke bawah dan isi dari atas
        for (let col = 0; col < width; col++) {
            const colSymbols = [];
            for (let row = height - 1; row >= 0; row--) {
                const idx = row * width + col;
                if (currentSymbols[idx] !== null) {
                    colSymbols.unshift(currentSymbols[idx]); // Tambahkan simbol yang tidak null ke depan array
                }
            }
            // Isi kekosongan dengan simbol baru dari atas
            while (colSymbols.length < height) {
                let newSymbol;
                const rand = Math.random();
                if (col === 0) {
                    if (rand < 0.01) { // Probabilitas scatter di kolom pertama
                        newSymbol = SCATTER_SYMBOL;
                    } else {
                        newSymbol = symbols[Math.floor(Math.random() * (symbols.length - 2))];
                    }
                } else {
                    if (rand < 0.04) { // Probabilitas wild
                        newSymbol = WILD_SYMBOL;
                    } else if (rand < 0.05) { // Probabilitas scatter di kolom lain
                        newSymbol = SCATTER_SYMBOL;
                    } else {
                        newSymbol = symbols[Math.floor(Math.random() * (symbols.length - 2))];
                    }
                }
                colSymbols.unshift(newSymbol); // Tambahkan simbol baru di depan array
            }
            // Perbarui currentSymbols dengan kolom yang sudah diisi ulang
            for (let row = 0; row < height; row++) {
                currentSymbols[row * width + col] = colSymbols[row];
            }
        }
        renderGrid(currentSymbols); // Render ulang grid setelah collapse
    }

    function updateBalance(amount) {
        balance += amount;
        balanceDisplay.textContent = `Saldo: Rp.${balance.toLocaleString('id-ID')}`; // Format angka agar lebih mudah dibaca
    }

    function updateBetDisplay() {
        betDisplay.textContent = `${bet}`;
    }

    function updateFreeSpinDisplay() {
        if (freeSpinCount > 0) {
            freeSpinDisplay.textContent = `Free Spins: ${freeSpinCount}`;
            freeSpinDisplay.style.display = 'block';
        } else {
            freeSpinDisplay.textContent = `Free Spins: 0`;
            freeSpinDisplay.style.display = 'none';
        }
    }

    function showPopup(message) {
        const popup = document.getElementById('popup');
        popup.textContent = message;
        popup.style.display = 'block';
        setTimeout(() => {
            popup.style.display = 'none';
        }, 1500);
    }

    async function showFreeSpinWinAnimation(totalWin) {
        freeSpinTotalWinDisplay.textContent = `Rp.${totalWin.toLocaleString('id-ID')}`;
        freeSpinWinOverlay.classList.add('show');

        document.getElementById('winBigSound').currentTime = 0;
        document.getElementById('winBigSound').play();

        await new Promise(resolve => setTimeout(resolve, 5000));
        freeSpinWinOverlay.classList.remove('show');
    }

    // Fungsi untuk menampilkan animasi multiplier
    function showAnimatedMultiplier() {
        animatedMultiplierValue.textContent = `x${currentMultiplier}`;
        animatedMultiplier.style.display = 'block';
        animatedMultiplier.style.animation = 'multiplierPopIn 0.8s forwards cubic-bezier(0.68, -0.55, 0.27, 1.55)';
    }

    // Fungsi untuk menyembunyikan animasi multiplier
    function hideAnimatedMultiplier() {
        animatedMultiplier.style.animation = ''; // Hapus animasi
        animatedMultiplier.style.display = 'none';
        animatedMultiplier.style.transform = 'translate(-50%, -50%) scale(0)'; // Reset posisi dan ukuran
        animatedMultiplier.style.opacity = '0'; // Reset opacity
    }


    async function spin() {
        if (freeSpinCount === 0 && balance < bet) {
            showPopup('Saldo tidak cukup!');
            return;
        }

        const spinSound = document.getElementById('spinSound');
        spinSound.currentTime = 0;
        spinSound.play();

        // Nonaktifkan tombol spin dan bet controls saat berputar
        spinButton.disabled = true;
        betMinusBtn.disabled = true;
        betPlusBtn.disabled = true;


        // Kurangi saldo hanya jika bukan Free Spin
        if (freeSpinCount === 0) {
            updateBalance(-bet);
        } else {
            freeSpinCount--;
        }
        updateFreeSpinDisplay();

        currentMultiplier = 0; // Reset multiplier di awal setiap spin
        hideAnimatedMultiplier(); // Pastikan multiplier tersembunyi di awal spin

        rollSound.currentTime = 0;
        rollSound.play();

        for (let col = 0; col < width; col++) {
            await animateReelShake(col);
        }

        rollSound.pause();
        rollSound.currentTime = 0;

        let currentSpinWin = 0;
        let chainReaction = true;

        while (chainReaction) {
            chainReaction = false;
            const { winningTiles, scatterCount, scatterIndices, currentRoundWin: baseWin } = getWinningTiles(currentSymbols);

            let roundPayout = baseWin;

            const tilesToBreakInThisRound = new Set();

            if (scatterCount >= 3) {
                let newFreeSpins = 0;
                if (scatterCount === 3) newFreeSpins = 10;
                else if (scatterCount === 4) newFreeSpins = 12;
                else if (scatterCount >= 5) newFreeSpins = 15;

                freeSpinCount += newFreeSpins;
                showPopup(`Anda mendapatkan ${newFreeSpins} Free Spins!`);
                scatterIndices.forEach(i => tilesToBreakInThisRound.add(i));
                chainReaction = true;
                updateFreeSpinDisplay();

                if (newFreeSpins > 0 && !isInFreeSpinMode) {
                    freeSpinSound.currentTime = 0;
                    freeSpinSound.play();
                    bgm.pause();
                    bgm.currentTime = 0;
                    freeSpinBGM.volume = 0.3;
                    freeSpinBGM.play();
                    isInFreeSpinMode = true;
                    totalFreeSpinWin = 0;
                }
            }

            if (winningTiles.length > 0) {
                currentMultiplier = Math.min(currentMultiplier + 1, 5); // Tingkatkan multiplier
                animatedMultiplierValue.textContent = `x${currentMultiplier}`; // Update nilai di elemen
                showAnimatedMultiplier(); // Tampilkan animasi multiplier
                
                roundPayout *= currentMultiplier; // Terapkan multiplier ke kemenangan putaran ini

                winningTiles.forEach(i => tilesToBreakInThisRound.add(i));
                chainReaction = true;
            } else {
                hideAnimatedMultiplier(); // Sembunyikan multiplier jika tidak ada kemenangan baru
            }

            currentSpinWin += roundPayout;

            if (tilesToBreakInThisRound.size > 0) {
                await handleTileCollapse(Array.from(tilesToBreakInThisRound));
                await new Promise(res => setTimeout(res, 300));
            } else {
                chainReaction = false;
            }
        }

        // Reset multiplier setelah semua reaksi berantai selesai dan sebelum spin berikutnya
        currentMultiplier = 0; 
        hideAnimatedMultiplier(); 
        
        if (isInFreeSpinMode) {
            totalFreeSpinWin += currentSpinWin;
        } else {
            updateBalance(currentSpinWin);
        }
        
        if (uid) {
            await supabase
                .from('users_data')
                .update({ saldo: balance })
                .eq('user_id', uid);
        }

        if (currentSpinWin > 0) {
            if (currentSpinWin >= bet * 10) {
                document.getElementById('winBigSound').play();
            } else {
                document.getElementById('winSmallSound').play();
            }
            showPopup(`Anda menang Rp.${currentSpinWin.toLocaleString('id-ID')}!`);
        } else if (freeSpinCount === 0 && !isInFreeSpinMode) {
             showPopup('Coba lagi!');
        }

        if (freeSpinCount > 0) {
            await new Promise(res => setTimeout(res, 1500)); // Jeda sebentar sebelum Free Spin berikutnya
            spin(); // Lanjutkan Free Spin otomatis
        } else {
            spinButton.disabled = false;
            betMinusBtn.disabled = false; // Aktifkan kembali bet controls
            betPlusBtn.disabled = false;
            updateFreeSpinDisplay();
            
            if (isInFreeSpinMode) {
                freeSpinBGM.pause();
                freeSpinBGM.currentTime = 0;
                bgm.play();
                isInFreeSpinMode = false;
                await showFreeSpinWinAnimation(totalFreeSpinWin);
                updateBalance(totalFreeSpinWin); // Tambahkan total kemenangan Free Spin ke saldo
                totalFreeSpinWin = 0;
            }
        }
    }

    betMinusBtn.onclick = () => {
      if (bet - 100 >= minBet) {
        bet -= 100;
        updateBetDisplay();
      }
    };
    betPlusBtn.onclick = () => {
      // Izinkan bet dinaikkan selama Free Spin atau jika saldo mencukupi
      if (bet + 100 <= maxBet && (isInFreeSpinMode || (balance >= (bet + 100)))) {
        bet += 100;
        updateBetDisplay();
      } else if (!isInFreeSpinMode && bet + 100 > balance) {
          showPopup('Saldo tidak cukup untuk bet ini!');
      }
    };
    spinButton.onclick = spin;

    bgm.volume = 0.3;

    function init() {
      currentSymbols = generateRandomSymbols();
      renderGrid(currentSymbols);
      updateBalance(0); // Akan diupdate oleh loadSaldo
      updateBetDisplay();
      updateFreeSpinDisplay();

      bgm.play().catch(() => {
        document.body.addEventListener('click', () => {
          bgm.play();
        }, { once: true });
      });
    }

    init();
  </script>
</body>
</html>