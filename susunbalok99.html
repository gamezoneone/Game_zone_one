<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Susun Balok Ajaib</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Perubahan Warna untuk Nuansa Modern */
            --primary-color: #FF4D4D; /* Merah untuk Peringatan/Kalah */
            --secondary-color: #4D4DFF; /* Biru Tua untuk Background Sekunder */
            --tertiary-color: #4DFF4D; /* Hijau Cerah untuk Kemenangan/Sukses */
            --accent-color: #00E0E0; /* Cyan Neon untuk Aksen & Glow */
            --text-light: #E0E0E0; /* Teks terang lebih soft */
            --text-dark: #1A1A1A; /* Teks gelap lebih solid */
            --canvas-bg: #0C0C0C; /* Background area permainan lebih gelap */
            --border-glow: #00E0E0; /* Border luar game container, senada accent */
            --button-bg: #00E0E0; /* Warna tombol default, senada accent */
            --button-active: #00B3B3; /* Warna tombol saat ditekan */
            --block-border: #222222; /* Warna border antar blok */
            --block-shadow: rgba(0, 0, 0, 0.4); /* Bayangan blok */
            --tile-size: 15px; /* Tambahkan ini agar bisa digunakan di CSS lain */
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e, #0a0a1e); /* Gradien lebih modern */
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            padding: 0px;
            box-sizing: border-box;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes balance-gain {
            0% { transform: scale(1); color: var(--primary-color); }
            50% { transform: scale(1.3); color: var(--tertiary-color); text-shadow: 0 0 10px var(--tertiary-color); }
            100% { transform: scale(1); color: var(--primary-color); text-shadow: none; }
        }

        @keyframes balance-loss {
            0% { transform: scale(1); color: var(--primary-color); }
            50% { transform: scale(1.3); color: #FF4444; text-shadow: 0 0 10px #FF4444; }
            100% { transform: scale(1); color: var(--primary-color); text-shadow: none; }
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(180deg, #1c1c1c, #0a0a0a);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 40px var(--border-glow);
            border: 2px solid var(--border-glow);
            width: 95%;
            max-width: 480px;
            box-sizing: border-box;
            position: relative;
        }

        h1 {
            color: var(--accent-color);
            text-shadow: 0 0 15px var(--accent-color), 0 0 25px rgba(0, 224, 224, 0.5);
            font-size: 1.5em;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .info-item {
            font-size: 0.9em;
            margin: 8px 0;
            white-space: nowrap;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .info-item span {
            margin-left: 10px;
        }
        .info-item #totalKemenanganSesi {
            color: var(--tertiary-color);
            font-weight: bold;
        }
        .info-item #totalKekalahanDisplay {
            color: var(--primary-color);
            font-weight: bold;
        }
        .info-item #balance {
            color: var(--tertiary-color);
            font-weight: bold;
            font-size: 1.2em;
            display: inline-block;
            transition: color 0.1s ease-out;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        .info-item #balance.animate-gain {
            animation: balance-gain 0.5s ease-out;
        }
        .info-item #balance.animate-loss {
            animation: balance-loss 0.5s ease-out;
        }

        .player-banner {
            background-color: var(--canvas-bg);
            border: 2px solid var(--accent-color);
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1em;
            color: var(--accent-color);
            text-align: left;
            box-shadow: inset 0 0 10px rgba(0, 224, 224, 0.3);
        }
        .player-banner p {
            margin: 0;
            padding: 3px 0;
            display: flex;
            justify-content: space-between;
        }
        .player-banner .player-name {
            font-weight: bold;
            color: var(--tertiary-color);
        }
        .player-banner .player-status {
            font-size: 0.8em;
            color: #AAAAAA;
        }

        canvas {
            background-color: var(--canvas-bg);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 224, 224, 0.6);
            display: block;
        }

        .controls {
            display: grid;
            grid-template-areas:
                "left rotate right"
                ". softdrop ."
            ;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin-top: 25px;
        }

        .controls button {
            background-color: var(--button-bg);
            color: var(--text-dark);
            border: none;
            padding: 15px 0;
            font-size: 1.8em;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            box-shadow: 0 6px 0 var(--button-active);
            -webkit-tap-highlight-color: transparent;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .controls button:active {
            background-color: var(--button-active);
            transform: translateY(3px);
            box-shadow: 0 3px 0 var(--button-active);
        }

        #moveLeftBtn { grid-area: left; }
        #rotateBtn { grid-area: rotate; }
        #moveRightBtn { grid-area: right; }
        #softDropBtn { grid-area: softdrop; }

        .bet-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 15px;
            gap: 10px;
            font-size: 1em;
            display: none; /* Default hidden */
        }

        .bet-controls button {
            background-color: #5D5DFF;
            color: var(--text-light);
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.1s ease;
            box-shadow: 0 4px 0 #4C4CBB;
            -webkit-tap-highlight-color: transparent;
        }
        .bet-controls button:active {
            background-color: #4C4CBB;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3B3B88;
        }

        .bet-controls span {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: 0 0 5px var(--accent-color);
            min-width: 80px;
            text-align: center;
        }

        #backToProfileBtn {
            margin-top: 25px;
            width: 100%;
            background-color: #FFD700;
            color: #333;
            font-size: 1.2em;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            box-shadow: 0 6px 0 #CCAA00;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        #backToProfileBtn:active {
            background-color: #CCAA00;
            transform: translateY(3px);
            box-shadow: 0 3px 0 #997A00;
        }

        .message-area {
            margin-top: 20px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-light);
            min-height: 30px;
            text-align: center;
            text-shadow: 0 0 8px rgba(0,0,0,0.7);
            padding: 5px;
        }
        .message-area.info {
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
        }
        .message-area.success {
            color: var(--tertiary-color);
            text-shadow: 0 0 10px var(--tertiary-color);
        }
        .message-area.error {
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }

        /* NEW: Styles for Win Animation Message */
        .win-message-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1);
            opacity: 0;
            color: gold;
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 15px gold, 0 0 25px orange;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            text-align: center;
            animation: none;
        }

        .win-message-overlay.animate {
            animation: zoomWin 1.8s ease-out forwards;
        }

        @keyframes zoomWin {
            0% {
                transform: translate(-50%, -50%) scale(0.1);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.3);
                opacity: 1;
            }
            80% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        /* Media Queries untuk Layar Ponsel */
        @media (max-width: 600px) {
            .game-container {
                width: 98%;
                padding: 15px;
                border-radius: 12px;
            }

            h1 {
                font-size: 1.2em;
                margin-bottom: 10px;
            }

            .info-item {
                font-size: 0.8em;
                margin: 6px 0;
            }
            .info-item #balance {
                font-size: 1.1em;
            }

            .player-banner {
                font-size: 0.9em;
                padding: 10px;
                margin-bottom: 15px;
            }

            .controls {
                gap: 8px;
                margin-top: 20px;
            }

            .controls button {
                padding: 12px 0;
                font-size: 1.5em;
                height: 55px;
                border-radius: 8px;
                box-shadow: 0 5px 0 var(--button-active);
            }
            .controls button:active {
                transform: translateY(2.5px);
                box-shadow: 0 2.5px 0 var(--button-active);
            }

            .bet-controls button {
                padding: 8px 12px;
                font-size: 0.9em;
                border-radius: 6px;
            }
            .bet-controls span {
                font-size: 1.1em;
                min-width: 60px;
            }

            #backToProfileBtn {
                font-size: 1.1em;
                padding: 12px 20px;
                margin-top: 20px;
                box-shadow: 0 5px 0 #CCAA00;
            }
            #backToProfileBtn:active {
                transform: translateY(2.5px);
                box-shadow: 0 2.5px 0 #997A00;
            }

            .message-area {
                font-size: 1em;
                min-height: 25px;
                margin-top: 15px;
            }

            .win-message-overlay {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
  <div class="game-container">
        <div class="player-banner">
            <p>Pemain: <span id="playerName" class="player-name">Memuat...</span></p>
            <p>Status: <span id="playerStatus" class="player-status">Memeriksa Login...</span></p>
            <p class="info-item">Kemenangan: <span id="totalKemenanganSesi">0</span></p>
            <p class="info-item">Kekalahan: <span id="totalKekalahanDisplay">0</span></p>
            <p class="info-item">Saldo: <span id="balance">Memuat...</span></p>
        </div>

        <canvas id="gameCanvas"></canvas>

        <div id="winMessage" class="win-message-overlay"></div>

        <div class="controls">
            <button id="moveLeftBtn" class="control-btn">←</button>
            <button id="rotateBtn" class="control-btn">↻</button>
            <button id="moveRightBtn" class="control-btn">→</button>
            <button id="softDropBtn" class="control-btn">↓</button>
        </div>

        <div class="bet-controls">
            <button id="decreaseBetBtn">-</button>
            <span id="currentBetDisplay">Bet: Rp0</span>
            <button id="increaseBetBtn">+</button>
        </div>

        <button id="backToProfileBtn" style="display:none;">Kembali ke Profil</button>
        <div id="message-area" class="message-area"></div>
    </div>

    <audio id="clickSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-game-ball-tap-2073.mp3" preload="auto"></audio>
    <audio id="lineClearSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-mechanical-crate-pick-up-3154%20(1).mp3" preload="auto"></audio>
    <audio id="blockLandSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//dj-background-music-background-music-free-music-music-free-for-use-221916%20(1).mp3" preload="auto" loop></audio>

    <script>
        const supabase = window.supabase.createClient(
            'https://vqmfachxnjyxwuavpgds.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
        );

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const totalKemenanganSesiDisplay = document.getElementById('totalKemenanganSesi');
        const totalKekalahanDisplay = document.getElementById('totalKekalahanDisplay');
        const balanceDisplay = document.getElementById('balance');
        const messageArea = document.getElementById('message-area');
        const playerNameDisplay = document.getElementById('playerName');
        const playerStatusDisplay = document.getElementById('playerStatus');

        // Dapatkan tombol kontrol
        const moveLeftBtn = document.getElementById('moveLeftBtn');
        const rotateBtn = document.getElementById('rotateBtn');
        const moveRightBtn = document.getElementById('moveRightBtn');
        const softDropBtn = document.getElementById('softDropBtn');
        const backToProfileBtn = document.getElementById('backToProfileBtn');

        // NEW: Elemen untuk Bet
        const currentBetDisplay = document.getElementById('currentBetDisplay');
        const decreaseBetBtn = document.getElementById('decreaseBetBtn');
        const increaseBetBtn = document.getElementById('increaseBetBtn');
        const winMessageDiv = document.getElementById('winMessage'); // Untuk animasi kemenangan

        // Konfigurasi Game Board
        const TILE_SIZE = 17;
        const BOARD_WIDTH = 17;
        const BOARD_HEIGHT = 22;

        // Sesuaikan ukuran canvas berdasarkan TILE_SIZE dan BOARD_DIMENSIONS
        canvas.width = BOARD_WIDTH * TILE_SIZE;
        canvas.height = BOARD_HEIGHT * TILE_SIZE;

        // Variabel Game State
        let totalKemenanganSesi = 0;
        let totalKekalahan = 0;
        let currentBalance = 0;
        let currentUser = null;
        let gameRunning = false;
        let board = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
        let currentPiece = null;
        let currentX = 0;
        let currentY = 0;
        let highestKemenangan = 0;

        // Dapatkan elemen audio
        const clickSound = document.getElementById('clickSound');
        const lineClearSound = document.getElementById('lineClearSound');
        const blockLandSound = document.getElementById('blockLandSound');
        const backgroundMusic = document.getElementById('backgroundMusic');

        // NEW: Variabel untuk Bet Logic
        let currentBet = 200; // Bet awal
        const MIN_BET = 100;
        const MAX_BET = 1000;
        const BET_INCREMENT = 100;
        const BASE_VALUE_PER_BLOCK_SQUARE = 50; // Poin dasar per kotak pecah
        const GAME_START_COST = 0; // Ubah ini jadi 0 jika biaya game sudah ditanggung per balok

        // Fungsi untuk memutar suara
        function playSound(audioElement) {
            if (audioElement) {
                audioElement.currentTime = 0;
                audioElement.play().catch(e => console.warn("Audio Playback Warning:", e.message));
            }
        }

        // Fungsi untuk memulai musik latar
        function playBackgroundMusic() {
            if (backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(e => {
                    console.warn("Autoplay of background music blocked. User interaction required. Error:", e.message);
                });
            }
        }

        // --- Supabase Integration Functions ---

        async function initializeUserAndSaldo() {
            playerNameDisplay.textContent = 'Memuat...';
            playerStatusDisplay.textContent = 'Memeriksa Login...';
            showMessage('Memeriksa sesi pengguna...', 'info');

            try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();

                if (authError) {
                    console.error('Supabase Auth Error:', authError.message);
                    playerStatusDisplay.textContent = 'Auth Error';
                    showMessage(`Gagal otentikasi: ${authError.message}. Silakan login ulang.`, 'error');
                    setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                    return;
                }

                if (user) {
                    currentUser = user;
                    playerNameDisplay.textContent = user.user_metadata?.username || user.email || 'Pemain';
                    playerStatusDisplay.textContent = 'Login';
                    console.log('User logged in:', currentUser.id);
                    await fetchSaldoAndKemenangan();
                } else {
                    console.warn('No active user session. Redirecting to login.');
                    playerStatusDisplay.textContent = 'Tidak Login';
                    showMessage('Anda belum login. Mengarahkan ke halaman login...', 'info');
                    setTimeout(() => { window.location.href = 'index.html', 3000; });
                }
            } catch (error) {
                console.error('Unexpected error during user initialization:', error.message);
                playerStatusDisplay.textContent = 'Error Inisialisasi';
                showMessage(`Error inisialisasi user: ${error.message}. Periksa Supabase config/CORS.`, 'error');
                backToProfileBtn.style.display = 'block';
            }
        }

        async function fetchSaldoAndKemenangan() {
            if (!currentUser) {
                showMessage('Error: Tidak ada user aktif untuk mengambil saldo/kemenangan.', 'error');
                return;
            }
            showMessage('Memuat data pemain...', 'info');
            balanceDisplay.textContent = 'Memuat...';
            totalKemenanganSesiDisplay.textContent = 'Memuat...';
            totalKekalahanDisplay.textContent = 'Memuat...';

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .select('saldo, username, highest_kemenangan')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error fetching data:', error.message);
                    if (error.code === 'PGRST116' || error.message.includes('0 rows')) {
                        console.warn('User entry not found in users_data. Creating new entry with default saldo...');
                        const usernameFromMeta = currentUser.user_metadata?.username || currentUser.email?.split('@')[0] || 'Unknown';
                        await createNewUserEntryWithDefaultSaldo(currentUser.id, currentUser.email, usernameFromMeta);
                        await fetchSaldoAndKemenangan();
                    } else {
                        showMessage(`Gagal memuat data: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                        balanceDisplay.textContent = 'Gagal';
                        totalKemenanganSesiDisplay.textContent = 'Gagal';
                        totalKekalahanDisplay.textContent = 'Gagal';
                        backToProfileBtn.style.display = 'block';
                    }
                    return;
                }

                if (data) {
                    currentBalance = data.saldo || 0;
                    balanceDisplay.textContent = currentBalance.toLocaleString('id-ID');
                    playerNameDisplay.textContent = data.username || currentUser.user_metadata?.username || currentUser.email || 'Pemain';
                    highestKemenangan = data.highest_kemenangan || 0;
                    totalKemenanganSesiDisplay.textContent = '0';
                    totalKekalahanDisplay.textContent = '0';

                    showMessage('Data pemain dimuat!', 'success');
                    console.log('Saldo fetched:', currentBalance, 'Highest Kemenangan:', highestKemenangan);

                    // NEW: Update bet display saat inisialisasi
                    currentBetDisplay.textContent = `Bet: Rp.${currentBet.toLocaleString('id-ID')}`;


                    if (currentBalance >= (GAME_START_COST > 0 ? GAME_START_COST : currentBet)) { // Cek saldo untuk start game atau minimal 1 bet
                        showMessage(`Siap! Saldo Anda: Rp.${currentBalance.toLocaleString('id-ID')}.`, 'info');
                        startGamePrompt();
                    } else {
                        showMessage(`Saldo Anda tidak cukup (Rp.${currentBalance.toLocaleString('id-ID')}). Perlu minimal Rp.${MIN_BET.toLocaleString('id-ID')} untuk bermain! Top up untuk bermain!`, 'error');
                        balanceDisplay.classList.add('animate-loss');
                        setTimeout(() => balanceDisplay.classList.remove('animate-loss'), 500);
                        backToProfileBtn.style.display = 'block';
                    }
                }

            } catch (err) {
                console.error('Unexpected error in fetchSaldoAndKemenangan:', err);
                showMessage('Terjadi kesalahan tak terduga saat memuat data pemain.', 'error');
                balanceDisplay.textContent = 'Error';
                totalKemenanganSesiDisplay.textContent = 'Error';
                totalKekalahanDisplay.textContent = 'Error';
                backToProfileBtn.style.display = 'block';
            }
        }
        async function createNewUserEntryWithDefaultSaldo(userId, email, username) {
            const DEFAULT_STARTING_SALDO = 0;
            const DEFAULT_HIGHEST_KEMENANGAN = 0;

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .insert([
                        { user_id: userId, saldo: DEFAULT_STARTING_SALDO, email: email, username: username, peran: 'Players_Guest', highest_kemenangan: DEFAULT_HIGHEST_KEMENANGAN }
                    ]);

                if (error) {
                    console.error('Error creating new user entry:', error.message);
                    showMessage(`Gagal membuat entry user baru: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                    return false;
                }
                console.log('New user entry created with default saldo:', DEFAULT_STARTING_SALDO);
                currentBalance = DEFAULT_STARTING_SALDO;
                highestKemenangan = DEFAULT_HIGHEST_KEMENANGAN;
                balanceDisplay.textContent = currentBalance.toLocaleString('id-ID');
                totalKemenanganSesiDisplay.textContent = '0';
                totalKekalahanDisplay.textContent = '0';
                showMessage('User baru dibuat dengan saldo awal!', 'success');
                return true;
            } catch (err) {
                console.error('Unexpected error in createNewUserEntryWithDefaultSaldo:', err);
                showMessage('Terjadi kesalahan tak terduga saat membuat user baru.', 'error');
                return false;
            }
        }

        let updateSaldoTimeout;
        async function updateSaldo(amount, updateDB = true) {
            currentBalance += amount;
            balanceDisplay.textContent = currentBalance.toLocaleString('id-ID');
            addBalanceAnimation(amount > 0 ? 'gain' : 'loss');

            if (amount > 0) {
                totalKemenanganSesi += amount;
                updateTotalKemenanganSesiDisplay();
            } else {
                totalKekalahan += Math.abs(amount);
                updateTotalKekalahanDisplay();
            }

            if (!currentUser || !updateDB) {
                console.log('Saldo lokal diperbarui, namun tidak ke DB (user tidak ada atau updateDB=false).');
                return;
            }

            clearTimeout(updateSaldoTimeout);
            updateSaldoTimeout = setTimeout(async () => {
                try {
                    const { data, error } = await supabase
                        .from('users_data')
                        .update({ saldo: currentBalance })
                        .eq('user_id', currentUser.id);

                    if (error) {
                        console.error('Error updating saldo:', error.message);
                        showMessage(`Gagal update saldo: ${error.message}. Periksa RLS/Koneksi.`, 'error');
                        return;
                    }
                    console.log('Saldo updated successfully to DB:', currentBalance);
                } catch (err) {
                    console.error('Unexpected error in updateSaldo:', err);
                    showMessage('Terjadi kesalahan tak terduga saat update saldo.', 'error');
                }
            }, 500);
        }

        async function saveHighestKemenangan(newKemenangan) {
            if (!currentUser) {
                console.warn('Tidak bisa menyimpan kemenangan tertinggi: Tidak ada user login.');
                return;
            }
            if (newKemenangan <= highestKemenangan) {
                console.log('Kemenangan baru tidak lebih tinggi dari kemenangan tertinggi yang ada.');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('users_data')
                    .update({ highest_kemenangan: newKemenangan })
                    .eq('user_id', currentUser.id);

                if (error) {
                    console.error('Error saving highest kemenangan:', error.message);
                    showMessage(`Gagal menyimpan kemenangan tertinggi: ${error.message}`, 'error');
                } else {
                    highestKemenangan = newKemenangan;
                    console.log('Kemenangan tertinggi berhasil disimpan:', newKemenangan);
                    showMessage(`Kemenangan tertinggi baru: ${newKemenangan}!`, 'success');
                }
            } catch (err) {
                console.error('Unexpected error in saveHighestKemenangan:', err);
                showMessage('Terjadi kesalahan tak terduga saat menyimpan kemenangan tertinggi.', 'error');
            }
        }

        const TETROMINOS = [
            {
                shape: [[0, 1, 0], [1, 1, 1], [0, 0, 0]], // T
                color: '#FF00FF' // Magenta
            },
            {
                shape: [[1, 1, 0], [0, 1, 1], [0, 0, 0]], // S
                color: '#00FF00' // Hijau
            },
            {
                shape: [[0, 1, 1], [1, 1, 0], [0, 0, 0]], // Z
                color: '#FF0000' // Merah
            },
            {
                shape: [[1, 1], [1, 1]], // O
                color: '#FFFF00' // Kuning
            },
            {
                shape: [[1, 0, 0], [1, 1, 1], [0, 0, 0]], // L
                color: '#FFA500' // Oranye
            },
            {
                shape: [[0, 0, 1], [1, 1, 1], [0, 0, 0]], // J
                color: '#0000FF' // Biru
            },
            {
                shape: [[1], [1], [1], [1]], // I
                color: '#00FFFF' // Cyan
            }
        ];


        // --- Fungsi Helper UI ---
        function showMessage(msg, type = 'info') {
            messageArea.textContent = msg;
            messageArea.className = `message-area ${type}`;
            setTimeout(() => {
                messageArea.textContent = '';
                messageArea.className = `message-area`;
            }, 3000);
        }

        function addBalanceAnimation(type) {
            balanceDisplay.classList.remove('animate-gain', 'animate-loss');
            void balanceDisplay.offsetWidth; // Trigger reflow
            balanceDisplay.classList.add(`animate-${type}`);
        }

        // NEW: Fungsi untuk menampilkan animasi kemenangan
        function showWinAnimation(score, multiplier) {
            const winMessageDiv = document.getElementById('winMessage');
            winMessageDiv.textContent = `${score.toLocaleString('id-ID')} Poin! (${multiplier}x Multiplier!)`;
            winMessageDiv.classList.add('animate');

            winMessageDiv.addEventListener('animationend', () => {
                winMessageDiv.classList.remove('animate');
            }, { once: true });
        }

        // --- Fungsi Game Logic ---

        function getRandomPiece() {
            const randomIndex = Math.floor(Math.random() * TETROMINOS.length);
            const piece = JSON.parse(JSON.stringify(TETROMINOS[randomIndex])); // Deep copy

            // NEW: Tambahkan multiplier secara acak dengan probabilitas 20%
            // Anda bisa mengubah nilai 0.20 (20%) sesuai keinginan Anda.
            // Contoh: 0.10 untuk 10%, 0.05 untuk 5%, dll.
            const MULTIPLIER_CHANCE = 0.20; // 20% kemungkinan muncul multiplier

            if (Math.random() < MULTIPLIER_CHANCE) {
                const numSquares = piece.shape.flat().filter(s => s === 1).length;
                if (numSquares > 0) {
                    let placedMultiplier = false;
                    let attempts = 0;
                    const maxAttempts = 10; // Batasi percobaan untuk menghindari infinite loop pada bentuk aneh
                    while (!placedMultiplier && attempts < maxAttempts) {
                        const randomRow = Math.floor(Math.random() * piece.shape.length);
                        const randomCol = Math.floor(Math.random() * piece.shape[randomRow].length);

                        if (piece.shape[randomRow][randomCol] === 1) {
                            piece.shape[randomRow][randomCol] = 'multiplier';
                            piece.multiplierValue = Math.floor(Math.random() * (20 - 2 + 1)) + 2;
                            placedMultiplier = true;
                        }
                        attempts++;
                    }
                }
            }
            return piece;
        }


        function drawBoard() {
            for (let row = 0; row < BOARD_HEIGHT; row++) {
                for (let col = 0; col < BOARD_WIDTH; col++) {
                    if (board[row][col] !== 0) {
                        ctx.fillStyle = board[row][col].color;
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--block-border');
                        ctx.strokeRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        // NEW: Gambar teks multiplier jika ada
                        if (board[row][col].multiplier) {
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-dark');
                            ctx.font = `${0.3 * TILE_SIZE}px 'Press Start 2P'`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${board[row][col].multiplier}x`, (col + 0.5) * TILE_SIZE, (row + 0.5) * TILE_SIZE);
                        }
                    } else {
                        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--canvas-bg');
                        ctx.fillRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = '#222';
                        ctx.strokeRect(col * TILE_SIZE, row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }
        function drawPiece(piece, x, y) {
            if (!piece) return;
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        ctx.fillStyle = piece.color;
                        ctx.fillRect((x + col) * TILE_SIZE, (y + row) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--block-border');
                        ctx.strokeRect((x + col) * TILE_SIZE, (y + row) * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        // NEW: Gambar teks multiplier jika ada pada bagian balok yang sedang jatuh
                        if (piece.shape[row][col] === 'multiplier') {
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-dark');
                            ctx.font = `${0.3 * TILE_SIZE}px 'Press Start 2P'`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${piece.multiplierValue}x`, (x + col + 0.5) * TILE_SIZE, (y + row + 0.5) * TILE_SIZE);
                        }
                    }
                }
            }
        }

        function isValidMove(piece, newX, newY) {
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    if (piece.shape[row][col]) {
                        const boardX = newX + col;
                        const boardY = newY + row;

                        if (boardX < 0 || boardX >= BOARD_WIDTH || boardY >= BOARD_HEIGHT) {
                            return false;
                        }
                        if (boardY >= 0 && board[boardY][boardX] !== 0) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        function placePiece() {
            for (let row = 0; row < currentPiece.shape.length; row++) {
                for (let col = 0; col < currentPiece.shape[row].length; col++) {
                    if (currentPiece.shape[row][col]) {
                        if (currentY + row < 0) {
                            gameOver();
                            return;
                        }
                        let cellData = {
                            color: currentPiece.color,
                            clear_value_per_block: BASE_VALUE_PER_BLOCK_SQUARE
                        };
                        if (currentPiece.shape[row][col] === 'multiplier') {
                            cellData.multiplier = currentPiece.multiplierValue;
                        }
                        board[currentY + row][currentX + col] = cellData;
                    }
                }
            }
            playSound(blockLandSound);
            clearLines();
            createNewPiece();
        }

        function rotatePiece(piece) {
            const newShape = Array(piece.shape[0].length).fill(null).map(() => Array(piece.shape.length).fill(0));
            for (let row = 0; row < piece.shape.length; row++) {
                for (let col = 0; col < piece.shape[row].length; col++) {
                    newShape[col][piece.shape.length - 1 - row] = piece.shape[row][col];
                }
            }
            // NEW: Pastikan multiplier ikut terotasi dengan benar
            const newPiece = { ...piece, shape: newShape };
            return newPiece;
        }

        function clearLines() {
            let linesCleared = 0;
            let totalSquaresClearedInLine = 0;
            let highestMultiplierFound = 1;

            for (let row = BOARD_HEIGHT - 1; row >= 0; row--) {
                if (board[row].every(cell => cell !== 0)) {
                    linesCleared++;
                    for (let col = 0; col < BOARD_WIDTH; col++) {
                        totalSquaresClearedInLine++;
                        if (board[row][col] && board[row][col].multiplier) {
                            if (board[row][col].multiplier > highestMultiplierFound) {
                                highestMultiplierFound = board[row][col].multiplier;
                            }
                        }
                    }
                    for (let r = row; r > 0; r--) {
                        board[r] = [...board[r - 1]];
                    }
                    board[0] = Array(BOARD_WIDTH).fill(0);
                    row++;
                }
            }

            if (linesCleared > 0) {
                playSound(lineClearSound);
                let pointsEarned = totalSquaresClearedInLine * BASE_VALUE_PER_BLOCK_SQUARE * highestMultiplierFound;
                updateSaldo(pointsEarned);
                showMessage(`+Rp${pointsEarned.toLocaleString('id-ID')} dari ${linesCleared} baris!`, 'success');
                showWinAnimation(pointsEarned, highestMultiplierFound);
            }
        }

        function updateTotalKemenanganSesiDisplay() {
            totalKemenanganSesiDisplay.textContent = totalKemenanganSesi.toLocaleString('id-ID');
        }

        function updateTotalKekalahanDisplay() {
            totalKekalahanDisplay.textContent = totalKekalahan.toLocaleString('id-ID');
        }

        function updateBalanceDisplay() {
            balanceDisplay.textContent = currentBalance.toLocaleString('id-ID');
        }

        function createNewPiece() {
            currentPiece = getRandomPiece();
            currentY = 0;
            currentX = Math.floor(BOARD_WIDTH / 2) - Math.floor(currentPiece.shape[0].length / 2);

            const costPerBlockDrop = currentBet; // Setiap balok jatuh mengurangi saldo sejumlah bet

            if (currentBalance < costPerBlockDrop) {
                showMessage(`Saldo tidak cukup untuk balok ini (perlu Rp${costPerBlockDrop.toLocaleString('id-ID')})!`, 'error');
                gameOver();
                return;
            }

            updateSaldo(-costPerBlockDrop);
            showMessage(`-${costPerBlockDrop.toLocaleString('id-ID')} Saldo. Sisa: Rp${currentBalance.toLocaleString('id-ID')}`, 'info');

            if (!isValidMove(currentPiece, currentX, currentY)) {
                gameOver();
            }
        }
        let dropInterval = 200;
        let lastDropTime = 0;
        let animationFrameId = null;

        function gameLoop(timestamp) {
            if (!gameRunning) {
                cancelAnimationFrame(animationFrameId);
                return;
            }

            if (!lastDropTime) lastDropTime = timestamp;
            const deltaTime = timestamp - lastDropTime;

            if (deltaTime > dropInterval) {
                if (isValidMove(currentPiece, currentX, currentY + 1)) {
                    currentY++;
                } else {
                    placePiece();
                }
                lastDropTime = timestamp;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
            drawPiece(currentPiece, currentX, currentY);

            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGamePrompt() {
            hideGameControls();
            document.querySelector('.bet-controls').style.display = 'flex'; // Tampilkan kontrol bet

            const startButton = document.createElement('button');
            startButton.textContent = `Mulai Game`;
            startButton.id = 'startButton';
            startButton.style.cssText = `
                margin-top: 20px;
                width: 100%;
                background-color: var(--tertiary-color);
                color: var(--text-dark);
                font-size: 1.2em;
                padding: 15px 25px;
                border-radius: 8px;
                cursor: pointer;
                border: none;
                box-shadow: 0 4px 0 #4CAF50;
                transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            `;
            startButton.onmouseover = () => startButton.style.backgroundColor = '#8BC34A';
            startButton.onmouseout = () => startButton.style.backgroundColor = 'var(--tertiary-color)';
            startButton.onmousedown = () => { startButton.style.transform = 'translateY(2px)'; startButton.style.boxShadow = '0 2px 0 #4CAF50'; };
            startButton.onmouseup = () => { startButton.style.transform = 'translateY(0)'; startButton.style.boxShadow = '0 4px 0 #4CAF50'; };
            startButton.onclick = initiateGameStart;

            document.querySelector('.game-container').insertBefore(startButton, document.querySelector('.controls'));
            showMessage('Klik "Mulai Game" untuk bermain.', 'info');

            backToProfileBtn.style.display = 'block';
        }
        async function initiateGameStart() {
            playSound(clickSound);
            document.getElementById('startButton')?.remove();

            if (GAME_START_COST > 0 && currentBalance < GAME_START_COST) {
                showMessage(`Saldo Anda tidak cukup (Rp.${currentBalance.toLocaleString('id-ID')}). Perlu Rp.${GAME_START_COST.toLocaleString('id-ID')} untuk mulai. Top up untuk bermain!`, 'error');
                balanceDisplay.classList.add('animate-loss');
                setTimeout(() => balanceDisplay.classList.remove('animate-loss'), 500);
                backToProfileBtn.style.display = 'block';
                return;
            }
            if (GAME_START_COST > 0) {
                await updateSaldo(-GAME_START_COST, true);
                showMessage(`Rp.${GAME_START_COST.toLocaleString('id-ID')} dikurangi untuk memulai game.`, 'info');
            }

            gameRunning = true;
            board = Array(BOARD_HEIGHT).fill(null).map(() => Array(BOARD_WIDTH).fill(0));
            totalKemenanganSesi = 0;
            totalKekalahan = 0;
            updateTotalKemenanganSesiDisplay();
            updateTotalKekalahanDisplay();
            updateBalanceDisplay();
            currentBetDisplay.textContent = `Bet: Rp.${currentBet.toLocaleString('id-ID')}`;
            messageArea.textContent = '';
            backToProfileBtn.style.display = 'none';

            showGameControls();
            document.querySelector('.bet-controls').style.display = 'none'; // Sembunyikan kontrol bet saat game berjalan
            createNewPiece();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(gameLoop);
            playBackgroundMusic();
        }
        function gameOver() {
            gameRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            currentPiece = null;

            showMessage('GAME OVER! Saldo habis atau tidak ada tempat.', 'error');
            console.log('Game Over! Saldo Akhir: ' + currentBalance.toLocaleString('id-ID'));
            console.log('Total Kemenangan Sesi Akhir: ' + totalKemenanganSesi.toLocaleString('id-ID'));
            console.log('Total Kekalahan Sesi Akhir: ' + totalKekalahan.toLocaleString('id-ID'));


            if (totalKemenanganSesi > highestKemenangan) {
                saveHighestKemenangan(totalKemenanganSesi);
            }

            hideGameControls();
            document.querySelector('.bet-controls').style.display = 'flex'; // Tampilkan lagi kontrol bet
            const playAgainBtn = document.createElement('button');
            playAgainBtn.textContent = 'Main Lagi';
            playAgainBtn.id = 'playAgainBtn';
            playAgainBtn.style.cssText = `
                margin-top: 20px;
                width: 100%;
                background-color: var(--tertiary-color);
                color: var(--text-dark);
                font-size: 1.2em;
                padding: 15px 25px;
                border-radius: 8px;
                cursor: pointer;
                border: none;
                box-shadow: 0 4px 0 #4CAF50;
                transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
            `;
            playAgainBtn.onmouseover = () => playAgainBtn.style.backgroundColor = '#8BC34A';
            playAgainBtn.onmouseout = () => playAgainBtn.style.backgroundColor = 'var(--tertiary-color)';
            playAgainBtn.onmousedown = () => { playAgainBtn.style.transform = 'translateY(2px)'; playAgainBtn.style.boxShadow = '0 2px 0 #4CAF50'; };
            playAgainBtn.onmouseup = () => { playAgainBtn.style.transform = 'translateY(0)'; playAgainBtn.style.boxShadow = '0 4px 0 #4CAF50'; };
            playAgainBtn.onclick = () => {
                playSound(clickSound);
                playAgainBtn.remove();
                initializeUserAndSaldo();
            };
            document.querySelector('.game-container').insertBefore(playAgainBtn, backToProfileBtn);

            backToProfileBtn.style.display = 'block';
        }

        function hideGameControls() {
            moveLeftBtn.style.display = 'none';
            rotateBtn.style.display = 'none';
            moveRightBtn.style.display = 'none';
            softDropBtn.style.display = 'none';
        }

        function showGameControls() {
            moveLeftBtn.style.display = 'flex';
            rotateBtn.style.display = 'flex';
            moveRightBtn.style.display = 'flex';
            softDropBtn.style.display = 'flex';
        }

        // NEW: Fungsi untuk mengubah nilai bet
        function adjustBet(amount) {
            const newBet = currentBet + amount;
            if (newBet >= MIN_BET && newBet <= MAX_BET && newBet % BET_INCREMENT === 0) {
                currentBet = newBet;
                currentBetDisplay.textContent = `Bet: Rp.${currentBet.toLocaleString('id-ID')}`;
                showMessage(`Bet diatur ke Rp.${currentBet.toLocaleString('id-ID')}`, 'info');
            } else {
                showMessage(`Bet harus antara Rp${MIN_BET.toLocaleString('id-ID')} dan Rp${MAX_BET.toLocaleString('id-ID')} dan kelipatan Rp${BET_INCREMENT.toLocaleString('id-ID')}.`, 'error');
            }
        }

        // Event listener untuk tombol sentuh bet
        decreaseBetBtn.addEventListener('click', () => {
            playSound(clickSound);
            adjustBet(-BET_INCREMENT);
        });

        increaseBetBtn.addEventListener('click', () => {
            playSound(clickSound);
            adjustBet(BET_INCREMENT);
        });


        document.addEventListener('keydown', e => {
            if (!gameRunning || !currentPiece) return;

            let moved = false;
            let newX = currentX;
            let newY = currentY;
            let newPiece = currentPiece;

            if (e.key === 'ArrowLeft') { newX--; moved = true; playSound(clickSound); }
            else if (e.key === 'ArrowRight') { newX++; moved = true; playSound(clickSound); }
            else if (e.key === 'ArrowDown') { newY++; moved = true; lastDropTime = performance.now(); playSound(clickSound); }
            else if (e.key === 'ArrowUp' || e.key === ' ') {
                const rotated = rotatePiece(currentPiece);
                if (isValidMove(rotated, currentX, currentY)) { // Cek validitas rotasi
                    newPiece = rotated;
                    moved = true;
                    playSound(clickSound);
                }
            }
            else if (e.key === 'Control' || e.key === 'Enter') {
                while (isValidMove(currentPiece, currentX, currentY + 1)) { currentY++; }
                placePiece();
                return;
            }

            if (moved && isValidMove(newPiece, newX, newY)) {
                currentX = newX;
                currentY = newY;
                currentPiece = newPiece;
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY);
        });

        // Event listener untuk tombol sentuh
        moveLeftBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX - 1, currentY)) { currentX--; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        rotateBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            const newPiece = rotatePiece(currentPiece);
            if (isValidMove(newPiece, currentX, currentY)) { currentPiece = newPiece; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        moveRightBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX + 1, currentY)) { currentX++; playSound(clickSound); ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY); }
        });

        softDropBtn.addEventListener('click', () => {
            if (!gameRunning || !currentPiece) return;
            if (isValidMove(currentPiece, currentX, currentY + 1)) { currentY++; lastDropTime = performance.now(); } else { placePiece(); }
            playSound(clickSound);
            ctx.clearRect(0, 0, canvas.width, canvas.height); drawBoard(); drawPiece(currentPiece, currentX, currentY);
        });

        // Tombol Kembali ke Profil
        backToProfileBtn.addEventListener('click', () => {
            playSound(clickSound);
            window.location.href = 'index.html';
        });

        // --- Inisialisasi Awal ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeUserAndSaldo();
            hideGameControls();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBoard();
        });

        // Pastikan musik latar mulai berputar setelah ada interaksi user
        document.body.addEventListener('click', () => {
            playBackgroundMusic();
        }, { once: true });

    </script>
</body>
</html>
