<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domino Qiu Qiu - Pemain vs Bandar</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #0a0a0a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden; /* Prevent scrolling */
    color: #fff;
    text-shadow: 0 0 0.2rem rgba(255, 255, 255, 0.4);
    box-sizing: border-box;
}

.game-container {
    background: linear-gradient(145deg, #1a0a30, #3a1a50); /* Background ungu gelap */
    border: 0.2rem solid #a020f0; /* Purple neon */
    border-radius: 1.5rem;
    padding: 1rem; /* Kurangi padding */
    box-shadow:
        inset 0 0 1.5rem rgba(160, 32, 240, 0.5),
        0 0 3rem rgba(160, 32, 240, 0.7),
        0 0 1.8rem rgba(0, 255, 255, 0.5);
    text-align: center;
    width: 98%; /* Sedikit lebih lebar */
    max-width: 600px; /* Lebar maksimum yang lebih kecil */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    min-height: 90vh; /* Memastikan cukup tinggi untuk konten */
}

header {
    width: 100%;
    margin-bottom: 0.8rem; /* Kurangi margin */
    position: relative;
    z-index: 2;
}

h1 {
    font-size: 2.2rem; /* Perkecil font */
    color: #ffcc00; /* Neon kuning */
    text-shadow: 0 0 0.3rem #ffcc00, 0 0 0.6rem #ffcc00, 0 0 0.9rem #ffcc00, 0 0 1.2rem #ff0000;
    margin: 0 auto;
    padding: 0.2rem 0;
    letter-spacing: 0.08rem;
    position: relative;
    display: inline-block;
}

.player-info {
    font-size: 0.8rem; /* Perkecil font */
    margin-top: 0.6rem; /* Kurangi margin */
    color: #00ffff;
    text-shadow: 0 0 0.2rem #00ffff;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    gap: 0.4rem; /* Kurangi gap */
    padding: 0.4rem 0.8rem; /* Kurangi padding */
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 0.4rem;
    border: 1px solid rgba(0, 255, 255, 0.5);
    box-shadow: inset 0 0 0.3rem rgba(0, 255, 255, 0.3);
}
.player-info p {
    margin: 0;
    line-height: 1.2;
}

.control-btn {
    background: linear-gradient(135deg, #007bff, #00c6ff);
    font-size: 0.7rem; /* Perkecil font */
    padding: 0.3rem 0.6rem; /* Kurangi padding */
    border: none;
    border-radius: 0.3rem;
    box-shadow: 0 0 0.4rem rgba(0, 123, 255, 0.6);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
}
.control-btn:hover {
    background: linear-gradient(135deg, #00c6ff, #007bff);
    box-shadow: 0 0 0.6rem rgba(0, 123, 255, 0.8);
    transform: translateY(-0.05rem);
}


.game-table {
    background: linear-gradient(to bottom, #006400, #008000); /* Dark green felt */
    border: 0.2rem solid #a020f0;
    border-radius: 50%;
    width: 90%;
    max-width: 400px; /* Ukuran meja lebih kecil */
    height: 400px; /* Ukuran meja lebih kecil */
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    position: relative;
    margin: 1rem 0; /* Kurangi margin */
    box-shadow: inset 0 0 1.5rem rgba(0, 0, 0, 0.8), 0 0 0.8rem rgba(160, 32, 240, 0.5);
    flex-shrink: 0;
}

.game-table::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 0.2rem solid #00ffff; /* Neon cyan, lebih tipis */
    border-radius: 50%;
    box-shadow: 0 0 0.8rem #00ffff, 0 0 1.5rem rgba(0, 255, 255, 0.6);
    z-index: 0;
}


.player-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem; /* Kurangi gap */
    width: 30%;
    background-color: rgba(0, 0, 0, 0.0);
    border-radius: 0.6rem; /* Lebih kecil */
    padding: 0.4rem; /* Kurangi padding */
    /*border: 1px solid rgba(255, 255, 0, 0.5);
    /*box-shadow: inset 0 0 0.4rem rgba(255, 255, 0, 0.3);
}

.player-label {
    font-size: 1rem; /* Perkecil font */
    font-weight: bold;
    color: #ffcc00;
    text-shadow: 0 0 0.3rem #ffcc00;
}

.cards-container {
    display: flex;
    justify-content: center;
    gap: 0.4rem; /* Kurangi gap */
    height: 80px; /* Tinggi untuk dua kartu yang lebih kecil */
    perspective: 1000px;
}

/* ============================================== */
/* DOMINO CARD STYLING (CSS ONLY)               */
/* ============================================== */
.card {
    width: 55px; /* Lebar kartu lebih kecil */
    height: 80px; /* Tinggi kartu lebih kecil */
    border: 1px solid #333; /* Border kartu */
    border-radius: 5px; /* Sudut kartu lebih kecil */
    background-color: #f7f7f7; /* Warna dasar kartu (putih gading) */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); /* Shadow lebih kecil */
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column; /* Ini penting agar kita bisa menargetkan bagian atas dan bawah */
    justify-content: space-around; /* Memberi ruang di antara bagian atas dan bawah */
    align-items: center;
    padding: 4px; /* Kurangi padding */
    box-sizing: border-box;
    transition: transform 0.5s ease-out;
    transform-style: preserve-3d;
}

.card.back {
    background-color: #555;
    background-image: linear-gradient(45deg, #666 25%, transparent 25%, transparent 75%, #666 75%, #666),
                      linear-gradient(45deg, #666 25%, transparent 25%, transparent 75%, #666 75%, #666);
    background-size: 8px 8px; /* Ukuran pola lebih kecil */
    background-position: 0 0, 4px 4px; /* Offset pola lebih kecil */
    border: 1px solid #aaa;
}

/* Garis pemisah tengah */
.card:not(.back)::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 1px; /* Tebal garis lebih kecil */
    background-color: #333;
    transform: translateY(-50%);
    z-index: 1;
}

/* Dot styling */
.dot {
    position: absolute; /* Penting untuk penempatan presisi */
    width: 7px; /* Ukuran dot lebih kecil */
    height: 7px;
    background-color: #333;
    border-radius: 50%;
    z-index: 2; /* Pastikan dot di atas garis */
    display: none; /* Sembunyikan semua dot secara default */
}

/* Tampilkan dot jika kartu TIDAK dalam keadaan 'back' */
.card:not(.back) .dot {
    display: block;
}

/* ================================================================= */
/* PENEMPATAN TITIK-TITIK DOMINO (Perbaikan Presisi)               */
/* ================================================================= */

/* TOP HALF (DATA-VALUE1) */
.card[data-value1="0"] .dot.top-center { display: none; } /* Semua dot disembunyikan untuk 0 */
.card[data-value1="0"] .dot.top-left { display: none; }
.card[data-value1="0"] .dot.top-right { display: none; }
.card[data-value1="0"] .dot.mid-center-top { display: none; }

.card[data-value1="1"] .dot.mid-center-top { top: 16px; left: 50%; transform: translateX(-50%); } /* Titik tengah atas */

.card[data-value1="2"] .dot.top-left { top: 8px; left: 8px; }
.card[data-value1="2"] .dot.bottom-right { top: 25px; right: 8px; } /* Ini untuk bagian atas, di bawah kanan relative ke bagian atas */

.card[data-value1="3"] .dot.top-left { top: 8px; left: 8px; }
.card[data-value1="3"] .dot.mid-center-top { top: 16px; left: 50%; transform: translateX(-50%); } /* Titik tengah atas */
.card[data-value1="3"] .dot.bottom-right { top: 25px; right: 8px; }

.card[data-value1="4"] .dot.top-left { top: 8px; left: 8px; }
.card[data-value1="4"] .dot.top-right { top: 8px; right: 8px; }
.card[data-value1="4"] .dot.bottom-left { top: 25px; left: 8px; }
.card[data-value1="4"] .dot.bottom-right { top: 25px; right: 8px; }

.card[data-value1="5"] .dot.top-left { top: 8px; left: 8px; }
.card[data-value1="5"] .dot.top-right { top: 8px; right: 8px; }
.card[data-value1="5"] .dot.mid-center-top { top: 16px; left: 50%; transform: translateX(-50%); } /* Titik tengah atas */
.card[data-value1="5"] .dot.bottom-left { top: 25px; left: 8px; }
.card[data-value1="5"] .dot.bottom-right { top: 25px; right: 8px; }

.card[data-value1="6"] .dot.top-left { top: 8px; left: 8px; }
.card[data-value1="6"] .dot.top-center { top: 8px; left: 50%; transform: translateX(-50%); } /* Dot di tengah atas baris atas */
.card[data-value1="6"] .dot.top-right { top: 8px; right: 8px; }
.card[data-value1="6"] .dot.bottom-left { top: 25px; left: 8px; }
.card[data-value1="6"] .dot.bottom-center { top: 25px; left: 50%; transform: translateX(-50%); } /* Dot di tengah atas baris bawah */
.card[data-value1="6"] .dot.bottom-right { top: 25px; right: 8px; }


/* BOTTOM HALF (DATA-VALUE2) */
.card[data-value2="0"] .dot.bottom-center { display: none; } /* Semua dot disembunyikan untuk 0 */
.card[data-value2="0"] .dot.bottom-left { display: none; }
.card[data-value2="0"] .dot.bottom-right { display: none; }
.card[data-value2="0"] .dot.mid-center-bottom { display: none; }

.card[data-value2="1"] .dot.mid-center-bottom { bottom: 16px; left: 50%; transform: translateX(-50%); } /* Titik tengah bawah */

.card[data-value2="2"] .dot.top-left { bottom: 25px; left: 8px; } /* Ini untuk bagian bawah, di atas kiri relative ke bagian bawah */
.card[data-value2="2"] .dot.bottom-right { bottom: 8px; right: 8px; }

.card[data-value2="3"] .dot.top-left { bottom: 25px; left: 8px; }
.card[data-value2="3"] .dot.mid-center-bottom { bottom: 16px; left: 50%; transform: translateX(-50%); } /* Titik tengah bawah */
.card[data-value2="3"] .dot.bottom-right { bottom: 8px; right: 8px; }

.card[data-value2="4"] .dot.top-left { bottom: 25px; left: 8px; }
.card[data-value2="4"] .dot.top-right { bottom: 25px; right: 8px; }
.card[data-value2="4"] .dot.bottom-left { bottom: 8px; left: 8px; }
.card[data-value2="4"] .dot.bottom-right { bottom: 8px; right: 8px; }

.card[data-value2="5"] .dot.top-left { bottom: 25px; left: 8px; }
.card[data-value2="5"] .dot.top-right { bottom: 25px; right: 8px; }
.card[data-value2="5"] .dot.mid-center-bottom { bottom: 16px; left: 50%; transform: translateX(-50%); } /* Titik tengah bawah */
.card[data-value2="5"] .dot.bottom-left { bottom: 8px; left: 8px; }
.card[data-value2="5"] .dot.bottom-right { bottom: 8px; right: 8px; }

.card[data-value2="6"] .dot.top-left { bottom: 25px; left: 8px; }
.card[data-value2="6"] .dot.top-center { bottom: 25px; left: 50%; transform: translateX(-50%); } /* Dot di tengah bawah baris atas */
.card[data-value2="6"] .dot.top-right { bottom: 25px; right: 8px; }
.card[data-value2="6"] .dot.bottom-left { bottom: 8px; left: 8px; }
.card[data-value2="6"] .dot.bottom-center { bottom: 8px; left: 50%; transform: translateX(-50%); } /* Dot di tengah bawah baris bawah */
.card[data-value2="6"] .dot.bottom-right { bottom: 8px; right: 8px; }


.hand-value {
    font-size: 1.1rem; /* Perkecil font */
    font-weight: bold;
    color: #99ff33;
    text-shadow: 0 0 0.3rem #99ff33;
    min-height: 1.3rem; /* Menyesuaikan ruang */
}


.controls {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.6rem; /* Kurangi gap */
    width: 100%;
    margin-top: 0.8rem; /* Kurangi margin */
}

.bet-control {
    display: flex;
    align-items: center;
    gap: 0.4rem; /* Kurangi gap */
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.4rem;
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(153, 255, 51, 0.5);
    box-shadow: inset 0 0 0.3rem rgba(153, 255, 51, 0.3);
}

.bet-control label {
    font-size: 0.9rem; /* Perkecil font */
    color: #99ff33;
    text-shadow: 0 0 0.3rem #99ff33;
}

.bet-control input {
    width: 70px; /* Lebar input lebih kecil */
    padding: 0.5rem 0.7rem; /* Kurangi padding */
    border-radius: 0.3rem;
    border: 0.1rem solid #66ffff;
    background-color: #0d1217;
    color: #fff;
    font-size: 0.9rem; /* Perkecil font */
    text-align: center;
    box-shadow: inset 0 0 0.4rem rgba(102, 255, 255, 0.4);
    outline: none;
}
.bet-control input:focus {
    border-color: #ff00ff;
    box-shadow: inset 0 0 0.6rem rgba(255, 0, 255, 0.6);
}

button {
    background: linear-gradient(135deg, #ff00ff, #8a2be2);
    color: #fff;
    padding: 0.7rem 1.2rem; /* Kurangi padding */
    border: none;
    border-radius: 0.6rem;
    font-size: 1.2rem; /* Perkecil font */
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 0.8rem rgba(255, 0, 255, 0.7), 0 0 0.5rem rgba(138, 43, 226, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.07rem;
    text-shadow: 0 0 0.1rem rgba(0,0,0,0.5);
    width: 90%;
    max-width: 220px; /* Lebar tombol lebih kecil */
}

button:hover {
    background: linear-gradient(135deg, #8a2be2, #ff00ff);
    box-shadow: 0 0 1.2rem rgba(255, 0, 255, 0.9), 0 0 0.8rem rgba(138, 43, 226, 0.7);
    transform: translateY(-0.1rem);
}

button:active {
    transform: translateY(0);
    box-shadow: 0 0 0.3rem rgba(255, 0, 255, 0.5);
}

button:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.7;
}

.messages {
    margin-top: 0.8rem; /* Kurangi margin */
    font-size: 0.9rem; /* Perkecil font */
    color: #00ff00;
    text-shadow: 0 0 0.4rem #00ff00;
    min-height: 1.8rem; /* Menyesuaikan ruang */
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.4rem;
    padding: 0.4rem;
    border: 1px solid rgba(0, 255, 0, 0.5);
    width: 100%;
    box-sizing: border-box;
}

/* Media Queries untuk Responsivitas */
@media (max-width: 600px) {
    h1 {
        font-size: 2rem;
    }
    .game-table {
        width: 320px;
        height: 320px;
        max-width: 320px;
        max-height: 320px;
    }
    .player-label {
        font-size: 0.9rem;
    }
    .card {
        width: 50px;
        height: 75px;
    }
    .hand-value {
        font-size: 1rem;
    }
    button {
        font-size: 1.1rem;
        padding: 0.5rem 0.8rem;
    }
    .messages {
        font-size: 0.8rem;
    }
}

@media (max-width:

</style>
</head>
<body>
    <audio id="dealCardSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/deal_card_sound.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/win_sound.mp3" preload="auto"></audio>
    <audio id="loseSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/lose_sound.mp3" preload="auto"></audio>
    <audio id="drawSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/draw_sound.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" preload="auto" loop></audio>


    <div class="game-container">
        <header>
            <h1>Domino Qiu Qiu</h1>
            <div class="player-info">
                <p>Player: <span id="playerName">Loading...</span></p>
                <p>Balance: <span id="playerBalance">0</span> Credits</p>
                <button id="logoutBtn" class="control-btn" style="display: none;">Logout</button>
            </div>
        </header>

        <div class="game-table">
            <div class="dealer-area player-box">
                <div class="player-label">BANDAR</div>
                <div class="cards-container" id="dealerCards">
                    <div class="card back"></div>
                    <div class="card back"></div>
                </div>
                <div class="hand-value" id="dealerValue"></div>
            </div>

            <div class="player-area player-box">
                <div class="player-label"></div>
                <div class="cards-container" id="playerCards">
                    <div class="card back"></div>
                    <div class="card back"></div>
                </div>
                <div class="hand-value" id="playerValue"></div>
            </div>
        </div>

        <div class="controls">
            <div class="bet-control">
                <label for="betAmount">Taruhan:</label>
                <input type="number" id="betAmount" value="100" min="10">
            </div>
            <button id="dealBtn">BAGIKAN KARTU</button>
        </div>

        <div class="messages">
            <p id="gameMessage">Memuat sesi pengguna...</p>
        </div>
    </div>

    <script>
      
      // ==============================================
//           KONFIGURASI SUPABASE
// ==============================================
const supabase = window.supabase.createClient(
    'https://vqmfachxnjyxwuavpgds.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
);

// ==============================================
//           ELEMEN DOM
// ==============================================
const playerNameSpan = document.getElementById('playerName');
const playerBalanceSpan = document.getElementById('playerBalance');
const logoutBtn = document.getElementById('logoutBtn');
const dealBtn = document.getElementById('dealBtn');
const betAmountInput = document.getElementById('betAmount');
const gameMessage = document.getElementById('gameMessage');

const dealerCardsContainer = document.getElementById('dealerCards');
const playerCardsContainer = document.getElementById('playerCards');
const dealerValueDisplay = document.getElementById('dealerValue');
const playerValueDisplay = document.getElementById('playerValue');

// <<< ELEMEN AUDIO >>>
const dealCardSound = document.getElementById('dealCardSound');
const winSound = document.getElementById('winSound');
const loseSound = document.getElementById('loseSound');
const drawSound = document.getElementById('drawSound');
const backgroundMusic = document.getElementById('backgroundMusic');

// ==============================================
//           VARIABEL GAME
// ==============================================
let currentUser = null;
let playerBalance = 0;
let isDealing = false; // Untuk mencegah klik ganda saat animasi berjalan

// Representasi kartu domino: [atas, bawah]
const dominoCards = [
    [0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6],
    [1,1], [1,2], [1,3], [1,4], [1,5], [1,6],
    [2,2], [2,3], [2,4], [2,5], [2,6],
    [3,3], [3,4], [3,5], [3,6],
    [4,4], [4,5], [4,6],
    [5,5], [5,6],
    [6,6]
];

// Array untuk menyimpan posisi titik-titik yang akan dibuat
const dotPositions = [
    'top-left', 'top-center', 'top-right',
    'mid-center-top', // Untuk angka 5 di sisi atas (titik tengahnya)
    'bottom-left', 'bottom-center', 'bottom-right',
    'mid-center-bottom' // Untuk angka 5 di sisi bawah (titik tengahnya)
];

// ==============================================
//           FUNGSI BANTUAN UI & GAME
// ==============================================

function updateBalanceDisplay() {
    playerBalanceSpan.textContent = playerBalance;
}

function disableGameControls() {
    dealBtn.disabled = true;
    betAmountInput.disabled = true;
}

function enableGameControls() {
    dealBtn.disabled = false;
    betAmountInput.disabled = false;
}

// Menghitung nilai tangan Qiu Qiu (modulo 10)
function calculateHandValue(cards) {
    if (cards.length === 0) return 0;
    const totalDots = cards.reduce((sum, card) => sum + card[0] + card[1], 0);
    // Dalam Qiu Qiu, nilai tertinggi adalah 9.
    // Jika total 10 atau 20, nilainya 0. Jika total 19 atau 29, nilainya 9.
    // Ini sudah diatasi dengan modulo 10
    return totalDots % 10;
}

// ==============================================
//           LOGIKA SUPABASE
// ==============================================

async function loadUserData(userId) {
    const { data, error } = await supabase
        .from('users_data')
        .select('*')
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') {
        console.error('Error loading user data:', error.message);
        gameMessage.textContent = 'Error loading user data. Please refresh or contact support.';
        disableGameControls();
        return;
    }

    if (data) {
        playerBalance = data.saldo;
        playerNameSpan.textContent = data.username || currentUser.email.split('@')[0];
        gameMessage.textContent = 'Selamat datang kembali!';
        enableGameControls();
    } else {
        const initialBalance = 1000;
        const defaultUsername = currentUser.email.split('@')[0];
        const { data: newUserData, error: insertError } = await supabase
            .from('users_data')
            .insert({ user_id: userId, saldo: initialBalance, username: defaultUsername })
            .select()
            .single();

        if (insertError) {
            console.error('Error initializing new user data:', insertError.message);
            gameMessage.textContent = 'Error initializing your account. Please try again.';
            disableGameControls();
            return;
        }
        playerBalance = newUserData.saldo;
        playerNameSpan.textContent = newUserData.username;
        gameMessage.textContent = `Selamat datang, ${newUserData.username}! Anda menerima ${initialBalance} Credits!`;
        enableGameControls();
    }
    updateBalanceDisplay();
}

async function updateUserData(newBalance) {
    if (!currentUser) {
        console.error('No current user to update data for.');
        gameMessage.textContent = 'Error: Not logged in to save saldo.';
        return;
    }

    const { error } = await supabase
        .from('users_data')
        .update({ saldo: newBalance })
        .eq('user_id', currentUser.id);

    if (error) {
        console.error('Error updating user saldo:', error.message);
        gameMessage.textContent = 'Error saving saldo. Please refresh.';
    } else {
        console.log('Saldo updated successfully!');
    }
}

async function initializeGame() {
    gameMessage.textContent = 'Memuat sesi pengguna...';
    disableGameControls();

    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
        currentUser = user;
        gameMessage.textContent = 'Pengguna ditemukan. Memuat data pemain...';
        await loadUserData(user.id);
        logoutBtn.style.display = 'inline-block';

        backgroundMusic.volume = 0.3;
        try {
            await backgroundMusic.play();
        } catch (e) {
            console.warn("Background music autoplay blocked. User interaction needed.", e);
        }

    } else {
        gameMessage.textContent = 'Anda belum login. Silakan kunjungi halaman login/registrasi untuk bermain.';
        playerNameSpan.textContent = 'Tamu';
        playerBalanceSpan.textContent = 'N/A';
        logoutBtn.style.display = 'none';
    }
}

logoutBtn.addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    if (error) {
        console.error('Logout error:', error.message);
        gameMessage.textContent = 'Logout gagal.';
    } else {
        currentUser = null;
        playerBalance = 0;
        updateBalanceDisplay();
        playerNameSpan.textContent = 'Tamu';
        gameMessage.textContent = 'Anda telah logout. Silakan login kembali untuk bermain.';
        disableGameControls();
        logoutBtn.style.display = 'none';
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
    }
});

// ==============================================
//           LOGIKA GAME UTAMA
// ==============================================

function resetTable() {
    dealerCardsContainer.innerHTML = ''; // Kosongkan kontainer
    playerCardsContainer.innerHTML = ''; // Kosongkan kontainer
    // Tambahkan kembali kartu back awal
    dealerCardsContainer.innerHTML = '<div class="card back"></div><div class="card back"></div>';
    playerCardsContainer.innerHTML = '<div class="card back"></div><div class="card back"></div>';

    dealerValueDisplay.textContent = '';
    playerValueDisplay.textContent = '';
    gameMessage.textContent = 'Siap untuk putaran berikutnya!';
}

async function dealCards() {
    if (isDealing || !currentUser) {
        if (!currentUser) gameMessage.textContent = "Silakan login untuk bermain!";
        return;
    }

    const betAmount = parseInt(betAmountInput.value);
    if (isNaN(betAmount) || betAmount < 10) { // Taruhan minimum 10
        gameMessage.textContent = "Masukkan jumlah taruhan yang valid (min 10).";
        return;
    }

    if (playerBalance < betAmount) {
        gameMessage.textContent = "Saldo tidak cukup! Silakan top up atau kurangi taruhan Anda.";
        return;
    }

    isDealing = true;
    disableGameControls();
    resetTable(); // Reset tampilan meja
    gameMessage.textContent = "Mengocok kartu...";

    // Potong saldo pemain untuk taruhan
    playerBalance -= betAmount;
    updateBalanceDisplay();
    await updateUserData(playerBalance);

    // <<< MAIN BACKGROUND MUSIC IF NOT ALREADY PLAYING >>>
    if (backgroundMusic.paused) {
        backgroundMusic.volume = 0.3;
        backgroundMusic.play().catch(e => console.warn("Background music autoplay blocked again.", e));
    }


    const shuffledDeck = shuffle(dominoCards);
    let playerHand = [];
    let dealerHand = [];

    // Clear existing cards first before dealing new ones for animation
    dealerCardsContainer.innerHTML = '';
    playerCardsContainer.innerHTML = '';

    // Deal 2 kartu ke pemain
    for (let i = 0; i < 2; i++) {
        await animateDealCard(playerCardsContainer, shuffledDeck.pop());
        playerHand.push(playerCardsContainer.children[i].cardData); // Dapatkan data kartu dari elemen yang baru dibuat
        dealCardSound.currentTime = 0; // Reset sound for quick successive plays
        dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
        await new Promise(r => setTimeout(r, 400)); // Jeda antar kartu
    }

    // Deal 2 kartu ke bandar
    for (let i = 0; i < 2; i++) {
        await animateDealCard(dealerCardsContainer, shuffledDeck.pop());
        dealerHand.push(dealerCardsContainer.children[i].cardData); // Dapatkan data kartu dari elemen yang baru dibuat
        dealCardSound.currentTime = 0;
        dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
        await new Promise(r => setTimeout(r, 400)); // Jeda antar kartu
    }

    await new Promise(r => setTimeout(r, 1000)); // Jeda setelah semua kartu dibagikan

    gameMessage.textContent = "Menghitung nilai tangan...";

    // Ungkap kartu pemain dan hitung nilai
    await revealHand(playerCardsContainer, playerHand, playerValueDisplay);
    await new Promise(r => setTimeout(r, 500)); // Jeda sebelum bandar mengungkap

    // Ungkap kartu bandar dan hitung nilai
    await revealHand(dealerCardsContainer, dealerHand, dealerValueDisplay);

    const playerValue = calculateHandValue(playerHand);
    const dealerValue = calculateHandValue(dealerHand);

    let winAmount = 0;
    let message = "";

    // Logika penentuan pemenang untuk 2 kartu (nilai tertinggi modulo 10)
    // Dalam Qiu Qiu, nilai 9 adalah "Qiu", 0 adalah "kosong" (bisa juga tertinggi jika tidak ada 9)
    // Bandar menang jika nilai sama, kecuali kedua-duanya 9.
    // Jika kedua-duanya 9, pemain menang (ini aturan standar Qiu Qiu)

    if (playerValue === 9 && dealerValue !== 9) { // Pemain 9, bandar bukan 9
        message = `QIU QIU! ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount * 2} Credits!`; // Payout 2x (total 3x bet)
        winAmount = betAmount * 3;
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (dealerValue === 9 && playerValue !== 9) { // Bandar 9, pemain bukan 9
        message = `BANDAR QIU QIU! ANDA KALAH! ${dealerValue} vs ${playerValue}. Anda kalah ${betAmount} Credits.`;
        winAmount = 0;
        loseSound.play().catch(e => console.warn("Lose sound failed:", e));
    } else if (playerValue === 9 && dealerValue === 9) { // Keduanya 9, pemain menang
        message = `QIU QIU KEMBAR! ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount * 2} Credits!`; // Payout 2x (total 3x bet)
        winAmount = betAmount * 3;
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (playerValue > dealerValue) { // Pemain nilai lebih tinggi (bukan 9)
        message = `ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount} Credits.`;
        winAmount = betAmount * 2; // Taruhan dikembalikan + kemenangan
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (dealerValue >= playerValue) { // Bandar nilai lebih tinggi atau seri (bandar menang jika seri)
        message = `BANDAR MENANG! ${dealerValue} vs ${playerValue}. Anda kalah ${betAmount} Credits.`;
        winAmount = 0; // Pemain kalah taruhan
        loseSound.play().catch(e => console.warn("Lose sound failed:", e));
    } else { // Ini seharusnya tidak tercapai jika logika di atas benar
        message = `Terjadi kesalahan.`;
        winAmount = 0;
        loseSound.play().catch(e => console.warn("Error sound failed:", e));
    }


    playerBalance += winAmount;
    updateBalanceDisplay();
    await updateUserData(playerBalance);

    gameMessage.textContent = message;
    isDealing = false;
    enableGameControls();
}

// Fungsi pengocok kartu Fisher-Yates
function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// Animasi pembagian kartu dan penempatan ke container
async function animateDealCard(container, cardData) {
    const cardElement = document.createElement('div');
    cardElement.classList.add('card', 'back');
    container.appendChild(cardElement);

    // Simpan data kartu di elemen DOM untuk diakses nanti
    // Penting untuk CSS-only cards: tambahkan data atribut
    cardElement.cardData = cardData; // Simpan juga data aslinya
    cardElement.dataset.value1 = Math.min(cardData[0], cardData[1]); // Pastikan yang kecil di value1
    cardElement.dataset.value2 = Math.max(cardData[0], cardData[1]); // Pastikan yang besar di value2

    // Tambahkan elemen dot ke dalam kartu
    // Setiap kartu punya 8 posisi dot, kita tampilkan/sembunyikan dengan CSS
    for (let i = 0; i < 8; i++) {
        const dot = document.createElement('div');
        dot.classList.add('dot');
        // Memberi kelas posisi agar CSS bisa mengatur penampilannya
        if (i === 0) dot.classList.add('top-left');
        else if (i === 1) dot.classList.add('top-center');
        else if (i === 2) dot.classList.add('top-right');
        else if (i === 3) dot.classList.add('mid-center-top');
        else if (i === 4) dot.classList.add('bottom-left');
        else if (i === 5) dot.classList.add('bottom-center');
        else if (i === 6) dot.classList.add('bottom-right');
        else if (i === 7) dot.classList.add('mid-center-bottom');
        cardElement.appendChild(dot);
    }
}

// Mengungkap kartu (membalik dan menampilkan nilai)
async function revealHand(container, hand, valueDisplayElement) {
    const cardElements = container.querySelectorAll('.card');
    for (let i = 0; i < hand.length; i++) {
        const cardElement = cardElements[i];

        // Hapus kelas 'back' untuk menampilkan titik
        cardElement.classList.remove('back');

        await new Promise(r => setTimeout(r, 300)); // Jeda antara reveal kartu
    }
    valueDisplayElement.textContent = `Nilai: ${calculateHandValue(hand)}`;
}

// ==============================================
//           INISIALISASI
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
    initializeGame();
    resetTable(); // Pastikan meja dalam keadaan reset saat load
});

dealBtn.addEventListener('click', dealCards);

    </script>
</body>
</html>
