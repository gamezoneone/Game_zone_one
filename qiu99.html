<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domino Qiu Qiu - Pemain vs Bandar</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  
  body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #0a0a0a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden; /* Prevent scrolling */
    color: #fff;
    text-shadow: 0 0 0.2rem rgba(255, 255, 255, 0.4);
    box-sizing: border-box;
}

.game-container {
    background: linear-gradient(145deg, #1a0a30, #3a1a50); /* Background ungu gelap */
    border: 0.2rem solid #a020f0; /* Purple neon */
    border-radius: 1.5rem;
    padding: 1rem; /* Kurangi padding */
    box-shadow:
        inset 0 0 1.5rem rgba(160, 32, 240, 0.5),
        0 0 3rem rgba(160, 32, 240, 0.7),
        0 0 1.8rem rgba(0, 255, 255, 0.5);
    text-align: center;
    width: 98%; /* Sedikit lebih lebar */
    max-width: 600px; /* Lebar maksimum yang lebih kecil */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    min-height: 90vh; /* Memastikan cukup tinggi untuk konten */
}

header {
    width: 100%;
    margin-bottom: 0.8rem; /* Kurangi margin */
    position: relative;
    z-index: 2;
}

h1 {
    font-size: 2.2rem; /* Perkecil font */
    color: #ffcc00; /* Neon kuning */
    text-shadow: 0 0 0.3rem #ffcc00, 0 0 0.6rem #ffcc00, 0 0 0.9rem #ffcc00, 0 0 1.2rem #ff0000;
    margin: 0 auto;
    padding: 0.2rem 0;
    letter-spacing: 0.08rem;
    position: relative;
    display: inline-block;
}

.player-info {
    font-size: 0.8rem; /* Perkecil font */
    margin-top: 0.6rem; /* Kurangi margin */
    color: #00ffff;
    text-shadow: 0 0 0.2rem #00ffff;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    gap: 0.4rem; /* Kurangi gap */
    padding: 0.4rem 0.8rem; /* Kurangi padding */
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 0.4rem;
    border: 1px solid rgba(0, 255, 255, 0.5);
    box-shadow: inset 0 0 0.3rem rgba(0, 255, 255, 0.3);
}
.player-info p {
    margin: 0;
    line-height: 1.2;
}

.control-btn {
    background: linear-gradient(135deg, #007bff, #00c6ff);
    font-size: 0.7rem; /* Perkecil font */
    padding: 0.3rem 0.6rem; /* Kurangi padding */
    border: none;
    border-radius: 0.3rem;
    box-shadow: 0 0 0.4rem rgba(0, 123, 255, 0.6);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
}
.control-btn:hover {
    background: linear-gradient(135deg, #00c6ff, #007bff);
    box-shadow: 0 0 0.6rem rgba(0, 123, 255, 0.8);
    transform: translateY(-0.05rem);
}


.game-table {
    background: linear-gradient(to bottom, #006400, #008000); /* Dark green felt */
    border: 0.2rem solid #a020f0;
    border-radius: 50%;
    width: 90%;
    max-width: 400px; /* Ukuran meja lebih kecil */
    height: 400px; /* Ukuran meja lebih kecil */
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    position: relative;
    margin: 1rem 0; /* Kurangi margin */
    box-shadow: inset 0 0 1.5rem rgba(0, 0, 0, 0.3), 0 0 0.8rem rgba(160, 32, 240, 0.5);
    flex-shrink: 0;
}

.game-table::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 0.2rem solid #00ffff; /* Neon cyan, lebih tipis */
    border-radius: 50%;
    box-shadow: 0 0 0.8rem #00ffff, 0 0 1.5rem rgba(0, 255, 255, 0.6);
    z-index: 0;
}


.player-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.3rem; /* Kurangi gap */
    width: 10%;
   /* background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.6rem; /* Lebih kecil */
    padding: 0.4rem; /* Kurangi padding */
   /* border: 1px solid rgba(255, 255, 0, 0.5);
    /*box-shadow: inset 0 0 0.4rem rgba(255, 255, 0, 0.3);
}

.player-label {
    font-size: 1rem; /* Perkecil font */
    font-weight: bold;
    color: #ffcc00;
    text-shadow: 0 0 0.3rem #ffcc00;
}

.cards-container {
    display: flex;
    justify-content: center;
    gap: 0.2rem; /* Kurangi gap */
    height: 80px; /* Tinggi untuk dua kartu yang lebih kecil */
    perspective: 1000px;
}

/* ============================================== */
/* DOMINO CARD STYLING (IMAGE BASED)            */
/* ============================================== */
.card {
    width: 55px; /* Lebar kartu lebih kecil */
    height: 80px; /* Tinggi kartu lebih kecil */
    border: 1px solid #333; /* Border kartu */
    border-radius: 5px; /* Sudut kartu lebih kecil */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); /* Shadow lebih kecil */
    position: relative;
    overflow: hidden;
    background-size: cover; /* Pastikan gambar mengisi kartu */
    background-position: center;
    background-repeat: no-repeat;
    transition: transform 0.5s ease-out;
    transform-style: preserve-3d;
}

.card.back {
    /* Background image untuk kartu belakang akan diatur di JavaScript */
    background-color: #555; /* Fallback color */
}

.card:not(.back) {
    /* Background image untuk kartu depan akan diatur di JavaScript */
    background-color: #f7f7f7; /* Fallback color */
}


.hand-value {
    font-size: 1.1rem; /* Perkecil font */
    font-weight: bold;
    color: #99ff33;
    text-shadow: 0 0 0.3rem #99ff33;
    min-height: 1.3rem; /* Menyesuaikan ruang */
}


.controls {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.6rem; /* Kurangi gap */
    width: 100%;
    margin-top: 0.8rem; /* Kurangi margin */
}

.bet-control {
    display: flex;
    align-items: center;
    gap: 0.4rem; /* Kurangi gap */
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.4rem;
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(153, 255, 51, 0.5);
    box-shadow: inset 0 0 0.3rem rgba(153, 255, 51, 0.3);
}

.bet-control label {
    font-size: 0.9rem; /* Perkecil font */
    color: #99ff33;
    text-shadow: 0 0 0.3rem #99ff33;
}

.bet-control input {
    width: 70px; /* Lebar input lebih kecil */
    padding: 0.5rem 0.7rem; /* Kurangi padding */
    border-radius: 0.3rem;
    border: 0.1rem solid #66ffff;
    background-color: #0d1217;
    color: #fff;
    font-size: 0.9rem; /* Perkecil font */
    text-align: center;
    box-shadow: inset 0 0 0.4rem rgba(102, 255, 255, 0.4);
    outline: none;
}
.bet-control input:focus {
    border-color: #ff00ff;
    box-shadow: inset 0 0 0.6rem rgba(255, 0, 255, 0.6);
}

button {
    background: linear-gradient(135deg, #ff00ff, #8a2be2);
    color: #fff;
    padding: 0.7rem 1.2rem; /* Kurangi padding */
    border: none;
    border-radius: 0.6rem;
    font-size: 1.2rem; /* Perkecil font */
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 0.8rem rgba(255, 0, 255, 0.7), 0 0 0.5rem rgba(138, 43, 226, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.07rem;
    text-shadow: 0 0 0.1rem rgba(0,0,0,0.5);
    width: 90%;
    max-width: 220px; /* Lebar tombol lebih kecil */
}

button:hover {
    background: linear-gradient(135deg, #8a2be2, #ff00ff);
    box-shadow: 0 0 1.2rem rgba(255, 0, 255, 0.9), 0 0 0.8rem rgba(138, 43, 226, 0.7);
    transform: translateY(-0.1rem);
}

button:active {
    transform: translateY(0);
    box-shadow: 0 0 0.3rem rgba(255, 0, 255, 0.5);
}

button:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.7;
}

.messages {
    margin-top: 0.8rem; /* Kurangi margin */
    font-size: 0.9rem; /* Perkecil font */
    color: #00ff00;
    text-shadow: 0 0 0.4rem #00ff00;
    min-height: 1.8rem; /* Menyesuaikan ruang */
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.4rem;
    padding: 0.4rem;
    border: 1px solid rgba(0, 255, 0, 0.5);
    width: 100%;
    box-sizing: border-box;
}

/* Media Queries untuk Responsivitas */
@media (max-width: 600px) {
    h1 {
        font-size: 2rem;
    }
    .game-table {
        width: 320px;
        height: 320px;
        max-width: 320px;
        max-height: 320px;
    }
    .player-label {
        font-size: 0.9rem;
    }
    .card {
        width: 50px;
        height: 75px;
    }
    .hand-value {
        font-size: 1rem;
    }
    button {
        font-size: 1.1rem;
        padding: 0.5rem 0.8rem;
    }
    .messages {
        font-size: 0.8rem;
    }
}

@media (max-width: 400px) {
    .game-table {
        width: 280px;
        height: 280px;
        max-width: 280px;
        max-height: 280px;
    }
    .card {
        width: 45px;
        height: 68px;
    }
}

</style>
</head>
<body>
    <audio id="dealCardSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/deal_card_sound.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/win_sound.mp3" preload="auto"></audio>
    <audio id="loseSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/lose_sound.mp3" preload="auto"></audio>
    <audio id="drawSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/draw_sound.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" preload="auto" loop></audio>


    <div class="game-container">
        <header>
            <h1>Domino Qiu Qiu</h1>
            <div class="player-info">
                <p>Player: <span id="playerName">Loading...</span></p>
                <p>Balance: <span id="playerBalance">0</span> Credits</p>
                <button id="logoutBtn" class="control-btn" style="display: none;">Logout</button>
            </div>
        </header>

        <div class="game-table">
            <div class="dealer-area player-box">
                <div class="player-label">BANDAR</div>
                <div class="cards-container" id="dealerCards">
                    <div class="card back"></div>
                    <div class="card back"></div>
                </div>
                <div class="hand-value" id="dealerValue"></div>
            </div>

            <div class="player-area player-box">
                <div class="player-label"></div>
                <div class="cards-container" id="playerCards">
                    <div class="card back"></div>
                    <div class="card back"></div>
                </div>
                <div class="hand-value" id="playerValue"></div>
            </div>
        </div>

        <div class="controls">
            <div class="bet-control">
                <label for="betAmount">Taruhan:</label>
                <input type="number" id="betAmount" value="100" min="10">
            </div>
            <button id="dealBtn">BAGIKAN KARTU</button>
        </div>

        <div class="messages">
            <p id="gameMessage">Memuat sesi pengguna...</p>
        </div>
    </div>

<script>

        const supabase = window.supabase.createClient(
            'https://vqmfachxnjyxwuavpgds.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
        );

        let user; 
        let userSaldo = 0;
        let userId = null; 

const playerNameSpan = document.getElementById('playerName');
const playerBalanceSpan = document.getElementById('playerBalance');
const logoutBtn = document.getElementById('logoutBtn');
const dealBtn = document.getElementById('dealBtn');
const betAmountInput = document.getElementById('betAmount');
const gameMessage = document.getElementById('gameMessage');

const dealerCardsContainer = document.getElementById('dealerCards');
const playerCardsContainer = document.getElementById('playerCards');
const dealerValueDisplay = document.getElementById('dealerValue');
const playerValueDisplay = document.getElementById('playerValue');

// <<< ELEMEN AUDIO >>>
const dealCardSound = document.getElementById('dealCardSound');
const winSound = document.getElementById('winSound');
const loseSound = document.getElementById('loseSound');
const drawSound = document.getElementById('drawSound');
const backgroundMusic = document.getElementById('backgroundMusic');


const CARD_IMAGE_BASE_URL = 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/domino99/';
const BACK_CARD_IMAGE_URL = CARD_IMAGE_BASE_URL + 'back.png';

const dominoCards = [
    [0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6],
    [1,1], [1,2], [1,3], [1,4], [1,5], [1,6],
    [2,2], [2,3], [2,4], [2,5], [2,6],
    [3,3], [3,4], [3,5], [3,6],
    [4,4], [4,5], [4,6],
    [5,5], [5,6],
    [6,6]
];


function getCardImageUrl(cardData) {

    const val1 = Math.min(cardData[0], cardData[1]);
    const val2 = Math.max(cardData[0], cardData[1]);
    return `${CARD_IMAGE_BASE_URL}domino99_${val1}_${val2}.png`; // Asumsikan format nama file domino_0_0.png
}




function updateBalanceDisplay() {
    playerBalanceSpan.textContent = playerBalance;
}

function disableGameControls() {
    dealBtn.disabled = true;
    betAmountInput.disabled = true;
}

function enableGameControls() {
    dealBtn.disabled = false;
    betAmountInput.disabled = false;
}

function calculateHandValue(cards) {
    if (cards.length === 0) return 0;
    const totalDots = cards.reduce((sum, card) => sum + card[0] + card[1], 0);

    return totalDots % 10;
}



async function loadUserData(userId) {
    const { data, error } = await supabase
        .from('users_data')
        .select('*')
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') {
        console.error('Error loading user data:', error.message);
        gameMessage.textContent = 'Error loading user data. Please refresh or contact support.';
        disableGameControls();
        return;
    }

    if (data) {
        playerBalance = data.saldo;
        playerNameSpan.textContent = data.username || currentUser.email.split('@')[0];
        gameMessage.textContent = 'Selamat datang kembali!';
        enableGameControls();
    } else {
        const initialBalance = 1000;
        const defaultUsername = currentUser.email.split('@')[0];
        const { data: newUserData, error: insertError } = await supabase
            .from('users_data')
            .insert({ user_id: userId, saldo: initialBalance, username: defaultUsername })
            .select()
            .single();

        if (insertError) {
            console.error('Error initializing new user data:', insertError.message);
            gameMessage.textContent = 'Error initializing your account. Please try again.';
            disableGameControls();
            return;
        }
        playerBalance = newUserData.saldo;
        playerNameSpan.textContent = newUserData.username;
        gameMessage.textContent = `Selamat datang, ${newUserData.username}! Anda menerima ${initialBalance} Credits!`;
        enableGameControls();
    }
    updateBalanceDisplay();
}

async function updateUserData(newBalance) {
    if (!currentUser) {
        console.error('No current user to update data for.');
        gameMessage.textContent = 'Error: Not logged in to save saldo.';
        return;
    }

    const { error } = await supabase
        .from('users_data')
        .update({ saldo: newBalance })
        .eq('user_id', currentUser.id);

    if (error) {
        console.error('Error updating user saldo:', error.message);
        gameMessage.textContent = 'Error saving saldo. Please refresh.';
    } else {
        console.log('Saldo updated successfully!');
    }
}

async function initializeGame() {
    gameMessage.textContent = 'Memuat sesi pengguna...';
    disableGameControls();

    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
        currentUser = user;
        gameMessage.textContent = 'Pengguna ditemukan. Memuat data pemain...';
        await loadUserData(user.id);
        logoutBtn.style.display = 'inline-block';

        backgroundMusic.volume = 0.3;
        try {
            await backgroundMusic.play();
        } catch (e) {
            console.warn("Background music autoplay blocked. User interaction needed.", e);
        }

    } else {
        gameMessage.textContent = 'Anda belum login. Silakan kunjungi halaman login/registrasi untuk bermain.';
        playerNameSpan.textContent = 'Tamu';
        playerBalanceSpan.textContent = 'N/A';
        logoutBtn.style.display = 'none';
    }
}

logoutBtn.addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    if (error) {
        console.error('Logout error:', error.message);
        gameMessage.textContent = 'Logout gagal.';
    } else {
        currentUser = null;
        playerBalance = 0;
        updateBalanceDisplay();
        playerNameSpan.textContent = 'Tamu';
        gameMessage.textContent = 'Anda telah logout. Silakan login kembali untuk bermain.';
        disableGameControls();
        logoutBtn.style.display = 'none';
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
    }
});

// ==============================================
//           LOGIKA GAME UTAMA
// ==============================================

function resetTable() {
    dealerCardsContainer.innerHTML = '';
    playerCardsContainer.innerHTML = '';
    // Menambahkan kembali kartu back awal dengan background-image
    dealerCardsContainer.innerHTML = `<div class="card back" style="background-image: url('${BACK_CARD_IMAGE_URL}');"></div><div class="card back" style="background-image: url('${BACK_CARD_IMAGE_URL}');"></div>`;
    playerCardsContainer.innerHTML = `<div class="card back" style="background-image: url('${BACK_CARD_IMAGE_URL}');"></div><div class="card back" style="background-image: url('${BACK_CARD_IMAGE_URL}');"></div>`;

    dealerValueDisplay.textContent = '';
    playerValueDisplay.textContent = '';
    gameMessage.textContent = 'Siap untuk putaran berikutnya!';
}

async function dealCards() {
    if (isDealing || !currentUser) {
        if (!currentUser) gameMessage.textContent = "Silakan login untuk bermain!";
        return;
    }

    const betAmount = parseInt(betAmountInput.value);
    if (isNaN(betAmount) || betAmount < 10) { // Taruhan minimum 10
        gameMessage.textContent = "Masukkan jumlah taruhan yang valid (min 10).";
        return;
    }

    if (playerBalance < betAmount) {
        gameMessage.textContent = "Saldo tidak cukup! Silakan top up atau kurangi taruhan Anda.";
        return;
    }

    isDealing = true;
    disableGameControls();
    resetTable(); // Reset tampilan meja
    gameMessage.textContent = "Mengocok kartu...";

    // Potong saldo pemain untuk taruhan
    playerBalance -= betAmount;
    updateBalanceDisplay();
    await updateUserData(playerBalance);

    // <<< MAIN BACKGROUND MUSIC IF NOT ALREADY PLAYING >>>
    if (backgroundMusic.paused) {
        backgroundMusic.volume = 0.3;
        backgroundMusic.play().catch(e => console.warn("Background music autoplay blocked again.", e));
    }

    const shuffledDeck = shuffle(dominoCards);
    let playerHand = [];
    let dealerHand = [];

    // Clear existing cards first before dealing new ones for animation
    dealerCardsContainer.innerHTML = '';
    playerCardsContainer.innerHTML = '';

    // Deal 2 kartu ke pemain
    for (let i = 0; i < 2; i++) {
        const cardData = shuffledDeck.pop();
        await animateDealCard(playerCardsContainer, cardData);
        playerHand.push(cardData); // Simpan langsung data kartu yang dibagikan
        dealCardSound.currentTime = 0;
        dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
        await new Promise(r => setTimeout(r, 400)); // Jeda antar kartu
    }

    // Deal 2 kartu ke bandar
    for (let i = 0; i < 2; i++) {
        const cardData = shuffledDeck.pop();
        await animateDealCard(dealerCardsContainer, cardData);
        dealerHand.push(cardData); // Simpan langsung data kartu yang dibagikan
        dealCardSound.currentTime = 0;
        dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
        await new Promise(r => setTimeout(r, 400)); // Jeda antar kartu
    }

    await new Promise(r => setTimeout(r, 1000)); // Jeda setelah semua kartu dibagikan

    gameMessage.textContent = "Menghitung nilai tangan...";

    // Ungkap kartu pemain dan hitung nilai
    await revealHand(playerCardsContainer, playerHand, playerValueDisplay);
    await new Promise(r => setTimeout(r, 500)); // Jeda sebelum bandar mengungkap

    // Ungkap kartu bandar dan hitung nilai
    await revealHand(dealerCardsContainer, dealerHand, dealerValueDisplay);

    const playerValue = calculateHandValue(playerHand);
    const dealerValue = calculateHandValue(dealerHand);

    let winAmount = 0;
    let message = "";

    // Logika penentuan pemenang untuk 2 kartu (nilai tertinggi modulo 10)
    if (playerValue === 9 && dealerValue !== 9) { // Pemain 9, bandar bukan 9
        message = `QIU QIU! ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount * 2} Credits!`;
        winAmount = betAmount * 3; // Saldo + 2x bet (total 3x)
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (dealerValue === 9 && playerValue !== 9) { // Bandar 9, pemain bukan 9
        message = `BANDAR QIU QIU! ANDA KALAH! ${dealerValue} vs ${playerValue}. Anda kalah ${betAmount} Credits.`;
        winAmount = 0; // Pemain kalah taruhan
        loseSound.play().catch(e => console.warn("Lose sound failed:", e));
    } else if (playerValue === 9 && dealerValue === 9) { // Keduanya 9, pemain menang (Aturan umum Qiu Qiu)
        message = `QIU QIU KEMBAR! ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount * 2} Credits!`;
        winAmount = betAmount * 3; // Saldo + 2x bet (total 3x)
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (playerValue > dealerValue) { // Pemain nilai lebih tinggi (bukan 9)
        message = `ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount} Credits.`;
        winAmount = betAmount * 2; // Taruhan dikembalikan + kemenangan
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (dealerValue >= playerValue) { // Bandar nilai lebih tinggi atau seri (bandar menang jika seri)
        message = `BANDAR MENANG! ${dealerValue} vs ${playerValue}. Anda kalah ${betAmount} Credits.`;
        winAmount = 0; // Pemain kalah taruhan
        loseSound.play().catch(e => console.warn("Lose sound failed:", e));
    } else { // Ini seharusnya tidak tercapai jika logika di atas benar
        message = `Terjadi kesalahan.`;
        winAmount = 0;
        loseSound.play().catch(e => console.warn("Error sound failed:", e));
    }

    playerBalance += winAmount;
    updateBalanceDisplay();
    await updateUserData(playerBalance);

    gameMessage.textContent = message;
    isDealing = false;
    enableGameControls();
}

// Fungsi pengocok kartu Fisher-Yates
function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// Animasi pembagian kartu dan penempatan ke container
async function animateDealCard(container, cardData) {
    const cardElement = document.createElement('div');
    cardElement.classList.add('card', 'back');
    // Set background-image untuk kartu belakang
    cardElement.style.backgroundImage = `url('${BACK_CARD_IMAGE_URL}')`;
    container.appendChild(cardElement);

    // Simpan data kartu di elemen DOM untuk diakses nanti
    cardElement.cardData = cardData;

    // Tidak perlu menambahkan elemen dot, karena sekarang menggunakan gambar
}

// Mengungkap kartu (membalik dan menampilkan nilai)
async function revealHand(container, hand, valueDisplayElement) {
    const cardElements = container.querySelectorAll('.card');
    for (let i = 0; i < hand.length; i++) {
        const cardElement = cardElements[i];
        const cardData = hand[i];
        const imageUrl = getCardImageUrl(cardData);

        // Langsung ganti background-image kartu
        cardElement.style.backgroundImage = `url('${imageUrl}')`;

        // Hapus kelas 'back' (opsional, tapi baik untuk kejelasan)
        cardElement.classList.remove('back');

        await new Promise(r => setTimeout(r, 300)); // Jeda antara reveal kartu
    }
    valueDisplayElement.textContent = `Nilai: ${calculateHandValue(hand)}`;
}

// ==============================================
//           INISIALISASI
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
    initializeGame();
    resetTable(); // Pastikan meja dalam keadaan reset saat load
});

dealBtn.addEventListener('click', dealCards);

</script>
</body>
</html>
