<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domino Qiu Qiu - Pemain vs Bandar</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body {
    margin: 0;
    font-family: 'Arial', sans-serif;
    background-color: #0a0a0a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden; /* Prevent scrolling */
    color: #fff;
    text-shadow: 0 0 0.2rem rgba(255, 255, 255, 0.4);
    box-sizing: border-box;
}

.game-container {
    background: linear-gradient(145deg, #1a0a30, #3a1a50); /* Background ungu gelap */
    border: 0.2rem solid #a020f0; /* Purple neon */
    border-radius: 1.5rem;
    padding: 1.5rem;
    box-shadow:
        inset 0 0 1.5rem rgba(160, 32, 240, 0.5),
        0 0 3rem rgba(160, 32, 240, 0.7),
        0 0 1.8rem rgba(0, 255, 255, 0.5);
    text-align: center;
    width: 95%;
    max-width: 700px; /* Lebar maksimum untuk layar yang lebih besar */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    min-height: 90vh; /* Memastikan cukup tinggi untuk konten */
}

header {
    width: 100%;
    margin-bottom: 1rem;
    position: relative;
    z-index: 2;
}

h1 {
    font-size: 2.8rem;
    color: #ffcc00; /* Neon kuning */
    text-shadow: 0 0 0.4rem #ffcc00, 0 0 0.8rem #ffcc00, 0 0 1.2rem #ffcc00, 0 0 1.8rem #ff0000;
    margin: 0 auto;
    padding: 0.3rem 0;
    letter-spacing: 0.1rem;
    position: relative;
    display: inline-block;
}

.player-info {
    font-size: 0.9rem;
    margin-top: 0.8rem;
    color: #00ffff;
    text-shadow: 0 0 0.3rem #00ffff;
    display: flex;
    flex-wrap: wrap; /* Untuk responsivitas */
    justify-content: space-around;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
    border: 1px solid rgba(0, 255, 255, 0.5);
    box-shadow: inset 0 0 0.4rem rgba(0, 255, 255, 0.3);
}
.player-info p {
    margin: 0;
    line-height: 1.2;
}

.control-btn {
    background: linear-gradient(135deg, #007bff, #00c6ff);
    font-size: 0.8rem;
    padding: 0.4rem 0.7rem;
    border: none;
    border-radius: 0.4rem;
    box-shadow: 0 0 0.5rem rgba(0, 123, 255, 0.6);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
}
.control-btn:hover {
    background: linear-gradient(135deg, #00c6ff, #007bff);
    box-shadow: 0 0 0.7rem rgba(0, 123, 255, 0.8);
    transform: translateY(-0.05rem);
}


.game-table {
    background: linear-gradient(to bottom, #006400, #008000); /* Dark green felt */
    border: 0.2rem solid #a020f0;
    border-radius: 50%; /* Bentuk meja bulat */
    width: 90%;
    max-width: 450px; /* Ukuran meja */
    height: 450px;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    position: relative;
    margin: 1.5rem 0; /* Memberi ruang di atas dan bawah */
    box-shadow: inset 0 0 2rem rgba(0, 0, 0, 0.8), 0 0 1rem rgba(160, 32, 240, 0.5);
    flex-shrink: 0; /* Jangan biarkan menyusut */
}

/* Garis neon di tepi meja */
.game-table::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 0.3rem solid #00ffff; /* Neon cyan */
    border-radius: 50%;
    box-shadow: 0 0 1rem #00ffff, 0 0 2rem rgba(0, 255, 255, 0.6);
    z-index: 0;
}


.player-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    height: 30%;
    width: 30%; /* Lebar area pemain/bandar di dalam meja */
    background-color: rgba(0, 0, 0, 0.0);
    border-radius: 0.8rem;
    padding: 0.5rem;
    border: 1px solid rgba(255, 255, 0, 0.0);
    box-shadow: inset 0 0 0.5rem rgba(255, 255, 0, 0.0);
}


.player-label {
    font-size: 1.1rem;
    font-weight: bold;
    color: #ffcc00;
    text-shadow: 0 0 0.3rem #ffcc00;
}

.cards-container {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    height: 90px; /* Tinggi untuk dua kartu */
    perspective: 1000px; /* Untuk animasi flip 3D */
}

/* ============================================== */
/* DOMINO CARD STYLING (CSS ONLY)       */
/* ============================================== */
.card {
    width: 60px; /* Lebar kartu */
    height: 90px; /* Tinggi kartu */
    border: 2px solid #333; /* Border kartu */
    border-radius: 6px; /* Sudut kartu */
    background-color: #f7f7f7; /* Warna dasar kartu (putih gading) */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    padding: 5px;
    box-sizing: border-box;
    transition: transform 0.5s ease-out; /* Untuk animasi deal/flip */
    transform-style: preserve-3d;
}

.card.back {
    background-color: gold; /* Warna belakang kartu */
    background-image: linear-gradient(45deg, red 25%, transparent 25%, transparent 75%, red 75%, red),
                      linear-gradient(45deg, red 25%, transparent 25%, transparent 75%, red 75%, red);
    background-size: 10px 10px; /* Ukuran pola */
    background-position: 0 0, 5px 5px; /* Offset pola */
    border: 1px solid #aaa;
}

/* Bagian tengah kartu (garis pemisah) */
.card:not(.back)::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    height: 2px; /* Tebal garis */
    background-color: #333; /* Warna garis */
    transform: translateY(-50%);
    z-index: 1;
}

/* Dot styling */
.dot {
    position: absolute;
    width: 8px; /* Ukuran dot */
    height: 8px;
    background-color: #333; /* Warna dot */
    border-radius: 50%;
    z-index: 2; /* Pastikan dot di atas garis */
}

/* Positioning for top half (value1) */
.card[data-value1="0"] .dot.top-center { display: none; }
.card[data-value1="1"] .dot.top-center { top: 15px; left: 50%; transform: translateX(-50%); }
.card[data-value1="2"] .dot.top-left { top: 10px; left: 10px; }
.card[data-value1="2"] .dot.bottom-right { top: 30px; right: 10px; }
.card[data-value1="3"] .dot.top-left { top: 10px; left: 10px; }
.card[data-value1="3"] .dot.top-center { top: 15px; left: 50%; transform: translateX(-50%); }
.card[data-value1="3"] .dot.bottom-right { top: 30px; right: 10px; }
.card[data-value1="4"] .dot.top-left { top: 10px; left: 10px; }
.card[data-value1="4"] .dot.top-right { top: 10px; right: 10px; }
.card[data-value1="4"] .dot.bottom-left { top: 30px; left: 10px; }
.card[data-value1="4"] .dot.bottom-right { top: 30px; right: 10px; }
.card[data-value1="5"] .dot.top-left { top: 10px; left: 10px; }
.card[data-value1="5"] .dot.top-right { top: 10px; right: 10px; }
.card[data-value1="5"] .dot.mid-center-top { top: 20px; left: 50%; transform: translateX(-50%); } /* new dot */
.card[data-value1="5"] .dot.bottom-left { top: 30px; left: 10px; }
.card[data-value1="5"] .dot.bottom-right { top: 30px; right: 10px; }
.card[data-value1="6"] .dot.top-left { top: 10px; left: 10px; }
.card[data-value1="6"] .dot.top-center { top: 10px; left: 50%; transform: translateX(-50%); } /* new dot */
.card[data-value1="6"] .dot.top-right { top: 10px; right: 10px; }
.card[data-value1="6"] .dot.bottom-left { top: 30px; left: 10px; }
.card[data-value1="6"] .dot.bottom-center { top: 30px; left: 50%; transform: translateX(-50%); } /* new dot */
.card[data-value1="6"] .dot.bottom-right { top: 30px; right: 10px; }


/* Positioning for bottom half (value2) */
.card[data-value2="0"] .dot.bottom-center { display: none; }
.card[data-value2="1"] .dot.bottom-center { bottom: 15px; left: 50%; transform: translateX(-50%); }
.card[data-value2="2"] .dot.bottom-left { bottom: 10px; left: 10px; }
.card[data-value2="2"] .dot.top-right { bottom: 30px; right: 10px; } /* relative to bottom half */
.card[data-value2="3"] .dot.bottom-left { bottom: 10px; left: 10px; }
.card[data-value2="3"] .dot.bottom-center { bottom: 15px; left: 50%; transform: translateX(-50%); }
.card[data-value2="3"] .dot.top-right { bottom: 30px; right: 10px; }
.card[data-value2="4"] .dot.top-left { bottom: 30px; left: 10px; } /* relative to bottom half */
.card[data-value2="4"] .dot.top-right { bottom: 30px; right: 10px; }
.card[data-value2="4"] .dot.bottom-left { bottom: 10px; left: 10px; }
.card[data-value2="4"] .dot.bottom-right { bottom: 10px; right: 10px; }
.card[data-value2="5"] .dot.top-left { bottom: 30px; left: 10px; }
.card[data-value2="5"] .dot.top-right { bottom: 30px; right: 10px; }
.card[data-value2="5"] .dot.mid-center-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); } /* new dot */
.card[data-value2="5"] .dot.bottom-left { bottom: 10px; left: 10px; }
.card[data-value2="5"] .dot.bottom-right { bottom: 10px; right: 10px; }
.card[data-value2="6"] .dot.top-left { bottom: 30px; left: 10px; }
.card[data-value2="6"] .dot.top-center { bottom: 30px; left: 50%; transform: translateX(-50%); } /* new dot */
.card[data-value2="6"] .dot.top-right { bottom: 30px; right: 10px; }
.card[data-value2="6"] .dot.bottom-left { bottom: 10px; left: 10px; }
.card[data-value2="6"] .dot.bottom-center { bottom: 10px; left: 50%; transform: translateX(-50%); } /* new dot */
.card[data-value2="6"] .dot.bottom-right { bottom: 10px; right: 10px; }


/* Sembunyikan semua dot secara default */
.dot { display: none; }

/* Tampilkan dot berdasarkan kelas posisi */
.dot.top-left { }
.dot.top-center { }
.dot.top-right { }
.dot.mid-center-top { }
.dot.bottom-left { }
.dot.bottom-center { }
.dot.bottom-right { }
.dot.mid-center-bottom { } /* For the bottom half center dot */


/* Tambahkan kelas dot ke dalam card container untuk posisi yang umum */
.card:not(.back) .dot { display: block; }


.hand-value {
    font-size: 1.3rem;
    font-weight: bold;
    color: #99ff33;
    text-shadow: 0 0 0.4rem #99ff33;
    min-height: 1.5rem; /* Untuk menahan ruang sebelum nilai muncul */
}


.controls {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.8rem;
    width: 100%;
    margin-top: 1rem;
}

.bet-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid rgba(153, 255, 51, 0.5);
    box-shadow: inset 0 0 0.4rem rgba(153, 255, 51, 0.3);
}

.bet-control label {
    font-size: 1rem;
    color: #99ff33;
    text-shadow: 0 0 0.4rem #99ff33;
}
.bet-control input {
    width: 80px;
    padding: 0.6rem 0.8rem;
    border-radius: 0.4rem;
    border: 0.1rem solid #66ffff;
    background-color: #0d1217;
    color: #fff;
    font-size: 1rem;
    text-align: center;
    box-shadow: inset 0 0 0.5rem rgba(102, 255, 255, 0.4);
    outline: none;
}
.bet-control input:focus {
    border-color: #ff00ff;
    box-shadow: inset 0 0 0.7rem rgba(255, 0, 255, 0.6);
}

button {
    background: linear-gradient(135deg, #ff00ff, #8a2be2);
    color: #fff;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 0.7rem;
    font-size: 1.4rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 1rem rgba(255, 0, 255, 0.7), 0 0 0.6rem rgba(138, 43, 226, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.08rem;
    text-shadow: 0 0 0.2rem rgba(0,0,0,0.5);
    width: 90%;
    max-width: 250px;
}

button:hover {
    background: linear-gradient(135deg, #8a2be2, #ff00ff);
    box-shadow: 0 0 1.5rem rgba(255, 0, 255, 0.9), 0 0 1rem rgba(138, 43, 226, 0.7);
    transform: translateY(-0.1rem);
}

button:active {
    transform: translateY(0);
    box-shadow: 0 0 0.4rem rgba(255, 0, 255, 0.5);
}

button:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
    opacity: 0.7;
}

.messages {
    margin-top: 1rem;
    font-size: 1rem;
    color: #00ff00;
    text-shadow: 0 0 0.5rem #00ff00;
    min-height: 2rem;
    background-color: rgba(0, 0, 0, 0.4);
    border-radius: 0.5rem;
    padding: 0.5rem;
    border: 1px solid rgba(0, 255, 0, 0.5);
    width: 100%;
    box-sizing: border-box;
}

/* Media Queries untuk Responsivitas */
@media (max-width: 600px) {
    h1 {
        font-size: 2.2rem;
    }
    .game-table {
        width: 350px;
        height: 350px;
        max-width: 350px;
        max-height: 350px;
    }
    .player-label {
        font-size: 1rem;
    }
    .card {
        width: 50px;
        height: 75px;
    }
    .hand-value {
        font-size: 1.1rem;
    }
    button {
        font-size: 1.2rem;
        padding: 0.6rem 1rem;
    }
    .messages {
        font-size: 0.9rem;
    }
}

@media (max-width: 400px) {
    .game-table {
        width: 300px;
        height: 300px;
        max-width: 300px;
        max-height: 300px;
    }
    .card {
        width: 45px;
        height: 68px;
    }
}
</style>
</head>
<body>
    <audio id="dealCardSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/deal_card_sound.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/win_sound.mp3" preload="auto"></audio>
    <audio id="loseSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/lose_sound.mp3" preload="auto"></audio>
    <audio id="drawSound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music/draw_sound.mp3" preload="auto"></audio>
    <audio id="backgroundMusic" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" preload="auto" loop></audio>


    <div class="game-container">
        <header>
            <h1>Domino Qiu Qiu</h1>
            <div class="player-info">
                <p>Player: <span id="playerName">Loading...</span></p>
                <p>Balance: <span id="playerBalance">0</span> Credits</p>
                <button id="logoutBtn" class="control-btn" style="display: none;">Logout</button>
            </div>
        </header>

        <div class="game-table">
            <div class="dealer-area player-box">
                <div class="player-label">BANDAR</div>
                <div class="cards-container" id="dealerCards">
                    <div class="card back"></div>
                    <div class="card back"></div>
                </div>
                <div class="hand-value" id="dealerValue"></div>
            </div>

            <div class="player-area player-box">
                <div class="player-label"></div>
                <div class="cards-container" id="playerCards">
                    <div class="card back"></div>
                    <div class="card back"></div>
                </div>
                <div class="hand-value" id="playerValue"></div>
            </div>
        </div>

        <div class="controls">
            <div class="bet-control">
                <label for="betAmount">Taruhan:</label>
                <input type="number" id="betAmount" value="100" min="10">
            </div>
            <button id="dealBtn">BAGIKAN KARTU</button>
        </div>

        <div class="messages">
            <p id="gameMessage">Memuat sesi pengguna...</p>
        </div>
    </div>

    <script>
      
      const supabase = window.supabase.createClient(
    'https://vqmfachxnjyxwuavpgds.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
);

// ==============================================
//           ELEMEN DOM
// ==============================================
const playerNameSpan = document.getElementById('playerName');
const playerBalanceSpan = document.getElementById('playerBalance');
const logoutBtn = document.getElementById('logoutBtn');
const dealBtn = document.getElementById('dealBtn');
const betAmountInput = document.getElementById('betAmount');
const gameMessage = document.getElementById('gameMessage');

const dealerCardsContainer = document.getElementById('dealerCards');
const playerCardsContainer = document.getElementById('playerCards');
const dealerValueDisplay = document.getElementById('dealerValue');
const playerValueDisplay = document.getElementById('playerValue');

// <<< ELEMEN AUDIO >>>
const dealCardSound = document.getElementById('dealCardSound');
const winSound = document.getElementById('winSound');
const loseSound = document.getElementById('loseSound');
const drawSound = document.getElementById('drawSound');
const backgroundMusic = document.getElementById('backgroundMusic');

// ==============================================
//           VARIABEL GAME
// ==============================================
let currentUser = null;
let playerBalance = 0;
let isDealing = false; // Untuk mencegah klik ganda saat animasi berjalan

// Representasi kartu domino: [atas, bawah]
const dominoCards = [
    [0,0], [0,1], [0,2], [0,3], [0,4], [0,5], [0,6],
    [1,1], [1,2], [1,3], [1,4], [1,5], [1,6],
    [2,2], [2,3], [2,4], [2,5], [2,6],
    [3,3], [3,4], [3,5], [3,6],
    [4,4], [4,5], [4,6],
    [5,5], [5,6],
    [6,6]
];

// Array untuk menyimpan posisi titik-titik yang akan dibuat
const dotPositions = [
    'top-left', 'top-center', 'top-right',
    'mid-center-top', // Untuk angka 5 di sisi atas
    'bottom-left', 'bottom-center', 'bottom-right',
    'mid-center-bottom' // Untuk angka 5 di sisi bawah
];

// ==============================================
//           FUNGSI BANTUAN UI & GAME
// ==============================================

function updateBalanceDisplay() {
    playerBalanceSpan.textContent = playerBalance;
}

function disableGameControls() {
    dealBtn.disabled = true;
    betAmountInput.disabled = true;
}

function enableGameControls() {
    dealBtn.disabled = false;
    betAmountInput.disabled = false;
}

// Menghitung nilai tangan Qiu Qiu (modulo 10)
function calculateHandValue(cards) {
    if (cards.length === 0) return 0;
    const totalDots = cards.reduce((sum, card) => sum + card[0] + card[1], 0);
    // Qiu Qiu: nilai tertinggi adalah 9.
    // Jika total 19 atau 29, nilainya 9.
    // Jika total 10 atau 20, nilainya 0.
    // Ini sudah diatasi dengan modulo 10
    return totalDots % 10;
}

// ==============================================
//           LOGIKA SUPABASE
// ==============================================

async function loadUserData(userId) {
    const { data, error } = await supabase
        .from('users_data')
        .select('*')
        .eq('user_id', userId)
        .single();

    if (error && error.code !== 'PGRST116') {
        console.error('Error loading user data:', error.message);
        gameMessage.textContent = 'Error loading user data. Please refresh or contact support.';
        disableGameControls();
        return;
    }

    if (data) {
        playerBalance = data.saldo;
        playerNameSpan.textContent = data.username || currentUser.email.split('@')[0];
        gameMessage.textContent = 'Selamat datang kembali!';
        enableGameControls();
    } else {
        const initialBalance = 1000;
        const defaultUsername = currentUser.email.split('@')[0];
        const { data: newUserData, error: insertError } = await supabase
            .from('users_data')
            .insert({ user_id: userId, saldo: initialBalance, username: defaultUsername })
            .select()
            .single();

        if (insertError) {
            console.error('Error initializing new user data:', insertError.message);
            gameMessage.textContent = 'Error initializing your account. Please try again.';
            disableGameControls();
            return;
        }
        playerBalance = newUserData.saldo;
        playerNameSpan.textContent = newUserData.username;
        gameMessage.textContent = `Selamat datang, ${newUserData.username}! Anda menerima ${initialBalance} Credits!`;
        enableGameControls();
    }
    updateBalanceDisplay();
}

async function updateUserData(newBalance) {
    if (!currentUser) {
        console.error('No current user to update data for.');
        gameMessage.textContent = 'Error: Not logged in to save saldo.';
        return;
    }

    const { error } = await supabase
        .from('users_data')
        .update({ saldo: newBalance })
        .eq('user_id', currentUser.id);

    if (error) {
        console.error('Error updating user saldo:', error.message);
        gameMessage.textContent = 'Error saving saldo. Please refresh.';
    } else {
        console.log('Saldo updated successfully!');
    }
}

async function initializeGame() {
    gameMessage.textContent = 'Memuat sesi pengguna...';
    disableGameControls();

    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
        currentUser = user;
        gameMessage.textContent = 'Pengguna ditemukan. Memuat data pemain...';
        await loadUserData(user.id);
        logoutBtn.style.display = 'inline-block';

        backgroundMusic.volume = 0.3;
        try {
            await backgroundMusic.play();
        } catch (e) {
            console.warn("Background music autoplay blocked. User interaction needed.", e);
        }

    } else {
        gameMessage.textContent = 'Anda belum login. Silakan kunjungi halaman login/registrasi untuk bermain.';
        playerNameSpan.textContent = 'Tamu';
        playerBalanceSpan.textContent = 'N/A';
        logoutBtn.style.display = 'none';
    }
}

logoutBtn.addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    if (error) {
        console.error('Logout error:', error.message);
        gameMessage.textContent = 'Logout gagal.';
    } else {
        currentUser = null;
        playerBalance = 0;
        updateBalanceDisplay();
        playerNameSpan.textContent = 'Tamu';
        gameMessage.textContent = 'Anda telah logout. Silakan login kembali untuk bermain.';
        disableGameControls();
        logoutBtn.style.display = 'none';
        backgroundMusic.pause();
        backgroundMusic.currentTime = 0;
    }
});

// ==============================================
//           LOGIKA GAME UTAMA
// ==============================================

function resetTable() {
    dealerCardsContainer.innerHTML = '<div class="card back"></div><div class="card back"></div>';
    playerCardsContainer.innerHTML = '<div class="card back"></div><div class="card back"></div>';
    dealerValueDisplay.textContent = '';
    playerValueDisplay.textContent = '';
    gameMessage.textContent = 'Siap untuk putaran berikutnya!';
}

async function dealCards() {
    if (isDealing || !currentUser) {
        if (!currentUser) gameMessage.textContent = "Silakan login untuk bermain!";
        return;
    }

    const betAmount = parseInt(betAmountInput.value);
    if (isNaN(betAmount) || betAmount < 10) { // Taruhan minimum 10
        gameMessage.textContent = "Masukkan jumlah taruhan yang valid (min 10).";
        return;
    }

    if (playerBalance < betAmount) {
        gameMessage.textContent = "Saldo tidak cukup! Silakan top up atau kurangi taruhan Anda.";
        return;
    }

    isDealing = true;
    disableGameControls();
    resetTable(); // Reset tampilan meja
    gameMessage.textContent = "Mengocok kartu...";

    // Potong saldo pemain untuk taruhan
    playerBalance -= betAmount;
    updateBalanceDisplay();
    await updateUserData(playerBalance);

    // <<< MAIN BACKGROUND MUSIC IF NOT ALREADY PLAYING >>>
    if (backgroundMusic.paused) {
        backgroundMusic.volume = 0.3;
        backgroundMusic.play().catch(e => console.warn("Background music autoplay blocked again.", e));
    }


    const shuffledDeck = shuffle(dominoCards);
    let playerHand = [];
    let dealerHand = [];

    // Deal 2 kartu ke pemain dan bandar
    // Kartu pertama pemain
    await animateDealCard(playerCardsContainer, shuffledDeck.pop());
    playerHand.push(playerCardsContainer.lastChild.cardData);
    dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
    await new Promise(r => setTimeout(r, 500)); // Jeda antar kartu

    // Kartu pertama bandar
    await animateDealCard(dealerCardsContainer, shuffledDeck.pop());
    dealerHand.push(dealerCardsContainer.lastChild.cardData);
    dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
    await new Promise(r => setTimeout(r, 500));

    // Kartu kedua pemain
    await animateDealCard(playerCardsContainer, shuffledDeck.pop());
    playerHand.push(playerCardsContainer.lastChild.cardData);
    dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
    await new Promise(r => setTimeout(r, 500));

    // Kartu kedua bandar
    await animateDealCard(dealerCardsContainer, shuffledDeck.pop());
    dealerHand.push(dealerCardsContainer.lastChild.cardData);
    dealCardSound.play().catch(e => console.warn("Deal sound failed:", e));
    await new Promise(r => setTimeout(r, 1000)); // Jeda setelah semua kartu dibagikan

    gameMessage.textContent = "Menghitung nilai tangan...";

    // Ungkap kartu dan hitung nilai
    await revealHand(playerCardsContainer, playerHand, playerValueDisplay);
    await revealHand(dealerCardsContainer, dealerHand, dealerValueDisplay);

    const playerValue = calculateHandValue(playerHand);
    const dealerValue = calculateHandValue(dealerHand);

    let winAmount = 0;
    let message = "";

    // Logika penentuan pemenang (Qiu Qiu)
    // Aturan yang lebih spesifik untuk Qiu Qiu:
    // Pemenang ditentukan oleh nilai tertinggi. Jika nilai sama, pemenang adalah yang memiliki kartu balak (double) tertinggi.
    // Jika tidak ada balak, maka pemenang adalah yang memiliki nilai tertinggi pada satu sisi kartu (misal 5-6 vs 4-7, total sama 11/1, tapi 6 > 7 kalah)

    // Untuk saat ini, kita hanya membandingkan nilai total modulo 10
    if (playerValue > dealerValue) {
        message = `ANDA MENANG! ${playerValue} vs ${dealerValue}. Anda memenangkan ${betAmount} Credits.`;
        winAmount = betAmount * 2; // Taruhan dikembalikan + kemenangan
        winSound.play().catch(e => console.warn("Win sound failed:", e));
    } else if (dealerValue > playerValue) {
        message = `BANDAR MENANG! ${dealerValue} vs ${playerValue}. Anda kalah ${betAmount} Credits.`;
        winAmount = 0; // Pemain kalah taruhan
        loseSound.play().catch(e => console.warn("Lose sound failed:", e));
    } else { // Seri
        message = `SERI! ${playerValue} vs ${dealerValue}. Taruhan Anda dikembalikan.`;
        winAmount = betAmount; // Taruhan dikembalikan
        drawSound.play().catch(e => console.warn("Draw sound failed:", e));
    }
    playerBalance += winAmount;
    updateBalanceDisplay();
    await updateUserData(playerBalance);

    gameMessage.textContent = message;
    isDealing = false;
    enableGameControls();
}

// Fungsi pengocok kartu Fisher-Yates
function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
}

// Animasi pembagian kartu dan penempatan ke container
async function animateDealCard(container, cardData) {
    const cardElement = document.createElement('div');
    cardElement.classList.add('card', 'back');
    container.appendChild(cardElement);

    // Simpan data kartu di elemen DOM untuk diakses nanti
    // Penting untuk CSS-only cards: tambahkan data atribut
    cardElement.dataset.value1 = Math.min(cardData[0], cardData[1]); // Pastikan yang kecil di value1
    cardElement.dataset.value2 = Math.max(cardData[0], cardData[1]); // Pastikan yang besar di value2

    // Tambahkan elemen dot ke dalam kartu
    // Setiap kartu punya 8 posisi dot, kita tampilkan/sembunyikan dengan CSS
    for (let i = 0; i < 8; i++) {
        const dot = document.createElement('div');
        dot.classList.add('dot');
        // Memberi kelas posisi agar CSS bisa mengatur penampilannya
        if (i === 0) dot.classList.add('top-left');
        else if (i === 1) dot.classList.add('top-center');
        else if (i === 2) dot.classList.add('top-right');
        else if (i === 3) dot.classList.add('mid-center-top'); // Untuk 5 di atas
        else if (i === 4) dot.classList.add('bottom-left');
        else if (i === 5) dot.classList.add('bottom-center');
        else if (i === 6) dot.classList.add('bottom-right');
        else if (i === 7) dot.classList.add('mid-center-bottom'); // Untuk 5 di bawah
        cardElement.appendChild(dot);
    }

    dealCardSound.currentTime = 0;
    dealCardSound.volume = 0.6;
    dealCardSound.play().catch(e => console.warn("Deal card sound playback failed:", e));

    await new Promise(r => setTimeout(r, 200));
}

// Mengungkap kartu (membalik dan menampilkan nilai)
async function revealHand(container, hand, valueDisplayElement) {
    const cardElements = container.querySelectorAll('.card');
    for (let i = 0; i < hand.length; i++) {
        const cardElement = cardElements[i];
        const cardData = hand[i];

        // Hapus kelas 'back' untuk menampilkan titik
        cardElement.classList.remove('back');

        // Card data sudah ada di cardElement.dataset yang dibuat di animateDealCard
        // cardElement.dataset.value1 = Math.min(cardData[0], cardData[1]);
        // cardElement.dataset.value2 = Math.max(cardData[0], cardData[1]);

        await new Promise(r => setTimeout(r, 300)); // Jeda antara reveal kartu
    }
    valueDisplayElement.textContent = `Nilai: ${calculateHandValue(hand)}`;
}

// ==============================================
//           INISIALISASI
// ==============================================
document.addEventListener('DOMContentLoaded', () => {
    initializeGame();
    resetTable(); // Pastikan meja dalam keadaan reset saat load
});

dealBtn.addEventListener('click', dealCards);

    </script>
</body>
</html>
