<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Pengguna - GameZone</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Gaya Umum */
        body, html {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .container {
            width: 95%;
            max-width: 800px;
            margin: 20px auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(57, 255, 20, 0.4);
            animation: glow 1.5s infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(57, 255, 20, 0.4); }
            to { box-shadow: 0 0 35px rgba(57, 255, 20, 0.7); }
        }

        h1, h2 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: #39ff14;
            text-shadow: 0 0 15px rgba(57, 255, 20, 0.7);
            margin-bottom: 25px;
        }

        h1 { font-size: 2.2em; }
        h2 { font-size: 1.6em; border-bottom: 2px solid #39ff14; padding-bottom: 10px; margin-top: 30px;}

        /* Saldo dan Tombol */
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        #saldo-display {
            font-size: 1.8em;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            margin-bottom: 20px;
            font-family: 'Orbitron', sans-serif;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(45deg, #007bff, #00c7ff);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
            text-transform: uppercase;
            font-weight: bold;
        }
        .btn:hover {
            background: linear-gradient(45deg, #0056b3, #0099e6);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.6);
        }
        .btn-history {
            background: linear-gradient(45deg, #28a745, #218838);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        .btn-history:hover {
            background: linear-gradient(45deg, #218838, #1e7e34);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: linear-gradient(135deg, #2a004a, #4a006a);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.6);
            max-width: 450px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h2 {
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
            margin-bottom: 20px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            color: #e0e0e0;
            text-align: left;
            font-weight: bold;
        }
        .modal-content input, .modal-content select {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 18px;
            border: 1px solid #6a006a;
            border-radius: 8px;
            background-color: #3a005a;
            color: #e0e0e0;
            font-size: 1em;
        }
        .modal-content input::placeholder {
            color: #b0b0b0;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.0em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-transform: uppercase;
            font-weight: bold;
        }
        .modal-buttons .primary {
            background: linear-gradient(45deg, #ff00ff, #8a2be2);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 0, 255, 0.4);
        }
        .modal-buttons .primary:hover {
            background: linear-gradient(45deg, #cc00cc, #6a1aae);
            transform: translateY(-2px);
        }
        .modal-buttons .secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }
        .modal-buttons .secondary:hover {
            background: linear-gradient(45deg, #5a6268, #3a4046);
            transform: translateY(-2px);
        }

        /* Histori Transaksi */
        .history-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
        }
        .history-section th, .history-section td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #444;
            font-size: 0.95em;
        }
        .history-section th {
            background: #39ff14;
            color: #1a1a2e;
            font-weight: bold;
            text-transform: uppercase;
        }
        .history-section tr:last-child td {
            border-bottom: none;
        }
        .history-section .empty {
            text-align: center;
            font-style: italic;
            color: #aaa;
            padding: 20px;
        }
        .status-pending { color: #ffa500; font-weight: bold; } /* Orange */
        .status-approved { color: #39ff14; font-weight: bold; } /* Green */
        .status-rejected { color: #ff4d4d; font-weight: bold; } /* Red */

        /* Game Display */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 25px;
            padding: 10px;
        }
        .game-item {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .game-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(57, 255, 20, 0.5);
        }
        .game-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
            border-radius: 10px; /* Adjust if needed for full image border-radius */
        }
        .game-item a {
            display: block;
            text-decoration: none;
            color: inherit;
        }

        /* Utility */
        .hidden { display: none; }
        .btn-copy {
            background: #00bcd4; /* Cyan */
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.85em;
            transition: background-color 0.3s ease;
        }
        .btn-copy:hover {
            background: #0097a7;
        }
        .copy-group {
            display: flex;
            align-items: center;
            margin-bottom: 18px;
        }
        .copy-group input {
            flex-grow: 1;
            margin-bottom: 0; /* Override default margin */
        }
        #form-qris {
            text-align: center;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        #gambar-qris {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4);
            margin-bottom: 15px;
        }
        #btn-kembali-ewallet {
            background: #f44336;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }
        #btn-kembali-ewallet:hover {
            background: #d32f2f;
        }

        /* Audio Controls (Optional) */
        audio {
            display: none; /* Hide default audio player */
        }
        .audio-controls {
            position: fixed;
            bottom: 15px;
            right: 15px;
            z-index: 1001;
        }
        .audio-toggle {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #39ff14;
            color: #39ff14;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.6);
            transition: all 0.3s ease;
        }
        .audio-toggle:hover {
            background: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.8);
        }
    </style>
</head>
<body>
    <audio id="background-music" loop>
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-futuristic-software-interface-tone-2537.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <audio id="click-sound">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-button-click-1122.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div class="container">
        <h1>GameZone</h1>

        <div class="profile-header">
            <p id="saldo-display">Saldo: Rp.0</p>
            <div class="action-buttons">
                <button class="btn" id="btn-deposit">Deposit</button>
                <button class="btn" id="btn-withdraw">Penarikan</button>
                <button class="btn btn-history" id="btn-history">Riwayat</button>
            </div>
        </div>

        <h2>Daftar Game</h2>
        <div class="game-grid" id="game-display-grid">
            </div>

    </div>

    <div id="modal-deposit" class="modal-overlay">
        <div class="modal-content">
            <h2>Deposit</h2>
            <label for="dep-nama">Nama Pengirim:</label>
            <input type="text" id="dep-nama" placeholder="Nama Anda" readonly>

            <label for="dep-email">Email Pengguna:</label>
            <input type="email" id="dep-email" placeholder="Email Anda" readonly>

            <label for="dep-nomor">Nomor Tujuan:</label>
            <div class="copy-group">
                <input type="text" id="dep-nomor" placeholder="Nomor E-Wallet/Bank Tujuan" readonly>
                <button class="btn-copy" data-target="dep-nomor">Salin</button>
            </div>

            <label for="dep-jumlah">Jumlah Deposit (Rp):</label>
            <input type="number" id="dep-jumlah" placeholder="Contoh: 50000" required>

            <div id="form-qris" style="display: none;">
                <label>Scan QRIS ini:</label>
                <img id="gambar-qris" src="" alt="QRIS Code">
            </div>

            <div class="modal-buttons">
                <button class="primary" id="dep-submit" data-metode="eWallet">Kirim</button>
                <button class="secondary" onclick="closeModal('modal-deposit')">Batal</button>
                <button class="secondary" id="btn-qris">QRIS</button>
                <button class="secondary" id="btn-kembali-ewallet">Kembali ke E-Wallet</button>
            </div>
        </div>
    </div>

    <div id="modal-withdraw" class="modal-overlay">
        <div class="modal-content">
            <h2>Penarikan Dana</h2>
            <label for="with-nama">Nama Penerima:</label>
            <input type="text" id="with-nama" placeholder="Nama Lengkap Anda" required>

            <label for="with-email">Email Pengguna:</label>
            <input type="email" id="with-email" placeholder="Email Anda" readonly>

            <label for="with-metode">Metode Penarikan:</label>
            <select id="with-metode" required>
                <option value="">Pilih Metode</option>
                <option value="OVO">OVO</option>
                <option value="DANA">DANA</option>
                <option value="Gopay">Gopay</option>
                <option value="Bank">Transfer Bank</option>
            </select>

            <label for="with-bank" id="label-bank" style="display: none;">Nama Bank:</label>
            <input type="text" id="with-bank" placeholder="Contoh: BCA / Mandiri" style="display: none;">

            <label for="with-nomor">Nomor Rekening/Ponsel:</label>
            <input type="text" id="with-nomor" placeholder="Nomor Rekening / Nomor Ponsel E-Wallet" required>

            <label for="with-jumlah">Jumlah Penarikan (Rp):</label>
            <input type="number" id="with-jumlah" placeholder="Minimum 50000" required>

            <div class="modal-buttons">
                <button class="primary" id="with-submit">Kirim</button>
                <button class="secondary" onclick="closeModal('modal-withdraw')">Batal</button>
            </div>
        </div>
    </div>

    <div id="modal-history" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h2>Riwayat Transaksi</h2>
            <h3>Deposit</h3>
            <div class="history-section">
                <table id="riwayat-deposit-modal">
                    <thead><tr><th>Tanggal</th><th>Jumlah</th><th>Status</th></tr></thead>
                    <tbody><tr><td colspan="3" class="empty">Memuat data...</td></tr></tbody>
                </table>
            </div>
            <h3>Penarikan</h3>
            <div class="history-section">
                <table id="riwayat-penarikan-modal">
                    <thead><tr><th>Tanggal</th><th>Jumlah</th><th>Status</th></tr></thead>
                    <tbody><tr><td colspan="3" class="empty">Memuat data...</td></tr></tbody>
                </table>
            </div>
            <div class="modal-buttons">
                <button class="primary" onclick="closeModal('modal-history')">Tutup</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // GANTI DENGAN URL SUPABASE ANDA DAN ANON KEY ANDA!
        const SUPABASE_URL = 'https://vqmfachxnjyxwuavpgds.supabase.co'; // Contoh: 'https://vqmfachxnjyxwuavpgds.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'; // Contoh: 'eyJhbGciOiJIUzI1NiI...'

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let uid = localStorage.getItem('uid');

        const backgroundMusic = document.getElementById('background-music');
        const clickSound = document.getElementById('click-sound');

        // Autoplay background music on first user interaction
        document.addEventListener('click', () => {
            if (backgroundMusic.paused) {
                backgroundMusic.play().catch(e => console.log("Autoplay blocked:", e));
            }
        }, { once: true });

        // Play click sound on button clicks
        document.querySelectorAll('.btn, .modal-content button, .game-item').forEach(button => {
            button.addEventListener('click', () => {
                clickSound.currentTime = 0;
                clickSound.play().catch(e => console.log("Click sound play blocked:", e));
            });
        });

        async function getCurrentUserEmail() {
          const { data: { user }, error } = await supabase.auth.getUser();
          if (error) {
            console.error('Error fetching user from Supabase auth:', error.message);
            return null;
          }

          if (user && uid !== user.id) {
              uid = user.id;
              localStorage.setItem('uid', user.id);
          }
          return user ? user.email : null;
        }

        document.addEventListener('DOMContentLoaded', () => {
          getCurrentUserEmail().then(() => {
            loadProfile();
            loadGames();
          }).catch(err => {
            console.error("Failed to initialize user session:", err);
            showModal('alert-modal', 'Sesi Pengguna Tidak Valid', 'Sesi pengguna tidak valid. Silakan login kembali.', () => {
              window.location.href = 'login.html';
            });
          });

          // Copy button functionality
          document.querySelectorAll('.btn-copy').forEach(button => {
            button.addEventListener('click', (event) => {
              const targetId = event.currentTarget.dataset.target;
              const inputElement = document.getElementById(targetId);
              if (inputElement) {
                inputElement.select();
                inputElement.setSelectionRange(0, 99999);
                try {
                  navigator.clipboard.writeText(inputElement.value)
                    .then(() => {
                      showModal('success-modal', 'Berhasil Disalin!', 'Nomor berhasil disalin: ' + inputElement.value);
                    })
                    .catch(err => {
                      console.error('Gagal menyalin teks: ', err);
                      showModal('error-modal', 'Gagal!', 'Gagal menyalin nomor. Silakan salin manual.');
                    });
                } catch (err) {
                  // Fallback for older browsers
                  document.execCommand('copy');
                  showModal('success-modal', 'Berhasil Disalin!', 'Nomor berhasil disalin: ' + inputElement.value);
                }
              }
            });
          });

          // Withdraw method change listener
          document.getElementById('with-metode').addEventListener('change', function() {
            const selectedMethod = this.value;
            const bankInput = document.getElementById('with-bank');
            const bankLabel = document.getElementById('label-bank');
            if (selectedMethod === 'Bank') {
              bankInput.style.display = 'block';
              bankLabel.style.display = 'block';
              bankInput.setAttribute('required', 'true');
            } else {
              bankInput.style.display = 'none';
              bankLabel.style.display = 'none';
              bankInput.removeAttribute('required');
              bankInput.value = '';
            }
          });
        });

        // Load user profile data (saldo, total_deposit, first_deposit)
        async function loadProfile() {
          if (!uid) {
              console.warn('UID tidak ditemukan. Tidak dapat memuat profil pengguna.');
              document.getElementById('saldo-display').textContent = 'Saldo: Rp.0 (Harap Login)';
              document.querySelector('#riwayat-deposit-modal tbody').innerHTML = '<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>';
              document.querySelector('#riwayat-penarikan-modal tbody').innerHTML = '<tr><td colspan="3" class="empty">Silakan login untuk melihat riwayat.</td></tr>';
              return;
          }

          // Fetch all necessary user data for profile display
          const { data: userData, error: userError } = await supabase
            .from('users_data')
            .select('saldo, total_deposit, first_deposit') // Select first_deposit here
            .eq('user_id', uid)
            .single();

          if (userError && userError.code !== 'PGRST116') {
            console.error('Error memuat data profil:', userError.message);
            showModal('error-modal', 'Error', 'Gagal memuat data profil: ' + userError.message);
            document.getElementById('saldo-display').textContent = `Saldo: Rp.0 (Error)`;
            return;
          } else if (userError && userError.code === 'PGRST116') {
              console.warn('Pengguna baru, membuat entri saldo awal...');
              document.getElementById('saldo-display').textContent = `Saldo: Rp.0 (Baru)`;
              const { error: insertError } = await supabase
                  .from('users_data')
                  .insert([{ user_id: uid, saldo: 0, total_deposit: 0, first_deposit: false }]); // Initialize new columns

              if (insertError) {
                  console.error('Error saat membuat entri saldo awal:', insertError.message);
                  showModal('error-modal', 'Error Inisialisasi', 'Gagal membuat entri saldo awal. Cek log.');
                  document.getElementById('saldo-display').textContent = `Saldo: Rp.0 (Error Inisialisasi)`;
              }

          } else {
              document.getElementById('saldo-display').textContent = `Saldo: Rp.${(userData.saldo ?? 0).toLocaleString('id-ID')}`;
              // Optional: Display first_deposit status to user
              // Example: if (userData.first_deposit) { /* show message */ } else { /* show message */ }
          }
        }
         // Load deposit/withdrawal history
        async function loadHistory(tableId, tableName) {
          const isDeposit = tableName === 'deposit_requests';
          const tableBody = document.querySelector(`#${tableId} tbody`);
          tableBody.innerHTML = '<tr><td colspan="3" class="empty">Memuat data...</td></tr>';

          const { data, error } = await supabase
            .from(tableName)
            .select('created_at, amount, status')
            .eq('user_id', uid)
            .order('created_at', { ascending: false });

          if (error) {
              console.error(`Error fetching ${tableName} history:`, error.message);
              tableBody.innerHTML = `<tr><td colspan="3" class="empty">Gagal memuat riwayat ${isDeposit ? 'deposit' : 'penarikan'}.</td></tr>`;
          } else if (!data || data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="3" class="empty">Belum ada riwayat ${isDeposit ? 'deposit' : 'penarikan'}.</td></tr>`;
          } else {
            tableBody.innerHTML = '';
            data.forEach(row => {
              const date = new Date(row.created_at).toLocaleString('id-ID');
              const statusClass = `status-${row.status}`;
              tableBody.innerHTML += `<tr><td>${date}</td><td>Rp${row.amount.toLocaleString('id-ID')}</td><td class="${statusClass}">${row.status.charAt(0).toUpperCase() + row.status.slice(1)}</td></tr>`;
            });
          }
        }

        // Generic modal handler
        function showModal(modalId, title, message, callback = null) {
            let modalElement;

            if (!document.getElementById('custom-alert-modal') && (modalId === 'alert-modal' || modalId === 'success-modal' || modalId === 'error-modal')) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = `
                    <div id="custom-alert-modal" class="modal-overlay">
                        <div class="modal-content">
                            <h2 id="custom-alert-title" style="font-family: 'Orbitron', sans-serif;"></h2>
                            <p id="custom-alert-message" style="text-align: center; margin-bottom: 25px; color: #ccc;"></p>
                            <div class="modal-buttons">
                                <button class="primary" id="custom-alert-ok-btn">OK</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(tempDiv.firstElementChild);
            }

            if (modalId === 'alert-modal' || modalId === 'success-modal' || modalId === 'error-modal') {
                modalElement = document.getElementById('custom-alert-modal');
                document.getElementById('custom-alert-title').textContent = title;
                document.getElementById('custom-alert-message').textContent = message;
                const okBtn = document.getElementById('custom-alert-ok-btn');
                okBtn.onclick = () => {
                    closeModal('custom-alert-modal');
                    if (callback) callback();
                };
                if (modalId === 'success-modal') {
                    document.getElementById('custom-alert-title').style.color = '#39ff14';
                    document.getElementById('custom-alert-title').style.textShadow = '0 0 10px rgba(57, 255, 20, 0.6)';
                } else if (modalId === 'error-modal') {
                    document.getElementById('custom-alert-title').style.color = '#ff4d4d';
                    document.getElementById('custom-alert-title').style.textShadow = '0 0 10px rgba(255, 77, 77, 0.6)';
                } else {
                    document.getElementById('custom-alert-title').style.color = '#ffeb3b';
                    document.getElementById('custom-alert-title').style.textShadow = '0 0 10px rgba(255, 235, 59, 0.6)';
                }

            } else {
                modalElement = document.getElementById(modalId);
            }

            if (modalElement) {
                modalElement.classList.add('active');
            }
        }
        
        // Close modal handler
        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                modalElement.classList.remove('active');
                if (modalId === 'modal-deposit') {
                    document.getElementById('dep-jumlah').value = '';
                    document.getElementById('form-qris').style.display = 'none';
                    document.getElementById('btn-kembali-ewallet').style.display = 'none';
                } else if (modalId === 'modal-withdraw') {
                    document.getElementById('with-nama').value = '';
                    document.getElementById('with-metode').value = '';
                    document.getElementById('with-nomor').value = '';
                    document.getElementById('with-jumlah').value = '';
                    document.getElementById('with-bank').style.display = 'none';
                    document.getElementById('label-bank').style.display = 'none';
                }
            }
        }
        // Deposit button logic
        document.getElementById('btn-deposit').onclick = async () => {
          if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan deposit.'); return; }
          showModal('modal-deposit');
          const userEmail = await getCurrentUserEmail();
          if (userEmail) {
            document.getElementById('dep-email').value = userEmail;
          }

          const { data, error } = await supabase
            .from('deposit_config')
            .select('*')
            .eq('metode', 'eWallet')
            .single();

          if (error || !data) {
            showModal('error-modal', 'Error', 'Gagal mengambil data eWallet.');
            return;
          }

          document.getElementById('dep-nama').value = data.nama;
          document.getElementById('dep-nomor').value = data.nomor;
          document.getElementById('dep-submit').dataset.metode = 'eWallet';
        };

        document.getElementById('btn-qris').onclick = async () => {
          const { data, error } = await supabase
            .from('deposit_config')
            .select('*')
            .eq('metode', 'QRIS')
            .single();

          if (error || !data) {
            showModal('error-modal', 'Error', 'Gagal mengambil data QRIS.');
            return;
          }

          document.getElementById('form-qris').style.display = 'block';
          document.getElementById('gambar-qris').src = data.qris_url;
          document.getElementById('dep-submit').dataset.metode = 'QRIS';
          document.getElementById('btn-kembali-ewallet').style.display = 'inline-block';
        };

        document.getElementById('btn-kembali-ewallet').onclick = async () => {
          const { data, error } = await supabase
            .from('deposit_config')
            .select('*')
            .eq('metode', 'eWallet')
            .single();

          if (error || !data) {
            showModal('error-modal', 'Error', 'Gagal mengambil data eWallet.');
            return;
          }

          document.getElementById('form-qris').style.display = 'none';
          document.getElementById('dep-nama').value = data.nama;
          document.getElementById('dep-nomor').value = data.nomor;
          document.getElementById('dep-submit').dataset.metode = 'eWallet';
          document.getElementById('btn-kembali-ewallet').style.display = 'none';
        };

        document.getElementById('dep-submit').onclick = async () => {
          if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan deposit.'); return; }
          const nama = document.getElementById('dep-nama').value;
          const email = document.getElementById('dep-email').value;
          const nomor = document.getElementById('dep-nomor').value;
          const jumlah = document.getElementById('dep-jumlah').value;
          const metode = document.getElementById('dep-submit').dataset.metode;

          if (!nama || !nomor || !jumlah || !email) {
            showModal('alert-modal', 'Peringatan', 'Lengkapi semua kolom.');
            return;
          }

          const depositTableBody = document.querySelector('#riwayat-deposit-modal tbody');
          const now = new Date();
          const dateString = now.toLocaleString('id-ID');
          const tempId = `temp-${Date.now()}`;
          const newRowHTML = `<tr class="pending-item" data-id="${tempId}"><td>${dateString}</td><td>Rp${parseInt(jumlah).toLocaleString('id-ID')}</td><td class="status-pending">Pending</td></tr>`;

          if (depositTableBody.querySelector('.empty')) {
            depositTableBody.innerHTML = '';
          }
          depositTableBody.insertAdjacentHTML('afterbegin', newRowHTML);


          const { error } = await supabase.from('deposit_requests').insert([
            { user_id: uid, nama, metode, amount: parseInt(jumlah), status: 'pending', email: email }
          ]);

          if (error) {
            console.error(error);
            showModal('error-modal', 'Gagal!', 'Gagal kirim deposit. Silakan coba lagi.');
            const tempRow = depositTableBody.querySelector(`[data-id="${tempId}"]`);
            if (tempRow) {
                tempRow.remove();
            }
          } else {
            showModal('success-modal', 'Berhasil!', 'Permintaan deposit dikirim.');
            closeModal('modal-deposit');
            loadProfile(); // Reload profile to update saldo
            loadHistory('riwayat-deposit-modal', 'deposit_requests');
          }
        };

        // Withdraw button logic (MODIFIED FOR SECURITY)
        document.getElementById('btn-withdraw').onclick = async () => {
          if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan penarikan.'); return; }
          showModal('modal-withdraw');
          const userEmail = await getCurrentUserEmail();
          if (userEmail) {
            document.getElementById('with-email').value = userEmail;
          }
        };

        // Submit withdrawal request (CALLS EDGE FUNCTION)
        document.getElementById('with-submit').onclick = async () => {
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melakukan penarikan.'); return; }

            const nama = document.getElementById('with-nama').value;
            const email = document.getElementById('with-email').value;
            const metode = document.getElementById('with-metode').value;
            const nomor = document.getElementById('with-nomor').value;
            const bank = document.getElementById('with-bank').value;
            const jumlah = parseInt(document.getElementById('with-jumlah').value);

            // Frontend validation (basic checks before sending to secure backend)
            if (!nama || !metode || !nomor || !jumlah) {
                showModal('alert-modal', 'Peringatan', 'Lengkapi semua kolom.');
                return;
            }
            if (metode === 'Bank' && !bank) {
                showModal('alert-modal', 'Peringatan', 'Nama Bank harus diisi untuk metode Transfer Bank.');
                return;
            }
            if (isNaN(jumlah) || jumlah <= 0) {
                showModal('alert-modal', 'Peringatan', 'Jumlah penarikan harus angka positif.');
                return;
            }

            // Prepare bank account info for the Edge Function
            const bankAccountInfo = {
                bank_name: metode === 'Bank' ? bank : metode,
                account_number: nomor,
                account_holder: nama,
                email: email
            };

            const withdrawTableBody = document.querySelector('#riwayat-penarikan-modal tbody');
            const now = new Date();
            const dateString = now.toLocaleString('id-ID');
            const tempId = `temp-${Date.now()}`;
            const newRowHTML = `<tr class="pending-item" data-id="${tempId}"><td>${dateString}</td><td>Rp${jumlah.toLocaleString('id-ID')}</td><td class="status-pending">Pending</td></tr>`;

            // Add pending row to history display immediately
            if (withdrawTableBody.querySelector('.empty')) {
                withdrawTableBody.innerHTML = '';
            }
            withdrawTableBody.insertAdjacentHTML('afterbegin', newRowHTML);

            try {
                // Get current user session for authentication token
                const session = await supabase.auth.getSession();
                if (!session.data.session) {
                    showModal('alert-modal', 'Sesi Tidak Valid', 'Sesi pengguna tidak valid. Silakan login kembali.');
                    // Remove pending row if session is invalid
                    const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                    if (tempRow) { tempRow.remove(); }
                    throw new Error('No active session.');
                }
                const accessToken = session.data.session.access_token;

                // GANTI DENGAN URL SUPABASE ANDA DAN NAMA EDGE FUNCTION PENARIKAN ANDA!
                // Pastikan nama Edge Function sesuai dengan yang Anda deploy (misal: 'processed_withdrawal')
                const edgeFunctionUrl = `${SUPABASE_URL}https://vqmfachxnjyxwuavpgds.supabase.co/functions/v1/processed_withdrawal`; // Contoh: 'https://vqmfachxnjyxwuavpgds.supabase.co/functions/v1/processed_withdrawal'

                // Send withdrawal request to the secure Edge Function
                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}` // Send auth token for secure validation
                    },
                    body: JSON.stringify({
                        amount: jumlah,
                        bank_account_info: bankAccountInfo
                    })
                });

                const data = await response.json(); // Parse response from Edge Function

                if (response.ok) { // If Edge Function returned a success status (HTTP 2xx)
                    showModal('success-modal', 'Berhasil!', data.message);
                    closeModal('modal-withdraw');
                    // Update saldo display with the new saldo returned by the Edge Function
                    if (data.new_saldo !== undefined) {
                        document.getElementById('saldo-display').textContent = `Saldo: Rp${data.new_saldo.toLocaleString('id-ID')}`;
                    } else {
                        // Fallback: if new_saldo is not in response, refresh profile to get latest saldo
                        loadProfile();
                    }
                    loadHistory('riwayat-penarikan-modal', 'withdraw_requests'); // Refresh withdrawal history
                } else { // If Edge Function returned an error status
                    showModal('error-modal', 'Gagal!', data.message || 'Terjadi kesalahan tidak dikenal.');
                    // Remove pending row as request failed
                    const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                    if (tempRow) { tempRow.remove(); }
                }
            } catch (error) {
                console.error('Error calling withdrawal API:', error);
                showModal('error-modal', 'Error Jaringan', 'Gagal terhubung ke server. Silakan coba lagi.');
                // Remove pending row if network error
                const tempRow = withdrawTableBody.querySelector(`[data-id="${tempId}"]`);
                if (tempRow) { tempRow.remove(); }
            }
        };

        // History button logic
        document.getElementById('btn-history').onclick = async () => {
            if (!uid) { showModal('alert-modal', 'Login Diperlukan', 'Anda harus login untuk melihat riwayat transaksi.'); return; }
            showModal('modal-history');
            await loadHistory('riwayat-deposit-modal', 'deposit_requests');
            await loadHistory('riwayat-penarikan-modal', 'withdraw_requests');
        };

        // Game list data
        const games = [
          { name: 'SLOT 77', url: 'slot.html', imageUrl: 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/zaus//Slot77.jpeg' },
          { name: 'POKER', url: 'poker1.html', imageUrl: 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/zaus//download.jpeg' },
          { name: 'TEBAK DADU', url: 'tebakdadu.html', imageUrl: 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/zaus//unnamed%20(1)%20(1)%20(1).png' },
          { name: 'SAMGONG', url: 'samgong1.html', imageUrl: 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/zaus//unnamed.png' },
          { name: 'SUSUN BALOK', url: 'susunbalok99.html', imageUrl: 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/zaus//images%20(2).jpeg' },
          { name: 'QIU QIU', url: 'qiu99.html', imageUrl: 'https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/zaus//download%20(4).jpeg' },
        ];

        // Load game list into display grid
        function loadGames() {
          const gameGridContainer = document.getElementById('game-display-grid');
          gameGridContainer.innerHTML = '';
          games.forEach(game => {
            const gameItem = document.createElement('div');
            gameItem.classList.add('game-item');
            gameItem.innerHTML = `
              <a href="${game.url}">
                <img src="${game.imageUrl}" alt="${game.name}">
              </a>
            `;
            gameGridContainer.appendChild(gameItem);
          });
        }

    </script>
</body>
</html>
