<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Neon - Mainkan Sekarang!</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
            body {
    margin: 0;
    padding: 0;
    background-color: #0a0a1a; /* Dark background */
    color: #e0f2f7; /* Light text */
    font-family: 'Press Start 2P', cursive; /* Contoh font retro-futuristic */
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden; /* Mencegah scroll horizontal body */
    position: relative;
    font-size: 16px; /* Default font size */
    box-sizing: border-box; /* Penting untuk perhitungan lebar */
}

/* Fallback for Press Start 2P if not loaded */
body {
    font-family: 'Arial Black', Gadget, sans-serif;
}

.game-container {
    background-color: #1a0a2a; /* Darker purple-ish */
    border: 3px solid #6a059f; /* Purple neon border */
    box-shadow: 0 0 15px #6a059f, 0 0 30px #6a059f, 0 0 45px #6a059f;
    border-radius: 15px;
    padding: 20px; /* Sedikit lebih kecil untuk ruang layar */
    width: 95%; /* Lebih responsif */
    max-width: 800px;
    box-sizing: border-box;
    position: relative;
    z-index: 10;
    margin: auto; /* Tambahkan margin atas/bawah untuk perangkat yang sangat pendek */
}

h1 {
    color: #00ffcc; /* Neon green */
    text-shadow: 0 0 10px #00ffcc, 0 0 20px #00ffcc, 0 0 30px #00ffcc;
    margin-bottom: 5px;
    font-size: 3em; /* Ukuran font adaptif */
}

.header-info {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-bottom: 20px;
    font-size: 1em;
    color: #ffcc00; /* Neon yellow */
    text-shadow: 0 0 5px #ffcc00;
    flex-wrap: wrap; /* Izinkan wrap pada layar kecil */
    gap: 10px; /* Jarak antar elemen */
}

.dashboard-link, #logout-button {
    color: #00ffff; /* Cyan neon */
    text-decoration: none;
    font-family: 'Press Start 2P', cursive;
    font-size: 0.8em;
    padding: 8px 12px;
    border: 1px solid #00ffff;
    border-radius: 5px;
    transition: all 0.2s ease;
    box-shadow: 0 0 5px #00ffff;
    background: none;
    cursor: pointer;
}

.dashboard-link:hover, #logout-button:hover {
    background-color: #00ffff;
    color: #0a0a1a;
    box-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
}


.roulette-wheel-area {
    margin: 20px auto;
    width: 200px; /* Ukuran roda default lebih kecil */
    height: 200px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
}

.wheel-outer {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: radial-gradient(circle at center, #330033 0%, #0d0d1a 100%);
    border: 5px solid #ff00ff; /* Neon pink */
    box-shadow: 0 0 15px #ff00ff, 0 0 30px #ff00ff;
    display: flex;
    justify-content: center;
    align-items: center;
}

.wheel-inner {
    width: 80%;
    height: 80%;
    border-radius: 50%;
    background-color: #0d0d;
    border: 3px solid #00ffcc; /* Neon green inner border */
    box-shadow: inset 0 0 10px #00ffcc, 0 0 20px #00ffcc;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* Hide overflow for ball */
}

.current-result {
    font-size: 3.5em; /* Ukuran hasil lebih kecil */
    font-weight: bold;
    color: #ff00ff; /* Neon pink */
    text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 30px #ff00ff;
    position: absolute;
    z-index: 5;
    background-color: rgba(0, 0, 0, 0.5); /* Slightly transparent background for readability */
    border-radius: 10px;
    padding: 5px 15px;
}

.ball {
    width: 15px;
    height: 15px;
    background-color: #ffffff; /* White ball */
    border-radius: 50%;
    box-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition: transform 3s ease-out; /* Smooth transition for ball movement */
    z-index: 10;
}

.betting-area {
    margin-top: 20px;
}

h2 {
    color: #ff6600; /* Neon orange */
    text-shadow: 0 0 8px #ff6600;
    margin-bottom: 15px;
    font-size: 1.6em; /* Ukuran H2 lebih kecil */
}

.bet-input {
    margin-bottom: 15px;
}

.bet-input label {
    font-size: 1em;
    color: #aaffff; /* Light cyan */
    text-shadow: 0 0 3px #aaffff;
    margin-right: 10px;
}

.bet-input input[type="number"] {
    background-color: #0d0d1a;
    border: 2px solid #00ffff; /* Cyan neon */
    color: #00ffcc;
    padding: 6px 10px; /* Padding lebih kecil */
    border-radius: 5px;
    font-size: 0.9em;
    width: 90px; /* Lebar input lebih kecil */
    text-align: center;
    box-shadow: 0 0 5px #00ffff;
    outline: none;
}

.bet-options {
    display: flex;
    flex-direction:;
    gap: 30px;
    margin-bottom: 0px;
}

/* --- GRID UNTUK SIMPLE CHANCES --- */
.bet-group.simple-chances {
    display: grid;
    gap: 10px;
}

.bet-chip {
    padding: 10px 15px; /* Padding sedikit lebih kecil */
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    border: 2px solid;
    font-size: 0.85em; /* Ukuran font sedikit lebih kecil */
    user-select: none;
    text-align: center;
    min-width: 80px; /* Minimal lebar chip */
    box-sizing: border-box; /* Pastikan padding masuk hitungan lebar */
}

/* Neon colors for bet chips */
.bet-chip.red {
    background-color: #8b0000;
    border-color: #ff0000;
    color: white;
    box-shadow: 0 0 8px #ff0000;
}
.bet-chip.black {
    background-color: #000000;
    border-color: #444444;
    color: white;
    box-shadow: 0 0 8px #444444;
}
.bet-chip.green {
    background-color: #006400;
    border-color: #00ff00;
    color: white;
    box-shadow: 0 0 8px #00ff00;
}
.bet-chip.even, .bet-chip.odd, .bet-chip.low, .bet-chip.high {
    background-color: #330066;
    border-color: #cc00ff;
    color: white;
    box-shadow: 0 0 8px #cc00ff;
}

.bet-chip:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 15px var(--bet-chip-shadow-hover);
}

.bet-chip.red:hover { --bet-chip-shadow-hover: #ff0000; }
.bet-chip.black:hover { --bet-chip-shadow-hover: #444444; }
.bet-chip.green:hover { --bet-chip-shadow-hover: #00ff00; }
.bet-chip.even:hover, .bet-chip.odd:hover, .bet-chip.low:hover, .bet-chip.high:hover { --bet-chip-shadow-hover: #cc00ff; }

/* Active bet chip */
.bet-chip.active {
    border-color: #fff000; /* Yellow glow */
    box-shadow: 0 0 15px #fff000, 0 0 25px #fff000;
    transform: scale(1.05);
    background-color: #550055; /* Slightly different background when active */
}

/* --- GRID UNTUK ANGKA 1-36 --- */
.number-bet-grid {
    display: grid;
    /* 12 kolom untuk desktop, adaptif untuk mobile */
    grid-template-columns: repeat(auto-fit, minmax(28px, 1fr)); /* Auto-fit agar adaptif */
    gap: 2px; 
    width: 100%;;
    margin: 0 auto;
    /* overflow-x: auto;  Tidak perlu jika grid benar-benar adaptif */
}

.number-bet-grid .bet-chip {
    padding: 6px 3px; /* Padding lebih kecil untuk angka */
    font-size: 0.7em; /* Lebih kecil untuk angka */
    min-width: 28px;
    height: 30px; /* Tinggi tetap agar seragam */
    display: flex;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
    white-space: nowrap; /* Mencegah angka pecah baris */
}

button#spin-button {
    background-color: #00ffff; /* Cyan neon */
    color: #0d0d1a; /* Dark text */
    border: none;
    padding: 12px 25px; /* Padding sedikit lebih kecil */
    font-size: 1.3em; /* Ukuran font lebih kecil */
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 0 15px #00ffff, 0 0 30px #00ffff;
    margin-top: 25px;
}

button#spin-button:hover {
    background-color: #00ccdd;
    box-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
    transform: translateY(-3px);
}

button#spin-button:disabled {
    background-color: #333;
    box-shadow: none;
    cursor: not-allowed;
    color: #888;
    transform: none;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    color: #00ffcc;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    font-size: 1.5em;
    z-index: 9999;
}

.spinner {
    border: 8px solid rgba(0, 255, 204, 0.3);
    border-top: 8px solid #00ffcc;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin-top: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


/* --- RESPONSIVENESS ADJUSTMENTS --- */
@media (max-width: 768px) {
    .game-container {
        padding: 15px;
    }
    h1 {
        font-size: 1.5em;
    }
    .header-info {
        font-size: 0.9em;
    }
    .roulette-wheel-area {
        width: 160px; /* Lebih kecil di tablet/mobile */
        height: 160px;
    }
    .current-result {
        font-size: 2.5em;
    }
    h2 {
        font-size: 1.3em;
    }
    .bet-input label {
        font-size: 0.9em;
    }
    .bet-input input[type="number"] {
        width: 80px;
        font-size: 0.85em;
    }

    /* Simple chances grid for smaller screens */
    .bet-group.simple-chances {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* 2 kolom di ponsel medium */
        gap: 0px;
    }
    .bet-chip {
        padding: 8px 12px;
        font-size: 0.8em;
    }

    /* Number grid for smaller screens */
    .number-bet-grid {
        grid-template-columns: repeat(auto-fit, minmax(26px, 1fr)); /* Lebih ringkas pada layar kecil */
        gap: 2px;
    }
    .number-bet-grid .bet-chip {
        min-width: 26px;
        height: 28px;
        font-size: 0.65em;
    }
    button#spin-button {
        font-size: 1.1em;
        padding: 10px 20px;
    }
}

@media (max-width: 480px) {
    .game-container {
        padding: 10px;
    }
    h1 {
        font-size: 1.3em;
    }
    .header-info {
        font-size: 0.8em;
        flex-direction: column; /* Stack info vertically */
        gap: 5px;
    }
    .dashboard-link, #logout-button {
        font-size: 0.7em;
        padding: 6px 10px;
    }
    .roulette-wheel-area {
        width: 140px;
        height: 140px;
    }
    .current-result {
        font-size: 2em;
    }
    h2 {
        font-size: 1.1em;
    }

    /* Simple chances grid for very small phones */
    .bet-group.simple-chances {
        grid-template-columns: 1fr; /* Satu kolom agar lebih mudah disentuh */
        gap: 5px;
    }
    .bet-chip {
        width: 95%; /* Penuhi lebar */
        margin: 0 auto; /* Tengah */
        padding: 10px 15px; /* Kembali ke padding awal agar mudah disentuh */
        font-size: 0.8em;
    }

    /* Number grid for very small phones */
    .number-bet-grid {
        grid-template-columns: repeat(auto-fit, minmax(24px, 1fr)); /* Paling ringkas */
        gap: 2px;
    }
    .number-bet-grid .bet-chip {
        min-width: 24px;
        height: 26px;
        font-size: 1em;
        padding: 4px 2px;
    }
    button#spin-button {
        font-size: 1em;
        padding: 8px 10px;
    }
}

/* Ensure all elements within game-container respect its padding */
.game-container > * {
    margin-left: auto;
    margin-right: auto; /* Ensure no child element causes overflow */
}

    </style>
</head>
<body>

    <div class="game-container" id="game-section">
        <h1>ROULETTE</h1>

        <div class="header-info">
            <p>Saldo Anda: <span id="player-balance">Rp.0</span></p>
            <button id="logout-button">out</button>
        </div>

        <div class="roulette-wheel-area">
            <div class="wheel-outer">
                <div class="wheel-inner" id="roulette-wheel">
                    <span class="ball" id="roulette-ball"></span>
                    <div class="current-result" id="current-result-display">?</div>
                </div>
            </div>
        </div>

        <div class="betting-area">
            <h2>Pasang Taruhan Anda</h2>

            <div class="bet-input">
                <label for="bet-amount">Jumlah Taruhan:</label>
                <input type="number" id="bet-amount" value="500" min="500" step="1">
            </div>

            <div class="bet-options">
                <div class="bet-group simple-chances">
                    <div class="bet-chip red" data-bet-type="color" data-bet-value="red">MERAH</div>
                    <div class="bet-chip black" data-bet-type="color" data-bet-value="black">HITAM</div>
                    <div class="bet-chip even" data-bet-type="parity" data-bet-value="even">GENAP</div>
                    <div class="bet-chip odd" data-bet-type="parity" data-bet-value="odd">GANJIL</div>
                    <div class="bet-chip low" data-bet-type="range" data-bet-value="low">1-18</div>
                    <div class="bet-chip high" data-bet-type="range" data-bet-value="high">19-36</div>
                </div>

                <h3>Pilih Angka ➡️</h3>
                <div class="number-bet-grid" id="number-bet-grid">
                    </div>
            </div>

            <button id="spin-button">PUTAR RODA!</button>
        </div>
    </div>

    <audio id="bg-music" src="assets/music/bg_music.mp3" loop></audio> <audio id="spin-sound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-arcade-rising-231.mp3"></audio>
    <audio id="win-sound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-game-level-completed-2059.mp3"></audio>
    <audio id="lose-sound" src="https://vqmfachxnjyxwuavpgds.supabase.co/storage/v1/object/public/music//mixkit-player-losing-or-failing-2042.mp3"></audio>


    <script>document.addEventListener('DOMContentLoaded', async () => {
    const supabase = window.supabase.createClient(
        'https://vqmfachxnjyxwuavpgds.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxbWZhY2h4bmp5eHd1YXZwZ2RzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MDYxNDAsImV4cCI6MjA2Mzk4MjE0MH0.Bzr8mUiEl8MzRWpVQ3_59eFxKk0EWZ3ca-4IEcpGLkk'
    );

    let currentUser = null;
    let playerBalance = 0;
    const gameSection = document.getElementById('game-section');
    const logoutButton = document.getElementById('logout-button');
    const playerBalanceElement = document.getElementById('player-balance');
    const gameStatusElement = document.getElementById('game-status'); // PASTIKAN ELEMEN INI ADA DI HTML!
    const betAmountInput = document.getElementById('bet-amount');
    const spinButton = document.getElementById('spin-button');
    const currentResultDisplay = document.getElementById('current-result-display');
    const rouletteBall = document.getElementById('roulette-ball');
    const rouletteWheel = document.getElementById('roulette-wheel');
    const numberBetGrid = document.getElementById('number-bet-grid');

    const bgMusic = document.getElementById('bg-music');
    const spinSound = document.getElementById('spin-sound');
    const winSound = document.getElementById('win-sound');
    const loseSound = document.getElementById('lose-sound');

    let currentBet = { type: null, value: null, amount: 0 };
    let isSpinning = false;

    const rouletteNumbers = [
        { number: 32, color: 'red' }, { number: 15, color: 'black' }, { number: 19, color: 'red' }, { number: 4, color: 'black' },
        { number: 21, color: 'red' }, { number: 2, color: 'black' }, { number: 25, color: 'red' }, { number: 17, 'color': 'black' },
        { number: 34, color: 'red' }, { number: 6, color: 'black' }, { number: 27, color: 'red' }, { number: 13, color: 'black' },
        { number: 36, color: 'red' }, { number: 11, color: 'black' }, { number: 30, color: 'red' }, { number: 8, 'color': 'black' },
        { number: 23, color: 'red' }, { number: 10, color: 'black' }, { number: 5, color: 'red' }, { number: 24, 'color': 'black' },
        { number: 16, color: 'red' }, { number: 33, color: 'black' }, { number: 1, color: 'red' }, { number: 20, 'color': 'black' },
        { number: 14, color: 'red' }, { number: 31, color: 'black' }, { number: 9, color: 'red' }, { number: 22, 'color': 'black' },
        { number: 18, color: 'red' }, { number: 29, color: 'black' }, { number: 7, color: 'red' }, { number: 28, 'color': 'black' },
        { number: 12, color: 'red' }, { number: 35, color: 'black' }, { number: 3, color: 'red' }, { number: 26, 'color': 'black' }
    ];

    const numberColorsMap = {
        1: 'red', 2: 'black', 3: 'red', 4: 'black', 5: 'red', 6: 'black',
        7: 'red', 8: 'black', 9: 'red', 10: 'black', 11: 'black', 12: 'red', 13: 'black',
        14: 'red', 15: 'black', 16: 'red', 17: 'black', 18: 'red', 19: 'red', 20: 'black',
        21: 'red', 22: 'black', 23: 'red', 24: 'black', 25: 'red', 26: 'black', 27: 'red',
        28: 'black', 29: 'black', 30: 'red', 31: 'black', 32: 'red', 33: 'black',
        34: 'red', 35: 'black', 36: 'red'
    };

    // --- Functions ---
    function populateNumberGrid() {
        console.log('Populating number grid...');
        numberBetGrid.innerHTML = '';
        for (let i = 1; i <= 36; i++) {
            const div = document.createElement('div');
            div.className = `bet-chip ${numberColorsMap[i]}`;
            div.dataset.betType = "number";
            div.dataset.betValue = i;
            div.textContent = i;
            numberBetGrid.appendChild(div);
        }
        setupBetChipListeners();
    }

    function setupBetChipListeners() {
        document.querySelectorAll('.bet-group .bet-chip, #number-bet-grid .bet-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                if (isSpinning) {
                    updateStatus('Tunggu putaran selesai!');
                    return;
                }
                document.querySelectorAll('.bet-group .bet-chip, #number-bet-grid .bet-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentBet.type = chip.dataset.betType;
                currentBet.value = chip.dataset.betValue;
                updateStatus(`Anda memilih taruhan pada ${chip.textContent}.`);
                console.log(`Current bet set: Type - ${currentBet.type}, Value - ${currentBet.value}`);
            });
        });
    }

    async function handleLogout() {
        console.log('Attempting to log out...');
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error('Logout error:', error.message);
            updateStatus('Gagal logout. Coba lagi.');
        } else {
            console.log('Logout successful.');
            currentUser = null;
            playerBalance = 0;
            updateBalanceDisplay();
            updateStatus('Anda telah logout. Silakan login kembali untuk bermain.');
            spinButton.disabled = true;
            window.location.href = 'index.html';
        }
    }

    // Fungsi KUNCI untuk memuat saldo
    async function loadUserData(userId) {
        updateStatus('Mencoba memuat data pengguna...');
        console.log(`Loading user data for user ID: ${userId}`);

        const { data, error } = await supabase
            .from('users_data')
            .select('saldo, username')
            .eq('user_id', userId)
            .single();

        if (error) {
            if (error.code === 'PGRST116') { // PGRST116 = no rows found (User data does not exist yet)
                console.warn('User data not found. Initializing new account.');
                updateStatus('Data pengguna tidak ditemukan. Menginisialisasi akun baru...');
                const initialBalance = 1000;
                const defaultUsername = currentUser.email ? currentUser.email.split('@')[0] : 'Pemain Baru';
                const { data: newUserData, error: insertError } = await supabase
                    .from('users_data')
                    .insert({ user_id: userId, saldo: initialBalance, username: defaultUsername })
                    .select()
                    .single();

                if (insertError) {
                    console.error('Error initializing new user data:', insertError.message);
                    updateStatus('Error inisialisasi akun: ' + insertError.message);
                    spinButton.disabled = true;
                    return;
                }
                playerBalance = newUserData.saldo;
                console.log(`New account initialized with saldo: ${playerBalance}`);
                updateStatus(`Selamat datang, ${newUserData.username}! Anda menerima Rp.${initialBalance.toFixed(0)}!`);
                spinButton.disabled = false;
            } else {
                console.error('Error loading user data:', error.message);
                updateStatus('Error memuat data pengguna: ' + error.message);
                spinButton.disabled = true;
                return;
            }
        } else {
            // Data pengguna ditemukan
            playerBalance = data.saldo;
            console.log(`User data loaded. Saldo: ${playerBalance}, Username: ${data.username}`);
            updateStatus('Data pemain berhasil dimuat.');
            spinButton.disabled = false;
        }
        updateBalanceDisplay(); // Pastikan tampilan saldo diperbarui
    }

    // Fungsi KUNCI untuk memperbarui saldo di database
    async function updatePlayerBalanceInDB(newBalance) {
        if (!currentUser) {
            console.error('Error: No current user to update data for.');
            updateStatus('Error: Tidak login untuk menyimpan saldo.');
            return;
        }

        console.log(`Attempting to update balance in DB for user ${currentUser.id} to ${newBalance}`);
        const { error } = await supabase
            .from('users_data')
            .update({ saldo: newBalance })
            .eq('user_id', currentUser.id);

        if (error) {
            console.error('Error updating user saldo:', error.message);
            updateStatus('Error menyimpan saldo. Silakan refresh.');
        } else {
            console.log('Saldo updated successfully in DB!');
            playerBalance = newBalance; // Perbarui variabel lokal setelah berhasil update DB
            updateBalanceDisplay();
        }
    }

    function updateBalanceDisplay() {
        if (playerBalanceElement) { // Safety check
            playerBalanceElement.textContent = `Rp.${playerBalance.toFixed(0)}`;
            console.log(`Display balance updated to: Rp.${playerBalance.toFixed(0)}`);
        } else {
            console.error('playerBalanceElement not found!');
        }
    }

    function updateStatus(message) {
        if (gameStatusElement) { // Safety check
            gameStatusElement.textContent = message;
            console.log(`Status updated: ${message}`);
        } else {
            console.error('gameStatusElement not found! Cannot update status.');
        }
    }

    function resetBet() {
        currentBet = { type: null, value: null, amount: 0 };
        document.querySelectorAll('.bet-group .bet-chip, #number-bet-grid .bet-chip').forEach(c => c.classList.remove('active'));
    }

    function playBgMusic() {
        if (bgMusic) {
            bgMusic.volume = 0.3;
            bgMusic.play().catch(e => console.warn("Failed to play background music:", e));
        }
    }

    function playSpinSound() {
        if (spinSound) {
            spinSound.currentTime = 0;
            spinSound.play().catch(e => console.warn("Failed to play spin sound:", e));
        }
    }

    function stopSpinSound() {
        if (spinSound) {
            spinSound.pause();
            spinSound.currentTime = 0;
        }
    }

    function playWinSound() {
        if (winSound) {
            winSound.currentTime = 0;
            winSound.play().catch(e => console.warn("Failed to play win sound:", e));
        }
    }

    function playLoseSound() {
        if (loseSound) {
            loseSound.currentTime = 0;
            loseSound.play().catch(e => console.warn("Failed to play lose sound:", e));
        }
    }

    async function spinRoulette() {
        if (isSpinning) return;
        if (!currentUser) {
            updateStatus('Silakan login untuk bermain!');
            console.warn('Spin prevented: User not logged in.');
            return;
        }

        currentBet.amount = parseFloat(betAmountInput.value);

        if (currentBet.type === null || currentBet.value === null) {
            updateStatus('Pilih jenis taruhan Anda terlebih dahulu!');
            console.warn('Spin prevented: No bet selected.');
            return;
        }

        if (isNaN(currentBet.amount) || currentBet.amount <= 0) {
            updateStatus('Jumlah taruhan tidak valid!');
            console.warn('Spin prevented: Invalid bet amount.');
            return;
        }
        
        if (currentBet.amount % 500 !== 0) {
            updateStatus('Jumlah taruhan harus kelipatan 500!');
            console.warn('Spin prevented: Bet amount not a multiple of 500.');
            return;
        }

        if (currentBet.amount > playerBalance) {
            updateStatus('Saldo tidak cukup untuk taruhan ini!');
            console.warn('Spin prevented: Insufficient balance.');
            return;
        }

        // Kurangi saldo sebelum spin dan update DB
        playerBalance -= currentBet.amount;
        updateBalanceDisplay();
        await updatePlayerBalanceInDB(playerBalance); // Pastikan ini berhasil sebelum spin visual

        updateStatus(`Roda berputar dengan taruhan Rp.${currentBet.amount} pada ${currentBet.value}.`);
        isSpinning = true;
        spinButton.disabled = true;
        console.log(`Spin initiated with bet: ${currentBet.amount} on ${currentBet.value}`);

        playSpinSound();

        const totalSpinDegrees = (Math.floor(Math.random() * 6) + 5) * 360 + Math.random() * 360;
        rouletteWheel.style.transition = 'transform 4s ease-out';
        rouletteWheel.style.transform = `rotate(${totalSpinDegrees}deg)`;
        rouletteBall.style.transition = 'transform 3.5s ease-out';
        const ballTargetOffset = Math.random() * 100 - 50;
        rouletteBall.style.transform = `translate(${ballTargetOffset}px, ${ballTargetOffset}px) scale(0.8)`;

        setTimeout(async () => {
            stopSpinSound();

            const winningNumberObj = rouletteNumbers[Math.floor(Math.random() * rouletteNumbers.length)];
            const winningNumber = winningNumberObj.number;
            const winningColor = winningNumberObj.color;
            console.log(`Spin ended. Winning number: ${winningNumber} (${winningColor})`);

            currentResultDisplay.textContent = winningNumber;
            currentResultDisplay.style.color = winningColor;
            currentResultDisplay.style.textShadow = `0 0 10px ${winningColor}, 0 0 20px ${winningColor}`;

            await checkWin(winningNumber, winningColor, currentBet.amount);

            isSpinning = false;
            spinButton.disabled = false;
            resetBet();

            // Reset visual roda dan bola
            rouletteWheel.style.transition = 'none';
            rouletteWheel.style.transform = 'rotate(0deg)';
            rouletteBall.style.transition = 'none';
            rouletteBall.style.transform = 'translate(-50%, -50%)';
            console.log('Roulette visual reset.');
        }, 4000);
    }

    async function checkWin(winningNumber, winningColor, amountBet) {
        let win = false;
        let payoutMultiplier = 0;
        let message = "";

        console.log(`Checking win for bet type: ${currentBet.type}, value: ${currentBet.value} against winning number: ${winningNumber}, color: ${winningColor}`);

        switch (currentBet.type) {
            case 'color':
                if (currentBet.value === winningColor) {
                    win = true;
                    payoutMultiplier = 2;
                }
                break;
            case 'parity':
                if (currentBet.value === 'even' && winningNumber % 2 === 0) {
                    win = true;
                    payoutMultiplier = 2;
                } else if (currentBet.value === 'odd' && winningNumber % 2 !== 0) {
                    win = true;
                    payoutMultiplier = 2;
                }
                break;
            case 'range':
                if (currentBet.value === 'low' && winningNumber >= 1 && winningNumber <= 18) {
                    win = true;
                    payoutMultiplier = 2;
                } else if (currentBet.value === 'high' && winningNumber >= 19 && winningNumber <= 36) {
                    win = true;
                    payoutMultiplier = 2;
                }
                break;
            case 'number':
                if (parseInt(currentBet.value) === winningNumber) {
                    win = true;
                    payoutMultiplier = 36;
                }
                break;
        }

        let winnings = 0;
        if (win) {
            winnings = amountBet * payoutMultiplier;
            message = `SELAMAT! Angka ${winningNumber} (${winningColor.toUpperCase()})! Anda memenangkan Rp.${winnings.toFixed(0)}!`;
            playerBalance += winnings; // Perbarui saldo lokal
            console.log(`Win! Winnings: ${winnings}, New balance: ${playerBalance}`);
            playWinSound();
        } else {
            message = `Angka ${winningNumber} (${winningColor.toUpperCase()}). Anda kalah Rp.${amountBet.toFixed(0)}.`;
            console.log(`Lose. Lost: ${amountBet}, New balance: ${playerBalance}`);
            playLoseSound();
        }

        updateStatus(message);
        await updatePlayerBalanceInDB(playerBalance); // Simpan saldo terbaru ke database
    }

    async function initializeGame() {
        updateStatus('Memuat sesi pengguna...');
        console.log('Initializing game...');

        const { data: { user } } = await supabase.auth.getUser();
        console.log('Supabase user:', user);

        if (user) {
            currentUser = user;
            updateStatus('Pengguna ditemukan. Memuat data pemain...');
            console.log(`User ${user.id} found. Loading user data...`);
            await loadUserData(user.id); // Panggil loadUserData
            updateStatus('Selamat datang! Pilih taruhan Anda.');
            playBgMusic();
            spinButton.disabled = false;
        } else {
            console.warn('No user found, redirecting to index.html');
            window.location.href = 'index.html'; // Redirect jika tidak ada user
        }
    }

    logoutButton.addEventListener('click', handleLogout);
    spinButton.addEventListener('click', spinRoulette);

    populateNumberGrid(); // Panggil ini untuk mengisi grid angka
    
    await initializeGame(); // Panggil initializeGame saat DOM siap
});
</script>
</body>
</html>
